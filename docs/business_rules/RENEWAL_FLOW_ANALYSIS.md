# 续费业务流程分析报告 (Renewal Flow Analysis)

## 核心机制
基于 **"资源复用 + 时间叠加"** 的无缝续费模型。

### 1. 核心逻辑
续费不是简单的"再次购买"，而是**延长现有资源的使用权**。
- **不换卡/不换车**：直接复用原订单的 `locked_cdk_ids` (CDK) 或 `slot_occupancy_ids` (车位)。
- **时间顺延**：新订单的结束时间 = 旧订单结束时间 + 新购时长。

### 2. 用户操作流程
- **触发**：订单详情页 (`OrderActions.vue`) → 点击“续费”。
- **SKU 选择** (`get_renewal_skus` RPC)：
  - 系统自动查找当前 CDK 关联的所有 SKU（例如：月卡可续费成季卡）。
- **创建订单** (`create_renewal_pre_order` RPC)：
  - 生成一个 `source='renew'` 的预订单。
  - 标记 `related_order_id` 指向旧订单。
- **支付确认** (`confirm_pre_order` RPC)：
  - **关键动作**：支付成功那是一瞬间，旧订单变为 `expired` (已过期/被接续)，新订单变为 `active` (生效)。
  - 车位归属权 (`slot_occupancies`) 自动转移到新订单名下。

## 关键代码映射

| 功能节点 | 文件/函数 | 逻辑说明 |
|---------|----------|---------|
| **获取可续费项** | `get_renewal_skus` | 通过 `cdk_sku_map` 找兼容商品 |
| **创建续费单** | `create_renewal_pre_order` | 复用旧单资源，不扣库存 |
| **支付生效** | `confirm_pre_order` | **Resource Handover**: 旧单过/新单续 |
| **前端弹窗** | `RenewalModal.vue` | 独立的续费专用购买界面 |

## 优化建议

1.  **续费折扣 (Retention)**：
    *   *现状*：按原价续费。
    *   *建议*：在 `get_renewal_skus` 中计算“续费专享价” (例如 9 折)，提高用户留存率。

2.  **临期提醒**：
    *   *建议*：增加定时任务 (Cron)，在订单到期前 3 天自动发送邮件提醒续费 (带上续费链接)。

3.  **断档续费支持**：
    *   *现状*：仅 `active` 订单可续费。过期了就得重新买（可能换号）。
    *   *建议*：允许 `expired` 后 7 天内续费（如果资源未被回收/被别人买走），降低用户重新配置设备的成本。
