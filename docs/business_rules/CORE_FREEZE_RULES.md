# æ ¸å¿ƒé€»è¾‘å°è£…è§„èŒƒä¸æ‰©å±•æŒ‡å—

> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-16  
> **ç›®çš„**: ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ç¨³å®šå"å°è£…"ä¸åŠ¨ï¼Œåç»­åªåšæ‰©å±•ä¸ç ´åæ¡†æ¶

---

## ä¸€ã€å°è£…çŠ¶æ€æ€»è§ˆ

### åå°ç®¡ç†ç³»ç»Ÿ (å·²å°è£… ğŸ”’)

| æ¨¡å— | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒ API | çŠ¶æ€ |
|------|----------|----------|------|
| **è®¢å•ç®¡ç†** | `pages/_mgmt_9Xfa3/orders/` | `adminOrderApi` | ğŸ”’ å°è£…å®Œæˆ |
| **å•†å“ç®¡ç†** | `pages/_mgmt_9Xfa3/products/` | `adminProductApi` | ğŸ”’ å°è£…å®Œæˆ |
| **CDKç®¡ç†** | `pages/_mgmt_9Xfa3/cdk/` | `adminCdkApi` | ğŸ”’ å°è£…å®Œæˆ |
| **ä¼˜æƒ åˆ¸ç®¡ç†** | `pages/_mgmt_9Xfa3/coupons/` | `adminCouponApi` | ğŸ”’ å°è£…å®Œæˆ |

### å®¢æˆ·ç«¯ç³»ç»Ÿ (å·²å°è£… ğŸ”’)

| æ¨¡å— | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒ API | çŠ¶æ€ |
|------|----------|----------|------|
| **å•†å“å±•ç¤º** | `pages/[id].vue`, `pages/index.vue` | `supabaseProductApi` | ğŸ”’ å°è£…å®Œæˆ |
| **ä¸‹å•æµç¨‹** | `pages/checkout/[id].vue` | `supabasePreOrderApi` | ğŸ”’ å°è£…å®Œæˆ |
| **ä¼˜æƒ åˆ¸ä½¿ç”¨** | `pages/checkout/[id].vue` | `couponApi` | ğŸ”’ å°è£…å®Œæˆ |
| **ç”¨æˆ·è®¤è¯** | `components/LoginRegisterModal.vue` | `supabaseAuthApi` | ğŸ”’ å°è£…å®Œæˆ |

### æ•°æ®åº“æ ¸å¿ƒå‡½æ•° (ç¦æ­¢ä¿®æ”¹ â›”)

| å‡½æ•°å | åŠŸèƒ½ | å°è£…çŠ¶æ€ |
|--------|------|----------|
| `create_pre_order` | åˆ›å»ºé¢„è®¢å•ï¼Œé”å®šèµ„æº | â›” å†»ç»“ |
| `confirm_pre_order` | ç¡®è®¤æ”¯ä»˜ï¼Œåˆ›å»ºæ­£å¼è®¢å• | â›” å†»ç»“ |
| `release_preorder_resources` | é‡Šæ”¾é”å®šçš„èµ„æº | â›” å†»ç»“ |
| `apply_coupon_to_pre_order` | åº”ç”¨ä¼˜æƒ åˆ¸ | â›” å†»ç»“ |
| `calculate_coupon_discount` | è®¡ç®—ä¼˜æƒ æŠ˜æ‰£ | â›” å†»ç»“ |
| `handle_new_user` | æ–°ç”¨æˆ·æ³¨å†Œè§¦å‘å™¨ | â›” å†»ç»“ |

---

## äºŒã€æ‰©å±•å¼€å‘è§„èŒƒ

### âœ… æ­£ç¡®çš„æ‰©å±•æ–¹å¼

#### 1. æ–°å¢ç‹¬ç«‹åŠŸèƒ½æ¨¡å—
```
é€‚ç”¨åœºæ™¯ï¼šæ·»åŠ æ–°çš„ä¸€çº§èœå•ï¼ˆå¦‚ï¼šæ´»åŠ¨ç®¡ç†ã€ç§¯åˆ†ç³»ç»Ÿï¼‰

æ­£ç¡®åšæ³•ï¼š
â”œâ”€â”€ pages/_mgmt_9Xfa3/
â”‚   â””â”€â”€ events/              â† æ–°å»ºç‹¬ç«‹ç›®å½•
â”‚       â”œâ”€â”€ index.vue        â† æ–°é¡µé¢
â”‚       â””â”€â”€ [id].vue
â”œâ”€â”€ api/
â”‚   â””â”€â”€ admin-events.ts      â† æ–°å»ºç‹¬ç«‹ API æ–‡ä»¶
â””â”€â”€ ä¸ä¿®æ”¹ä»»ä½•ç°æœ‰æ–‡ä»¶
```

#### 2. æ‰©å±•ç°æœ‰æ¨¡å—çš„å±•ç¤ºå­—æ®µ
```
é€‚ç”¨åœºæ™¯ï¼šè®¢å•åˆ—è¡¨å¢åŠ ä¸€åˆ—æ˜¾ç¤º

æ­£ç¡®åšæ³•ï¼š
- ä»…ä¿®æ”¹ Vue æ¨¡æ¿ (<template>) éƒ¨åˆ†
- ä¸ä¿®æ”¹ API è°ƒç”¨é€»è¾‘
- ä¸ä¿®æ”¹æ•°æ®åº“å‡½æ•°
```

#### 3. æ·»åŠ æ–°çš„å•†å“ç±»å‹
```
é€‚ç”¨åœºæ™¯ï¼šæœªæ¥æ”¯æŒæ–°çš„å•†å“å½¢æ€

æ­£ç¡®åšæ³•ï¼š
1. åœ¨ docs/CORE_LOGIC.md ä¸­æ·»åŠ ç±»å‹å®šä¹‰
2. åœ¨ product_skus è¡¨æ·»åŠ æ–°çš„ product_type æšä¸¾å€¼
3. åœ¨ create_pre_order å‡½æ•°ä¸­æ·»åŠ æ–°çš„èµ„æºé”å®šåˆ†æ”¯
4. ä¸ä¿®æ”¹ç°æœ‰ä¸‰ç§ç±»å‹çš„ä»»ä½•é€»è¾‘
```

### âŒ ç¦æ­¢çš„æ“ä½œ

| æ“ä½œ | é£é™© | æ›¿ä»£æ–¹æ¡ˆ |
|------|------|----------|
| ä¿®æ”¹ `create_pre_order` æ ¸å¿ƒæµç¨‹ | å½±å“æ‰€æœ‰ä¸‹å• | æ–°å»ºç‹¬ç«‹å‡½æ•° |
| åœ¨ `supabase.ts` ä¸­æ·»åŠ ç®¡ç†åŠŸèƒ½ | è¿åå®¢æˆ·ç«¯éš”ç¦» | æ·»åŠ åˆ° `admin-supabase.ts` |
| ç›´æ¥æ“ä½œ `orders` è¡¨ | ç»•è¿‡ä¸šåŠ¡é€»è¾‘ | ä½¿ç”¨æ•°æ®åº“å‡½æ•° |
| ä¿®æ”¹ RLS ç­–ç•¥ä¸º `USING(true)` | å®‰å…¨æ¼æ´ | ä½¿ç”¨æ˜¾å¼æƒé™éªŒè¯ |

---

## ä¸‰ã€æ ¸å¿ƒæ–‡ä»¶å†»ç»“æ¸…å•

### æ•°æ®åº“è¿ç§»æ–‡ä»¶
```
supabase/migrations/
â”œâ”€â”€ 20260113201000_consolidated_schema.sql  â† â›” å†»ç»“
â””â”€â”€ 20260114201200_order_optimizations.sql   â† â›” å†»ç»“
```

### API å±‚æ ¸å¿ƒæ–‡ä»¶
```
nuxt-frontend/api/
â”œâ”€â”€ supabase.ts          â† ğŸ”’ æ ¸å¿ƒåŠŸèƒ½å†»ç»“ï¼Œå¯æ·»åŠ æ–°å‡½æ•°
â”œâ”€â”€ coupon.ts            â† ğŸ”’ æ ¸å¿ƒåŠŸèƒ½å†»ç»“
â””â”€â”€ admin-supabase.ts    â† ğŸ”’ æ ¸å¿ƒåŠŸèƒ½å†»ç»“ï¼Œå¯æ·»åŠ æ–° API
```

### å·¥å…·å±‚
```
nuxt-frontend/utils/
â”œâ”€â”€ supabase.ts          â† â›” å†»ç»“
â””â”€â”€ supabase-admin.ts    â† â›” å†»ç»“
```

---

## å››ã€å®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•

æ–°åŠŸèƒ½ä¸Šçº¿å‰å¿…é¡»æ£€æŸ¥ï¼š

- [ ] æœªä¿®æ”¹ä»»ä½• `â›” å†»ç»“` æ–‡ä»¶
- [ ] åå°åŠŸèƒ½ä½¿ç”¨ `getAdminSupabaseClient`
- [ ] å®¢æˆ·ç«¯åŠŸèƒ½ä½¿ç”¨ `getSupabaseClient`
- [ ] æ–°è¡¨å·²é…ç½®åˆé€‚çš„ RLS ç­–ç•¥
- [ ] æ•æ„Ÿæ“ä½œé€šè¿‡æ•°æ®åº“å‡½æ•°æ‰§è¡Œ
- [ ] è¿è¡Œ `grep` å‘½ä»¤éªŒè¯æ— æ··ç”¨

### éªŒè¯å‘½ä»¤
```bash
# æ£€æŸ¥åå°æ˜¯å¦è¯¯ç”¨å®¢æˆ·ç«¯
grep -r "from '@/utils/supabase'" pages/_mgmt_9Xfa3/

# æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦è¯¯ç”¨åå°
grep -r "supabase-admin" pages/ --include="*.vue" | grep -v "_mgmt_9Xfa3"
```

---

## äº”ã€æ‰©å±•åŠŸèƒ½å¼€å‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. éœ€æ±‚è¯„å®¡                                                 â”‚
â”‚     - ç¡®è®¤ä¸æ¶‰åŠæ ¸å¿ƒæµç¨‹ä¿®æ”¹                                  â”‚
â”‚     - ç¡®è®¤å¯ä»¥ä½œä¸ºç‹¬ç«‹æ¨¡å—å¼€å‘                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è®¾è®¡æ–‡æ¡£                                                 â”‚
â”‚     - æ–°å¢è¡¨ç»“æ„è®¾è®¡                                         â”‚
â”‚     - RLS ç­–ç•¥è®¾è®¡                                           â”‚
â”‚     - API æ¥å£è®¾è®¡                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¼€å‘å®ç°                                                 â”‚
â”‚     - æ–°å»ºç‹¬ç«‹æ–‡ä»¶                                           â”‚
â”‚     - ä¸ä¿®æ”¹å†»ç»“æ–‡ä»¶                                         â”‚
â”‚     - éµå¾ªå®¢æˆ·ç«¯/åå°åˆ†ç¦»                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å®‰å…¨æ£€æŸ¥                                                 â”‚
â”‚     - è¿è¡ŒéªŒè¯å‘½ä»¤                                           â”‚
â”‚     - ç¡®è®¤ RLS ç­–ç•¥æ­£ç¡®                                      â”‚
â”‚     - æµ‹è¯•æƒé™éš”ç¦»                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€ç‰ˆæœ¬å‘å¸ƒè§„èŒƒ

| ç‰ˆæœ¬ç±»å‹ | å…è®¸ä¿®æ”¹èŒƒå›´ | ç¤ºä¾‹ |
|----------|-------------|------|
| **Patch** (x.x.1) | ä»… Bug ä¿®å¤ï¼Œä¸æ”¹é€»è¾‘ | ä¿®å¤æ˜¾ç¤ºé—®é¢˜ |
| **Minor** (x.1.0) | æ–°å¢ç‹¬ç«‹åŠŸèƒ½ | æ·»åŠ æ´»åŠ¨ç®¡ç† |
| **Major** (2.0.0) | æ ¸å¿ƒæ¶æ„è°ƒæ•´ | éœ€å®Œæ•´è¯„å®¡æµç¨‹ |

> **åŸåˆ™**: ç°æœ‰çš„è®¢å•/å•†å“/CDK/ä¼˜æƒ åˆ¸æ ¸å¿ƒé€»è¾‘ï¼Œåœ¨ Minor ç‰ˆæœ¬ä¸­**æ°¸ä¸ä¿®æ”¹**ã€‚

---

## ä¸ƒã€æ–‡æ¡£ç»´æŠ¤

æœ¬è§„èŒƒä¸ä»¥ä¸‹æ–‡æ¡£é…å¥—ä½¿ç”¨ï¼š
- `docs/CORE_LOGIC.md` - æ ¸å¿ƒæ¶æ„å®šä¹‰
- `docs/SUPABASE_CLIENT_RULES.md` - å®¢æˆ·ç«¯ä½¿ç”¨è§„èŒƒ

å¦‚éœ€ä¿®æ”¹æœ¬æ–‡æ¡£ï¼Œè¯·å…ˆåˆ›å»º Issue è®¨è®ºï¼Œç»ç¡®è®¤åæ–¹å¯æ›´æ–°ã€‚
