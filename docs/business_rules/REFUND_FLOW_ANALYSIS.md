# 退款业务流程分析报告 (Refund Flow Analysis)

## 核心机制
基于 **"状态快照 + 人工审核"** 的安全模型。系统不自动退款，必须由管理员审核。

### 1. 用户端流程
- **入口**：订单详情页 (`OrderActions.vue`) → 点击“申请退款”。
- **条件**：
  - 订单状态必须是 `active` (使用中) 或 `pending_delivery` (待发货)。
  - 是主订单（非预订单）。
  - 没有正在进行中的退款申请。
- **提交数据**：
  - 退款原因 (Reason)
  - 补充说明 (Detail)
- **提交后**：
  - 订单状态变为 `refunding` (退款中)。
  - 记录 `original_status` (原状态) 到 `refund_requests` 表，以便拒绝时恢复。

### 2. 管理端流程
- **列表**：管理员在后台看到 `refunding` 状态的订单。
- **审核动作** (`admin_review_refund` RPC)：
  - **✅ 同意退款**：
    1. 输入退款金额 (不能超过订单总额)。
    2. 订单状态变为 `refunded`。
    3. 金额自动加回用户余额 (`profiles.balance`)。
    4. 生成“退款”类型的流水记录 (`wallet_transactions`)。
  - **❌ 拒绝退款**：
    1. 输入拒绝理由。
    2. 订单状态**恢复为原状态** (`original_status`)，例如变回 `active`，用户可继续使用。

## 关键代码映射

| 功能节点 | 文件/函数 | 逻辑说明 |
|---------|----------|---------|
| **创建申请** | `create_refund_request` (RPC) | 校验权限，锁定订单，保存快照 |
| **管理员审核** | `admin_review_refund` (RPC) | 核心事务：退余额 + 改状态 |
| **前端入口** | `OrderActions.vue` | 根据 `order.status` 控制按钮显示 |
| **后台页面** | `pages/_mgmt.../refunds/index.vue` | 展示申请列表和操作弹窗 |

## 优化建议

1.  **退款金额预填充优化**：
    *   *现状*：管理员需要手动输入金额。
    *   *建议*：默认填入订单“剩余价值”计算值（例如：30天用了10天，建议退款 2/3），仅供参考，管理员可修改。

2.  **增加凭证图片**：
    *   *现状*：`images_snapshot` 字段已预留但前端未实现上传。
    *   *建议*：前端增加“上传截图”功能，方便用户证明账号无法使用。

3.  **自动退款阈值 (高级)**：
    *   *建议*：对于“待发货” (`pending_delivery`) 且金额小于 20 元的订单，可配置为自动同意退款，减少人工成本。
