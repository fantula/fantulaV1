# é€€æ¬¾æµç¨‹ (Refund Logic)

## 1. æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **ä¸æ‰¿è¯ºé‡‘é¢** | å®¢æˆ·ç«¯ä¸æ˜¾ç¤ºä»»ä½•é¢„ä¼°é€€æ¬¾é‡‘é¢ |
| **äººå·¥å®¡æ ¸** | åå°ç®¡ç†å‘˜å†³å®šé€€æ¬¾é‡‘é¢ |
| **æ‹’ç»æ¢å¤åŸçŠ¶** | æ‹’ç»åè®¢å•æ¢å¤ç”³è¯·å‰çŠ¶æ€ï¼Œå¯é‡æ–°ç”³è¯· |
| **ä½¿ç”¨ç°æœ‰çŠ¶æ€** | åªç”¨ `refunding` / `refunded`ï¼Œä¸æ–°å¢çŠ¶æ€ |

---

## 2. çŠ¶æ€æœº

```
paid/active/pending_delivery
       â”‚
       â”‚ ç”¨æˆ·ç”³è¯·é€€æ¬¾
       â–¼
   refunding (é€€æ¬¾ä¸­)
       â”‚
       â”œâ”€â”€ åŒæ„ â”€â”€â–¶ refunded (å·²é€€æ¬¾)
       â”‚
       â””â”€â”€ æ‹’ç» â”€â”€â–¶ æ¢å¤åŸçŠ¶æ€ (active/paid/...) â”€â”€â–¶ å¯é‡æ–°ç”³è¯·
```

**å…³é”®**ï¼š`refund_requests` è¡¨è®°å½•åŸçŠ¶æ€ï¼Œæ‹’ç»æ—¶æ¢å¤ã€‚

---

## 3. å®¢æˆ·ç«¯æµç¨‹

### 3.1 ç”³è¯·å…¥å£

**ä½ç½®**: è®¢å•è¯¦æƒ…é¡µ â†’ "ç”³è¯·é€€æ¬¾" æŒ‰é’®

**è§¦å‘æ¡ä»¶**:
- `order.status IN ('pending_delivery', 'active')`
- ä¸»è®¢å•ï¼ˆéé¢„è®¢å•ï¼‰

### 3.2 ç”³è¯·é¡µé¢

**UI å…ƒç´ **:
- é€€æ¬¾åŸå› ï¼ˆå¿…å¡«ï¼‰: ä¸‹æ‹‰é€‰æ‹©
- è¡¥å……è¯´æ˜ï¼ˆé€‰å¡«ï¼‰
- æç¤ºæ–‡æ¡ˆ: "é€€æ¬¾ç”³è¯·æäº¤åå°†è¿›å…¥äººå·¥å®¡æ ¸æµç¨‹ï¼Œæœ€ç»ˆé€€æ¬¾é‡‘é¢ä»¥å®¡æ ¸ç»“æœä¸ºå‡†ã€‚"

**ç¦æ­¢å‡ºç°**: ä»»ä½•é‡‘é¢ç›¸å…³å­—æ ·

### 3.3 è®¢å•çŠ¶æ€å±•ç¤º

| çŠ¶æ€ | æ ‡ç­¾ |
|------|------|
| `refunding` | ğŸŸ¡ é€€æ¬¾å¤„ç†ä¸­ |
| `refunded` | âœ… å·²é€€æ¬¾ï¼ˆæ˜¾ç¤ºé‡‘é¢å’Œæ—¶é—´ï¼‰ |

---

## 4. æ•°æ®åº“è®¾è®¡

### æ–°è¡¨: `refund_requests`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | ä¸»é”® |
| `order_id` | UUID | å…³è”è®¢å• |
| `user_id` | UUID | ç”³è¯·ç”¨æˆ· |
| `reason` | TEXT | é€€æ¬¾åŸå›  |
| `reason_detail` | TEXT | è¡¥å……è¯´æ˜ |
| `original_status` | TEXT | **ç”³è¯·å‰è®¢å•çŠ¶æ€**ï¼ˆæ‹’ç»æ—¶æ¢å¤ï¼‰ |
| `images_snapshot` | JSONB | é¢„ç•™å›¾ç‰‡å­—æ®µ |
| `status` | TEXT | pending/approved/rejected |
| `refund_amount` | DECIMAL | å®é™…é€€æ¬¾é‡‘é¢ |
| `admin_id` | UUID | å®¡æ ¸ç®¡ç†å‘˜ |
| `admin_note` | TEXT | ç®¡ç†å‘˜å¤‡æ³¨ |
| `created_at` | TIMESTAMPZ | ç”³è¯·æ—¶é—´ |
| `reviewed_at` | TIMESTAMPZ | å®¡æ ¸æ—¶é—´ |

---

## 5. åç«¯å‡½æ•°

### `create_refund_request(p_order_id, p_reason, p_reason_detail)`
1. éªŒè¯è®¢å•å½’å±ã€çŠ¶æ€å¯ç”³è¯·
2. è®°å½• `original_status = orders.status`
3. åˆ›å»º `refund_requests` è®°å½•
4. æ›´æ–° `orders.status = 'refunding'`

### `admin_review_refund(p_request_id, p_approved, p_refund_amount, p_admin_note)`

**åŒæ„**:
- `refund_requests.status = 'approved'`
- `orders.status = 'refunded'`
- é€€æ¬¾é‡‘é¢åŠ å…¥ç”¨æˆ·ä½™é¢
- è®°å½• wallet_transaction

**æ‹’ç»**:
- `refund_requests.status = 'rejected'`
- `orders.status = original_status` â† **æ¢å¤åŸçŠ¶æ€**
