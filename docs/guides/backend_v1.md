# Fandula 后端与数据库核心设计文档（V1）

## 一、总体设计原则
1. **规则先于代码**
2. **可扩展优先**
3. **可追溯性**：涉及资金/资源变更必留订单。
4. **数据不可随意删除**：禁止物理删除（采用逻辑删除或状态控制）。

## 二、商品体系 (product_type)
- `virtual`: 虚拟充值服务型
- `shared_account`: 账号合租共享型
- `one_time_cdk`: 一次性兑换码型

## 三、CDK (可占用资源单元) 逻辑
- **一次性兑换码**：使用即失效（unused -> used）。
- **虚拟充值**：并发控制单元，不消耗。
- **账号合租**：Slot 模型。`slot_index` 首次分配即写死，过期仅释放 status，不删除记录。

## 四、订单与续费规则
- **每一笔支付 = 一笔新订单**。
- **续费流程**：生成 `order_type = 'renew'` 的新订单，并基于原订单 `end_time` 叠加时间，同步更新原订单 `end_time` 以便查询。

## 五、用户规则
- **UID**：8 位随机数字，唯一且永久。
- **登录**：邮箱验证码，不存在则自动注册。

## 六、数据库清单 (见 SQL 脚本)
- `user`, `product`, `cdk`, `order`, `message`

## 七、开发禁止红线
- 禁止修改三大类定义。
- 禁止物理删除订单。
- 禁止修改账号合租 Slot 分配规则。
