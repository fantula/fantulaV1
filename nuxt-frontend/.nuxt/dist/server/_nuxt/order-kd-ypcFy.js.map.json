{"file":"order-kd-ypcFy.js","mappings":";AA2EO,MAAM,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA,EAKzB,MAAM,UAAU,QAOuE;AACnF,UAAM,SAAS,uBAAA;AACf,UAAM,EAAE,OAAO,GAAG,WAAW,IAAI,YAAY,QAAQ,gBAAgB,QAAA,IAAY;AAEjF,QAAI,QAAQ,OACP,KAAK,QAAQ,EAEb,OAAO;AAAA;AAAA;AAAA,eAGL,EAAE,OAAO,QAAA,CAAS,EACpB,MAAM,cAAc,EAAE,WAAW,MAAA,CAAO,EACxC,OAAO,OAAO,KAAK,UAAU,OAAO,WAAW,CAAC;AAErD,QAAI,YAAY;AACZ,cAAQ,MAAM,GAAG,cAAc,UAAU;AAAA,IAC7C;AAEA,QAAI,QAAQ;AACR,cAAQ,MAAM,GAAG,UAAU,MAAM;AAAA,IACrC;AAGA,QAAI,kBAAkB,eAAe,SAAS,GAAG;AAC7C,qBAAe,QAAQ,CAAA,MAAK;AACxB,gBAAQ,MAAM,IAAI,UAAU,CAAC;AAAA,MACjC,CAAC;AAAA,IACL;AAEA,QAAI,SAAS;AAET,cAAQ,MAAM,MAAM,YAAY,IAAI,OAAO,GAAG;AAAA,IAClD;AAEA,UAAM,EAAE,MAAM,OAAO,MAAA,IAAU,MAAM;AAErC,QAAI,OAAO;AACP,cAAQ,MAAM,aAAa,KAAK;AAChC,aAAO,EAAE,SAAS,OAAO,QAAQ,CAAA,GAAI,OAAO,GAAG,OAAO,MAAM,QAAA;AAAA,IAChE;AAGA,UAAM,UAAU,QAAQ,CAAA,GAAI,IAAI,CAAA,UAAS;AAErC,YAAM,aAAa,MAAM,YAAY,MAAM;AAC3C,YAAM,UAAU,MAAM,QAAQ,UAAU,IAAI,WAAW,CAAC,IAAK,cAAc;AAE3E,aAAO;AAAA,QACH,GAAG;AAAA,QACH,UAAU;AAAA,MAAA;AAAA,IAElB,CAAC;AAED,WAAO,EAAE,SAAS,MAAM,QAAQ,OAAO,SAAS,EAAA;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAkB,IAAY,QAA+D;AAC/F,UAAM,SAAS,uBAAA;AACf,UAAM,EAAE,MAAA,IAAU,MAAM,OACnB,KAAK,QAAQ,EACb,OAAO,EAAE,OAAA,CAAQ,EACjB,GAAG,MAAM,EAAE;AAEhB,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAAA,IAC1C;AACA,WAAO,EAAE,SAAS,KAAA;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,aAAa,KAA8D;AAC7E,UAAM,SAAS,uBAAA;AACf,UAAM,EAAE,MAAA,IAAU,MAAM,OACnB,KAAK,QAAQ,EACb,OAAA,EACA,GAAG,MAAM,GAAG;AAEjB,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAAA,IAC1C;AACA,WAAO,EAAE,SAAS,KAAA;AAAA,EACtB;AACJ;","names":[],"sources":["../../../../api/admin/order.ts"],"sourcesContent":["\nimport { getAdminSupabaseClient } from '@/utils/supabase-admin'\n\n// ========================================\n// 类型定义 (从 admin-supabase.ts 迁移)\n// ========================================\n\nexport interface AdminProduct {\n    id: string\n    product_name: string\n    image: string | null\n    // ... 其他字段按需补充，关联查询通常只需要 id 和 name\n}\n\nexport interface AdminOrder {\n    id: string\n    order_no: string | null\n    user_uid: string // 注意：现在主要通过 profile 关联获取 UID\n    user_id: string\n    product_id: string\n    sku_id: string | null\n    order_type: 'virtual' | 'shared_account' | 'one_time_cdk'\n    related_order_id: string | null\n    total_amount: number | null\n    payment_method: 'wallet' | 'alipay' | 'wechat' | null\n    start_time: string\n    end_time: string\n    status: 'pending_delivery' | 'active' | 'refunding' | 'refunded' | 'expired'\n    created_at: string\n    product?: AdminProduct\n    sku?: any\n    slot_occupancy_ids?: string[]\n    // 关联的用户信息\n    profile?: {\n        id: string\n        uid: string\n        avatar: string\n        nickname: string\n    }\n    _profile?: any // 用于前端兼容\n    // 优惠券快照\n    coupon_snapshot?: {\n        coupon_id: string\n        discount_amount: number\n        coupon_code?: string\n    }\n    // 商品快照\n    product_snapshot?: {\n        product_name: string\n        image: string\n    }\n    // SKU快照\n    sku_snapshot?: {\n        spec_combination: any\n    }\n}\n\nexport interface AdminOrderDelivery {\n    id: string\n    order_id: string\n    order_no: string | null\n    product_id: string\n    sku_id: string | null\n    cdk_id: string | null\n    delivery_content: Record<string, any> | null\n    delivery_status: 'delivered' | 'released' | 'refunded' | 'failed'\n    delivered_at: string | null\n    released_at: string | null\n    created_at: string\n}\n\n// ========================================\n// 订单管理 API\n// ========================================\n\nexport const adminOrderApi = {\n    /**\n     * 获取订单列表\n     * 支持按 order_type 筛选 (virtual, shared_account, one_time_cdk)\n     */\n    async getOrders(params: {\n        page: number\n        pageSize: number\n        order_type?: string\n        status?: string\n        exclude_status?: string[] // 排除的状态列表\n        keyword?: string // 搜索订单号\n    }): Promise<{ success: boolean; orders: AdminOrder[]; total: number; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { page = 1, pageSize = 20, order_type, status, exclude_status, keyword } = params\n\n        let query = client\n            .from('orders')\n            // 尝试使用最简资源嵌入语法 (依赖 PostgREST 自动推断外键)\n            .select(`\n                *,\n                profiles(id, uid, avatar, nickname)\n            `, { count: 'exact' })\n            .order('created_at', { ascending: false })\n            .range((page - 1) * pageSize, page * pageSize - 1)\n\n        if (order_type) {\n            query = query.eq('order_type', order_type)\n        }\n\n        if (status) {\n            query = query.eq('status', status)\n        }\n\n        // 排除特定状态（如退款中/已退款）\n        if (exclude_status && exclude_status.length > 0) {\n            exclude_status.forEach(s => {\n                query = query.neq('status', s)\n            })\n        }\n\n        if (keyword) {\n            // 支持搜索订单号\n            query = query.ilike('order_no', `%${keyword}%`)\n        }\n\n        const { data, error, count } = await query\n\n        if (error) {\n            console.error('获取订单列表失败:', error)\n            return { success: false, orders: [], total: 0, error: error.message }\n        }\n\n        // 数据处理：将 profile 处理为前端可用的格式\n        const orders = (data || []).map(order => {\n            // 兼容 Supabase JS 的不同返回格式 (对象或数组)\n            const rawProfile = order.profiles || order.profile\n            const profile = Array.isArray(rawProfile) ? rawProfile[0] : (rawProfile || null)\n\n            return {\n                ...order,\n                _profile: profile\n            }\n        })\n\n        return { success: true, orders, total: count || 0 }\n    },\n\n    /**\n     * 更新订单状态\n     */\n    async updateOrderStatus(id: string, status: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { error } = await client\n            .from('orders')\n            .update({ status })\n            .eq('id', id)\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n        return { success: true }\n    },\n\n    /**\n     * 删除订单 (软删除或硬删除，视业务而定，目前假设是硬删除)\n     */\n    async deleteOrders(ids: string[]): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { error } = await client\n            .from('orders')\n            .delete()\n            .in('id', ids)\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n        return { success: true }\n    }\n}\n"],"version":3}