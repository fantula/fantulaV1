{"file":"scheduler-SGR-C8xV.js","mappings":"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","names":["_ssrRenderComponent","_withCtx","_ssrInterpolate","_unref","CaretRight","_createVNode","_createTextVNode","Refresh","_ssrGetDirectiveProps","_toDisplayString"],"sources":["../../../../api/admin/scheduler.ts","../../../../pages/_mgmt_9Xfa3/backend-settings/scheduler.vue"],"sourcesContent":["\nexport interface SchedulerStatus {\n    isRunning: boolean\n    lastRun: string | null\n    lastResult: any\n}\n\nexport interface SchedulerLog {\n    id: number\n    task_name: string\n    status: 'success' | 'error'\n    executed_at: string\n    affected_count: number\n    error?: string\n}\n\n// TODO: Move base URL to environment config\nconst SCHEDULER_URL = 'http://localhost:3001'\n\nexport const adminSchedulerApi = {\n    /**\n     * Get scheduler status\n     */\n    async getStatus(): Promise<SchedulerStatus> {\n        try {\n            const res = await fetch(`${SCHEDULER_URL}/status`)\n            return await res.json()\n        } catch (e) {\n            console.error('Failed to get scheduler status:', e)\n            return { isRunning: false, lastRun: null, lastResult: null }\n        }\n    },\n\n    /**\n     * Get execution logs\n     */\n    async getLogs(limit: number = 20): Promise<{ success: boolean; logs: SchedulerLog[] }> {\n        try {\n            const res = await fetch(`${SCHEDULER_URL}/logs?limit=${limit}`)\n            return await res.json()\n        } catch (e) {\n            console.error('Failed to get scheduler logs:', e)\n            return { success: false, logs: [] }\n        }\n    },\n\n    /**\n     * Start scheduler\n     */\n    async start(): Promise<{ success: boolean; message?: string }> {\n        try {\n            const res = await fetch(`${SCHEDULER_URL}/start`, { method: 'POST' })\n            return await res.json()\n        } catch (e: any) {\n            return { success: false, message: e.message }\n        }\n    },\n\n    /**\n     * Stop scheduler\n     */\n    async stop(): Promise<{ success: boolean; message?: string }> {\n        try {\n            const res = await fetch(`${SCHEDULER_URL}/stop`, { method: 'POST' })\n            return await res.json()\n        } catch (e: any) {\n            return { success: false, message: e.message }\n        }\n    },\n\n    /**\n     * Run specific task immediately\n     */\n    async runTask(taskName: string): Promise<{ success: boolean; expired_count?: number; error?: string }> {\n        try {\n            const res = await fetch(`${SCHEDULER_URL}/run/${taskName}`, { method: 'POST' })\n            return await res.json()\n        } catch (e: any) {\n            return { success: false, error: e.message }\n        }\n    }\n}\n","<template>\n  <div class=\"scheduler-page\">\n    <!-- 状态概览 -->\n    <div class=\"status-grid\">\n      <div class=\"status-card\" :class=\"{ active: status.isRunning }\">\n        <div class=\"icon-wrapper\">\n          <el-icon v-if=\"status.isRunning\" class=\"rotating\"><Loading /></el-icon>\n          <el-icon v-else><VideoPause /></el-icon>\n        </div>\n        <div class=\"info\">\n          <div class=\"label\">服务状态</div>\n          <div class=\"value\">{{ status.isRunning ? '运行中' : '已停止' }}</div>\n        </div>\n        <div class=\"actions\">\n           <el-button \n            v-if=\"!status.isRunning\" \n            type=\"success\" \n            size=\"small\"\n            @click=\"toggleScheduler(true)\"\n            :loading=\"actionLoading\"\n          >启动服务</el-button>\n          <el-button \n            v-else \n            type=\"danger\" \n            size=\"small\"\n            @click=\"toggleScheduler(false)\"\n            :loading=\"actionLoading\"\n          >停止服务</el-button>\n        </div>\n      </div>\n\n      <div class=\"status-card info\">\n        <div class=\"info-item\">\n          <div class=\"label\">上次执行</div>\n          <div class=\"value\">{{ formatTime(status.lastRun) }}</div>\n        </div>\n        <div class=\"info-divider\"></div>\n        <div class=\"info-item\">\n          <div class=\"label\">执行频率</div>\n          <div class=\"value\">每 5 分钟</div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 任务控制 -->\n    <AdminActionCard title=\"手动触发任务\" class=\"mt-4\">\n       <div class=\"tasks-grid\">\n          <div class=\"task-item\">\n             <div class=\"task-meta\">\n               <span class=\"task-name\">清理过期预订单</span>\n               <span class=\"task-desc\">检测并释放超时的待支付订单库存</span>\n             </div>\n             <el-button \n                type=\"primary\" \n                plain\n                :icon=\"CaretRight\"\n                @click=\"runTask('cleanup_expired_preorders')\"\n                :loading=\"runningTask === 'cleanup_expired_preorders'\"\n             >执行</el-button>\n          </div>\n       </div>\n    </AdminActionCard>\n\n    <!-- 执行日志 -->\n    <AdminActionCard title=\"执行日志\" class=\"mt-4\">\n        <template #header-actions>\n           <el-button :icon=\"Refresh\" circle @click=\"fetchLogs\" :loading=\"logsLoading\" />\n        </template>\n        \n        <el-table :data=\"logs\" style=\"width: 100%\" v-loading=\"logsLoading\" stripe>\n           <el-table-column label=\"执行时间\" width=\"200\">\n             <template #default=\"{ row }\">\n               {{ formatTime(row.executed_at) }}\n             </template>\n           </el-table-column>\n           <el-table-column prop=\"task_name\" label=\"任务名称\" />\n           <el-table-column label=\"状态\" width=\"100\">\n             <template #default=\"{ row }\">\n               <el-tag :type=\"row.status === 'success' ? 'success' : 'danger'\" size=\"small\">\n                 {{ row.status === 'success' ? '成功' : '失败' }}\n               </el-tag>\n             </template>\n           </el-table-column>\n           <el-table-column prop=\"affected_count\" label=\"处理数量\" width=\"120\" align=\"right\" />\n        </el-table>\n    </AdminActionCard>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, onMounted, onUnmounted } from 'vue'\nimport { Loading, VideoPause, CaretRight, Refresh } from '@element-plus/icons-vue'\nimport { ElMessage } from 'element-plus'\nimport { adminSchedulerApi, type SchedulerStatus, type SchedulerLog } from '@/api/admin'\nimport AdminActionCard from '@/components/admin/base/AdminActionCard.vue'\n\n// State\nconst status = ref<SchedulerStatus>({\n  isRunning: false,\n  lastRun: null,\n  lastResult: null\n})\n\nconst logs = ref<SchedulerLog[]>([])\nconst actionLoading = ref(false)\nconst logsLoading = ref(false)\nconst runningTask = ref('')\n\n// Methods\nconst fetchStatus = async () => {\n  const data = await adminSchedulerApi.getStatus()\n  status.value = data\n}\n\nconst fetchLogs = async () => {\n  logsLoading.value = true\n  try {\n    const res = await adminSchedulerApi.getLogs()\n    if (res.success) {\n      logs.value = res.logs\n    }\n  } finally {\n    logsLoading.value = false\n  }\n}\n\nconst toggleScheduler = async (start: boolean) => {\n  actionLoading.value = true\n  try {\n    const res = start ? await adminSchedulerApi.start() : await adminSchedulerApi.stop()\n    if (res.success) {\n      ElMessage.success(start ? '服务已启动' : '服务已停止')\n      await fetchStatus()\n    } else {\n      ElMessage.warning(res.message || '操作失败')\n    }\n  } catch (e: any) {\n    ElMessage.error('操作异常: ' + e.message)\n  } finally {\n    actionLoading.value = false\n  }\n}\n\nconst runTask = async (taskName: string) => {\n  runningTask.value = taskName\n  try {\n    const res = await adminSchedulerApi.runTask(taskName)\n    if (res.success) {\n      ElMessage.success(`执行完成，处理 ${res.expired_count || 0} 条数据`)\n      await fetchLogs()\n    } else {\n      ElMessage.error(res.error || '执行失败')\n    }\n  } catch (e: any) {\n    ElMessage.error('执行异常: ' + e.message)\n  } finally {\n    runningTask.value = ''\n  }\n}\n\nconst formatTime = (time: string | null) => {\n  if (!time) return '-'\n  return new Date(time).toLocaleString('zh-CN', {\n    month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit', second: '2-digit'\n  })\n}\n\n// Auto Refresh\nlet interval: any = null\n\nonMounted(() => {\n  fetchStatus()\n  fetchLogs()\n  interval = setInterval(fetchStatus, 30000)\n})\n\nonUnmounted(() => {\n  if (interval) clearInterval(interval)\n})\n</script>\n\n<style scoped>\n.status-grid {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  gap: 20px;\n  margin-bottom: 20px;\n}\n\n.status-card {\n  background: var(--el-bg-color);\n  border: 1px solid var(--el-border-color-lighter);\n  border-radius: 8px;\n  padding: 20px;\n  display: flex;\n  align-items: center;\n  gap: 20px;\n}\n.status-card.active {\n    border-color: var(--el-color-success-light-5);\n    background: var(--el-color-success-light-9);\n}\n\n.icon-wrapper {\n  width: 48px;\n  height: 48px;\n  border-radius: 12px;\n  background: var(--el-fill-color);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 24px;\n  color: var(--el-text-color-secondary);\n}\n.active .icon-wrapper {\n    background: var(--el-color-success);\n    color: white;\n}\n\n.info {\n    flex: 1;\n}\n.info .label {\n    font-size: 13px;\n    color: var(--el-text-color-secondary);\n}\n.info .value {\n    font-size: 18px;\n    font-weight: 600;\n    color: var(--el-text-color-primary);\n}\n\n.status-card.info {\n    display: flex;\n    justify-content: space-around;\n    padding: 20px 0;\n}\n.info-item {\n    text-align: center;\n}\n.info-divider {\n    width: 1px;\n    height: 30px;\n    background: var(--el-border-color-lighter);\n}\n\n.rotating {\n    animation: rotate 2s linear infinite;\n}\n@keyframes rotate {\n    from { transform: rotate(0deg); }\n    to { transform: rotate(360deg); }\n}\n\n.mt-4 {\n    margin-top: 20px;\n}\n\n.tasks-grid {\n    display: flex;\n    gap: 20px;\n}\n.task-item {\n    flex: 1;\n    background: var(--el-fill-color-light);\n    padding: 15px;\n    border-radius: 6px;\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n}\n.task-meta {\n    display: flex;\n    flex-direction: column;\n}\n.task-name {\n    font-weight: 500;\n    margin-bottom: 4px;\n}\n.task-desc {\n    font-size: 12px;\n    color: var(--el-text-color-secondary);\n}\n</style>\n"],"version":3}