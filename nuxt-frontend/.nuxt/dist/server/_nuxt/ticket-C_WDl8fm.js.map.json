{"file":"ticket-C_WDl8fm.js","mappings":";AAEO,MAAM,YAAY;AAAA;AAAA,EAErB,MAAM,OAAO,SAAiB,OAAe,SAAiB,UAAkB,cAAwB,IAAI;AACxG,UAAM,SAAS,kBAAA;AACf,UAAM,EAAE,MAAM,MAAA,IAAU,MAAM,OAAO,IAAI,iBAAiB;AAAA,MACtD,YAAY;AAAA,MACZ,SAAS;AAAA,MACT,WAAW;AAAA,MACX,YAAY;AAAA,MACZ,eAAe;AAAA,IAAA,CAClB;AAED,QAAI,MAAO,QAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAGjD,UAAM,MAAM;AACZ,QAAI,CAAC,IAAI,QAAS,QAAO,EAAE,SAAS,OAAO,OAAO,IAAI,MAAA;AACtD,WAAO,EAAE,SAAS,MAAM,UAAU,IAAI,UAAA;AAAA,EAC1C;AAAA;AAAA,EAGA,MAAM,QAAQ,SAAiB,OAAO;AAClC,UAAM,SAAS,kBAAA;AACf,QAAI,QAAQ,OACP,KAAK,SAAS,EACd,OAAO,iEAAiE,EACxE,MAAM,cAAc,EAAE,WAAW,OAAO;AAE7C,QAAI,WAAW,OAAO;AAClB,cAAQ,MAAM,GAAG,UAAU,MAAM;AAAA,IACrC;AAEA,UAAM,EAAE,MAAM,MAAA,IAAU,MAAM;AAC9B,QAAI,MAAO,QAAO,EAAE,SAAS,OAAO,MAAM,IAAI,OAAO,MAAM,QAAA;AAG3D,UAAM,YAAY,MAAM,IAAI,CAAC,OAAY;AAAA,MACrC,GAAG;AAAA,MACH,cAAc,EAAE,kBAAkB,CAAC,GAAG,WAAW;AAAA,IAAA,EACnD,KAAK,CAAA;AAEP,WAAO,EAAE,SAAS,MAAM,MAAM,UAAA;AAAA,EAClC;AAAA;AAAA,EAGA,MAAM,UAAU,UAAkB;AAC9B,UAAM,SAAS,kBAAA;AAEf,UAAM,EAAE,MAAM,QAAQ,OAAO,KAAA,IAAS,MAAM,OACvC,KAAK,SAAS,EACd,OAAO,2CAA2C,EAClD,GAAG,MAAM,QAAQ,EACjB,OAAA;AAEL,QAAI,KAAM,QAAO,EAAE,SAAS,OAAO,OAAO,KAAK,QAAA;AAG/C,UAAM,EAAE,MAAM,UAAU,OAAO,SAAS,MAAM,OACzC,KAAK,iBAAiB,EACtB,OAAO,wBAAwB,EAC/B,GAAG,aAAa,QAAQ,EACxB,MAAM,cAAc,EAAE,WAAW,MAAM;AAE5C,QAAI,KAAM,QAAO,EAAE,SAAS,OAAO,OAAO,KAAK,QAAA;AAE/C,WAAO;AAAA,MACH,SAAS;AAAA,MACT,MAAM;AAAA,QACF,GAAG;AAAA,QACH,SAAS,UAAU,IAAI,CAAC,OAAY;AAAA,UAChC,IAAI,EAAE;AAAA,UACN,QAAQ,EAAE,WAAW,UAAU;AAAA,UAC/B,SAAS,EAAE;AAAA,UACX,aAAa,EAAE;AAAA,UACf,MAAM,EAAE;AAAA,QAAA,EACV,KAAK,CAAA;AAAA,MAAC;AAAA,IACZ;AAAA,EAER;AAAA;AAAA,EAGA,MAAM,MAAM,UAAkB,SAAiB,cAAwB,CAAA,GAAI;AACvE,UAAM,SAAS,kBAAA;AACf,UAAM,EAAE,MAAM,MAAA,IAAU,MAAM,OAAO,IAAI,uBAAuB;AAAA,MAC5D,aAAa;AAAA,MACb,WAAW;AAAA,MACX,eAAe;AAAA,IAAA,CAClB;AAED,QAAI,MAAO,QAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AACjD,WAAO,EAAE,SAAS,KAAA;AAAA,EACtB;AACJ;","names":[],"sources":["../../../../api/client/ticket.ts"],"sourcesContent":["import { getSupabaseClient } from '@/utils/supabase'\n\nexport const ticketApi = {\n    // 1. Create Ticket\n    async create(orderId: string, title: string, content: string, priority: string, attachments: string[] = []) {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('create_ticket', {\n            p_order_id: orderId,\n            p_title: title,\n            p_content: content,\n            p_priority: priority,\n            p_attachments: attachments\n        })\n\n        if (error) return { success: false, error: error.message }\n        // RPC returns { success: bool, ticket_id: uuid, error: string } via JSONB \n        // Wait, the SQL returns JSONB which Supabase JS converts to object.\n        const res = data as any\n        if (!res.success) return { success: false, error: res.error }\n        return { success: true, ticketId: res.ticket_id }\n    },\n\n    // 2. Get My Tickets\n    async getList(status: string = 'all') {\n        const client = getSupabaseClient()\n        let query = client\n            .from('tickets')\n            .select('*, orders(order_no, product_snapshot), ticket_messages(content)') // Fetch product info\n            .order('created_at', { ascending: false })\n\n        if (status !== 'all') {\n            query = query.eq('status', status)\n        }\n\n        const { data, error } = await query\n        if (error) return { success: false, data: [], error: error.message }\n\n        // Process to get last message content preview if needed\n        const processed = data?.map((t: any) => ({\n            ...t,\n            last_message: t.ticket_messages?.[0]?.content || ''\n        })) || []\n\n        return { success: true, data: processed }\n    },\n\n    // 3. Get Detail with Messages\n    async getDetail(ticketId: string) {\n        const client = getSupabaseClient()\n        // Get Request Info\n        const { data: ticket, error: tErr } = await client\n            .from('tickets')\n            .select('*, orders(id, order_no, product_snapshot)')\n            .eq('id', ticketId)\n            .single()\n\n        if (tErr) return { success: false, error: tErr.message }\n\n        // Get Messages\n        const { data: messages, error: mErr } = await client\n            .from('ticket_messages')\n            .select('*, sender_id, is_admin') // is_admin stored in DB\n            .eq('ticket_id', ticketId)\n            .order('created_at', { ascending: true })\n\n        if (mErr) return { success: false, error: mErr.message }\n\n        return {\n            success: true,\n            data: {\n                ...ticket,\n                replies: messages?.map((m: any) => ({\n                    id: m.id,\n                    sender: m.is_admin ? 'admin' : 'user',\n                    content: m.content,\n                    attachments: m.attachments,\n                    time: m.created_at\n                })) || []\n            }\n        }\n    },\n\n    // 4. Client Reply\n    async reply(ticketId: string, content: string, attachments: string[] = []) {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('send_ticket_message', {\n            p_ticket_id: ticketId,\n            p_content: content,\n            p_attachments: attachments\n        })\n\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    }\n}\n"],"version":3}