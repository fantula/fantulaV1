{"version":3,"file":"department-BOjp2i2p.js","sources":["../../../../api/admin/department.ts"],"sourcesContent":["/**\n * 部门管理 API\n * 遵循 api/admin/ 规范\n */\n\nimport { getAdminSupabaseClient } from '@/utils/supabase-admin'\n\n// ========================================\n// 类型定义\n// ========================================\n\nexport interface AdminDepartment {\n    id: string\n    name: string\n    permissions: string[]\n    created_at: string\n    user_count?: number\n}\n\n// ========================================\n// 部门管理 API\n// ========================================\n\nexport const adminDepartmentApi = {\n    /**\n     * 获取部门列表（含用户数统计）\n     */\n    async getDepartments(): Promise<{ success: boolean; departments: AdminDepartment[]; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        const { data, error } = await client\n            .from('admin_departments')\n            .select('*')\n            .order('created_at', { ascending: true })\n\n        if (error) {\n            return { success: false, departments: [], error: error.message }\n        }\n\n        // 查询每个部门下的用户数量\n        const departmentsWithCount = await Promise.all(\n            (data || []).map(async (dept) => {\n                const { count } = await client\n                    .from('admin_users')\n                    .select('*', { count: 'exact', head: true })\n                    .eq('department_id', dept.id)\n\n                return { ...dept, user_count: count || 0 }\n            })\n        )\n\n        return { success: true, departments: departmentsWithCount }\n    },\n\n    /**\n     * 创建部门\n     */\n    async createDepartment(data: {\n        name: string\n        permissions?: string[]\n    }): Promise<{ success: boolean; department?: AdminDepartment; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        const { data: department, error } = await client\n            .from('admin_departments')\n            .insert({\n                name: data.name,\n                permissions: data.permissions ?? [],\n            })\n            .select()\n            .single()\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        return { success: true, department }\n    },\n\n    /**\n     * 更新部门\n     */\n    async updateDepartment(id: string, data: {\n        name?: string\n        permissions?: string[]\n    }): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        const { error } = await client\n            .from('admin_departments')\n            .update(data)\n            .eq('id', id)\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        return { success: true }\n    },\n\n    /**\n     * 删除部门（有用户时禁止删除）\n     */\n    async deleteDepartment(id: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        // 检查是否有用户\n        const { count } = await client\n            .from('admin_users')\n            .select('*', { count: 'exact', head: true })\n            .eq('department_id', id)\n\n        if (count && count > 0) {\n            return { success: false, error: `该部门下有 ${count} 个用户，请先移除或重新分配` }\n        }\n\n        const { error } = await client\n            .from('admin_departments')\n            .delete()\n            .eq('id', id)\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        return { success: true }\n    },\n}\n"],"names":[],"mappings":";AAuBO,MAAM,qBAAqB;AAAA;AAAA;AAAA;AAAA,EAI9B,MAAM,iBAAgG;AAClG,UAAM,SAAS,uBAAA;AAEf,UAAM,EAAE,MAAM,MAAA,IAAU,MAAM,OACzB,KAAK,mBAAmB,EACxB,OAAO,GAAG,EACV,MAAM,cAAc,EAAE,WAAW,MAAM;AAE5C,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,aAAa,CAAA,GAAI,OAAO,MAAM,QAAA;AAAA,IAC3D;AAGA,UAAM,uBAAuB,MAAM,QAAQ;AAAA,OACtC,QAAQ,CAAA,GAAI,IAAI,OAAO,SAAS;AAC7B,cAAM,EAAE,UAAU,MAAM,OACnB,KAAK,aAAa,EAClB,OAAO,KAAK,EAAE,OAAO,SAAS,MAAM,KAAA,CAAM,EAC1C,GAAG,iBAAiB,KAAK,EAAE;AAEhC,eAAO,EAAE,GAAG,MAAM,YAAY,SAAS,EAAA;AAAA,MAC3C,CAAC;AAAA,IAAA;AAGL,WAAO,EAAE,SAAS,MAAM,aAAa,qBAAA;AAAA,EACzC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,iBAAiB,MAGyD;AAC5E,UAAM,SAAS,uBAAA;AAEf,UAAM,EAAE,MAAM,YAAY,MAAA,IAAU,MAAM,OACrC,KAAK,mBAAmB,EACxB,OAAO;AAAA,MACJ,MAAM,KAAK;AAAA,MACX,aAAa,KAAK,eAAe,CAAA;AAAA,IAAC,CACrC,EACA,OAAA,EACA,OAAA;AAEL,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAAA,IAC1C;AAEA,WAAO,EAAE,SAAS,MAAM,WAAA;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,iBAAiB,IAAY,MAGe;AAC9C,UAAM,SAAS,uBAAA;AAEf,UAAM,EAAE,MAAA,IAAU,MAAM,OACnB,KAAK,mBAAmB,EACxB,OAAO,IAAI,EACX,GAAG,MAAM,EAAE;AAEhB,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAAA,IAC1C;AAEA,WAAO,EAAE,SAAS,KAAA;AAAA,EACtB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,iBAAiB,IAA2D;AAC9E,UAAM,SAAS,uBAAA;AAGf,UAAM,EAAE,MAAA,IAAU,MAAM,OACnB,KAAK,aAAa,EAClB,OAAO,KAAK,EAAE,OAAO,SAAS,MAAM,KAAA,CAAM,EAC1C,GAAG,iBAAiB,EAAE;AAE3B,QAAI,SAAS,QAAQ,GAAG;AACpB,aAAO,EAAE,SAAS,OAAO,OAAO,SAAS,KAAK,iBAAA;AAAA,IAClD;AAEA,UAAM,EAAE,MAAA,IAAU,MAAM,OACnB,KAAK,mBAAmB,EACxB,OAAA,EACA,GAAG,MAAM,EAAE;AAEhB,QAAI,OAAO;AACP,aAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAA;AAAA,IAC1C;AAEA,WAAO,EAAE,SAAS,KAAA;AAAA,EACtB;AACJ;"}