{"file":"cdk-ObzrOMzo.js","mappings":"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","names":[],"sources":["../../../../api/admin/cdk.ts"],"sourcesContent":["/**\n * CDK 管理 API\n * 从 admin-supabase.ts 独立拆分\n */\n\nimport { getAdminSupabaseClient } from '@/utils/supabase-admin'\n\n// ========================================\n// 类型定义\n// ========================================\nexport interface AdminCDK {\n    id: string\n    code: string\n    cdk_type: 'virtual' | 'shared' | 'one_time'\n    stock: number\n    max_slots: number\n    account_data: Record<string, any> | null\n    product_snapshot: { product_id: string; product_name: string; product_image?: string } | null\n    status: 'idle' | 'using' | 'used' | 'disabled'\n    created_at: string\n    used_at: string | null\n    sku_mappings?: { id: string; sku_id: string; sku?: any }[]\n    slot_occupancies?: { id: string; slot_index: number; status: string }[]\n}\n\n// ========================================\n// API 实现\n// ========================================\nexport const adminCdkApi = {\n    /**\n     * 获取 CDK 列表（包含 SKU 映射关系）\n     */\n    async getCdks(params?: {\n        cdk_type?: string\n        status?: string\n        limit?: number\n        offset?: number\n    }): Promise<{ success: boolean; cdks: AdminCDK[]; total: number; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        let query = client\n            .from('cdks')\n            .select(`\n                *,\n                sku_mappings:cdk_sku_map(id, sku_id, sku:product_skus(id, spec_combination, price, product_type)),\n                slot_occupancies(id, slot_index, status)\n            `, { count: 'exact' })\n\n        if (params?.cdk_type) query = query.eq('cdk_type', params.cdk_type)\n        if (params?.status) query = query.eq('status', params.status)\n\n        query = query.order('created_at', { ascending: false })\n\n        if (params?.limit) {\n            const offset = params.offset || 0\n            query = query.range(offset, offset + params.limit - 1)\n        }\n\n        const { data, error, count } = await query\n\n        if (error) return { success: false, cdks: [], total: 0, error: error.message }\n        return { success: true, cdks: data || [], total: count || 0 }\n    },\n\n    /**\n     * 批量创建 CDK (包含商品快照)\n     */\n    async createCdks(data: {\n        sku_ids: string[]\n        cdk_type: 'virtual' | 'shared' | 'one_time'\n        codes: string[]\n        max_slots?: number\n        stock?: number\n        account_data?: Record<string, any>\n        product_snapshot?: { product_id: string; product_name: string; product_image?: string }\n    }): Promise<{ success: boolean; count: number; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        // Virtual 类型检查：通过 SKU 检查是否已有绑定的 virtual CDK\n        if (data.cdk_type === 'virtual') {\n            const { data: existingMappings } = await client\n                .from('cdk_sku_map')\n                .select(`sku_id, cdk:cdks!inner(id, cdk_type)`)\n                .in('sku_id', data.sku_ids)\n                .eq('cdk.cdk_type', 'virtual')\n\n            if (existingMappings && existingMappings.length > 0) {\n                return { success: false, count: 0, error: '存在 SKU 已有虚拟库存资源，请在 CDK 列表中编辑现有资源' }\n            }\n        }\n\n        let cdksToInsert: any[] = []\n        const snapshot = data.product_snapshot || null\n\n        if (data.cdk_type === 'shared') {\n            cdksToInsert = data.codes.map(code => ({\n                code, cdk_type: data.cdk_type,\n                max_slots: data.max_slots || 1, stock: 1,\n                account_data: data.account_data || null, status: 'idle',\n                product_snapshot: snapshot,\n            }))\n        } else if (data.cdk_type === 'virtual') {\n            cdksToInsert = [{\n                code: data.codes[0] || `VIRTUAL-${Date.now()}`,\n                cdk_type: data.cdk_type, max_slots: 1, stock: data.stock || 1,\n                account_data: data.account_data || null, status: 'idle',\n                product_snapshot: snapshot,\n            }]\n        } else {\n            cdksToInsert = data.codes.map(code => ({\n                code, cdk_type: data.cdk_type,\n                max_slots: 1, stock: 1, account_data: data.account_data || null, status: 'idle',\n                product_snapshot: snapshot,\n            }))\n        }\n\n        const { data: createdCdks, error: cdkError } = await client\n            .from('cdks').insert(cdksToInsert).select('id')\n\n        if (cdkError) return { success: false, count: 0, error: cdkError.message }\n\n        // 创建 CDK ↔ SKU 映射\n        const mappings: { cdk_id: string; sku_id: string }[] = []\n        for (const cdk of createdCdks || []) {\n            for (const skuId of data.sku_ids) {\n                mappings.push({ cdk_id: cdk.id, sku_id: skuId })\n            }\n        }\n\n        if (mappings.length > 0) {\n            const { error: mapError } = await client.from('cdk_sku_map').insert(mappings)\n            if (mapError) {\n                console.error('CDK SKU 映射创建失败:', mapError)\n                return { success: true, count: createdCdks?.length || 0, error: `CDK 已创建但 SKU 映射失败: ${mapError.message}` }\n            }\n        }\n\n        // 合租类型：创建 slot_occupancies\n        if (data.cdk_type === 'shared' && createdCdks && createdCdks.length > 0) {\n            const maxSlots = Math.min(Math.max(data.max_slots || 1, 1), 10)\n            const slotRecords: { cdk_id: string; slot_index: number; status: string }[] = []\n\n            for (const cdk of createdCdks) {\n                for (let i = 1; i <= maxSlots; i++) {\n                    slotRecords.push({ cdk_id: cdk.id, slot_index: i, status: 'idle' })\n                }\n            }\n\n            if (slotRecords.length > 0) {\n                const { error: slotError } = await client.from('slot_occupancies').insert(slotRecords)\n                if (slotError) {\n                    console.error('槽位记录创建失败:', slotError)\n                    return { success: true, count: createdCdks?.length || 0, error: `CDK 已创建但槽位创建失败: ${slotError.message}` }\n                }\n            }\n        }\n\n        return { success: true, count: createdCdks?.length || 0 }\n    },\n\n    /**\n     * 删除 CDK（仅允许删除 idle 状态）\n     */\n    async deleteCdk(id: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        const { data: cdk } = await client.from('cdks').select('status').eq('id', id).single()\n        if (cdk?.status !== 'idle') return { success: false, error: '只能删除未使用的 CDK' }\n\n        const { count: orderCount } = await client\n            .from('order_deliveries').select('*', { count: 'exact', head: true }).eq('cdk_id', id)\n        if (orderCount && orderCount > 0) return { success: false, error: `无法删除：有 ${orderCount} 笔订单关联到此 CDK` }\n\n        const { error } = await client.from('cdks').delete().eq('id', id)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    },\n\n    /**\n     * 批量删除 CDK\n     */\n    async deleteCdks(ids: string[]): Promise<{ success: boolean; count: number; error?: string }> {\n        if (!ids.length) return { success: true, count: 0 }\n        const client = getAdminSupabaseClient()\n        const { error, count } = await client.from('cdks').delete({ count: 'exact' }).in('id', ids).eq('status', 'idle')\n        if (error) return { success: false, count: 0, error: error.message }\n        return { success: true, count: count || 0 }\n    },\n\n    /**\n     * CDK 上架\n     */\n    async enableCdk(id: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { data: cdk } = await client.from('cdks').select('status').eq('id', id).single()\n        if (cdk?.status !== 'disabled') return { success: false, error: '只能上架已下架的 CDK' }\n        const { error } = await client.from('cdks').update({ status: 'idle' }).eq('id', id)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    },\n\n    /**\n     * CDK 下架\n     */\n    async disableCdk(id: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { data: cdk } = await client.from('cdks').select('status').eq('id', id).single()\n        if (cdk?.status !== 'idle') return { success: false, error: '只能下架空闲状态的 CDK' }\n        const { error } = await client.from('cdks').update({ status: 'disabled' }).eq('id', id)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    },\n\n    /**\n     * 批量上架 CDK\n     */\n    async enableCdks(ids: string[]): Promise<{ success: boolean; count: number; error?: string }> {\n        if (!ids.length) return { success: true, count: 0 }\n        const client = getAdminSupabaseClient()\n        const { error, count } = await client.from('cdks').update({ status: 'idle' }).in('id', ids).eq('status', 'disabled')\n        if (error) return { success: false, count: 0, error: error.message }\n        return { success: true, count: count || 0 }\n    },\n\n    /**\n     * 批量下架 CDK\n     */\n    async disableCdks(ids: string[]): Promise<{ success: boolean; count: number; error?: string }> {\n        if (!ids.length) return { success: true, count: 0 }\n        const client = getAdminSupabaseClient()\n        const { error, count } = await client.from('cdks').update({ status: 'disabled' }).in('id', ids).eq('status', 'idle')\n        if (error) return { success: false, count: 0, error: error.message }\n        return { success: true, count: count || 0 }\n    },\n\n    /**\n     * 获取单个 CDK 详情\n     */\n    async getCdkById(id: string): Promise<{ success: boolean; cdk?: AdminCDK; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { data, error } = await client\n            .from('cdks')\n            .select(`*, sku_mappings:cdk_sku_map(id, sku_id, sku:product_skus(id, spec_combination, price, product_type))`)\n            .eq('id', id).single()\n        if (error) return { success: false, error: error.message }\n        return { success: true, cdk: data }\n    },\n\n    /**\n     * 更新 CDK\n     */\n    async updateCdk(id: string, data: {\n        max_slots?: number; code?: string; account_data?: Record<string, any>; stock?: number;\n        product_snapshot?: { product_id: string; product_name: string; product_image?: string }\n    }): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n\n        const { data: currentCdk } = await client.from('cdks').select('cdk_type, max_slots').eq('id', id).single()\n        if (!currentCdk) return { success: false, error: 'CDK 不存在' }\n\n        // 合租类型：处理 max_slots 变更\n        if (currentCdk.cdk_type === 'shared' && data.max_slots !== undefined) {\n            const newMaxSlots = Math.min(Math.max(data.max_slots, 1), 10)\n            const oldMaxSlots = currentCdk.max_slots || 1\n\n            const { count: occupiedCount } = await client\n                .from('slot_occupancies').select('*', { count: 'exact', head: true }).eq('cdk_id', id).eq('status', 'occupied')\n            if (newMaxSlots < (occupiedCount || 0)) {\n                return { success: false, error: `不能减少到 ${newMaxSlots}，当前已使用 ${occupiedCount} 个车位` }\n            }\n\n            const { count: existingSlotCount } = await client\n                .from('slot_occupancies').select('*', { count: 'exact', head: true }).eq('cdk_id', id)\n\n            if (!existingSlotCount || existingSlotCount === 0) {\n                const allSlots: { cdk_id: string; slot_index: number; status: string }[] = []\n                for (let i = 0; i < newMaxSlots; i++) allSlots.push({ cdk_id: id, slot_index: i, status: 'idle' })\n                if (allSlots.length > 0) await client.from('slot_occupancies').insert(allSlots)\n            } else if (newMaxSlots > oldMaxSlots) {\n                const newSlots: { cdk_id: string; slot_index: number; status: string }[] = []\n                for (let i = oldMaxSlots; i < newMaxSlots; i++) newSlots.push({ cdk_id: id, slot_index: i, status: 'idle' })\n                if (newSlots.length > 0) await client.from('slot_occupancies').insert(newSlots)\n            }\n\n            if (newMaxSlots < oldMaxSlots) {\n                await client.from('slot_occupancies').delete().eq('cdk_id', id).gte('slot_index', newMaxSlots).eq('status', 'idle')\n            }\n\n            data.max_slots = newMaxSlots\n        }\n\n        const updateData: Record<string, any> = {}\n        if (data.max_slots !== undefined) updateData.max_slots = data.max_slots\n        if (data.code !== undefined) updateData.code = data.code\n        if (data.account_data !== undefined) updateData.account_data = data.account_data\n        if (data.stock !== undefined) updateData.stock = data.stock\n        if (data.product_snapshot !== undefined) updateData.product_snapshot = data.product_snapshot\n\n        if (Object.keys(updateData).length === 0) return { success: false, error: '没有可更新的数据' }\n\n        const { error } = await client.from('cdks').update(updateData).eq('id', id)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    },\n\n    /**\n     * 获取 CDK 的 SKU 绑定列表\n     */\n    async getCdkSkuMappings(cdkId: string): Promise<{ success: boolean; mappings: any[]; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { data, error } = await client\n            .from('cdk_sku_map')\n            .select(`id, sku_id, sku:product_skus(id, spec_combination, price, product_type), created_at`)\n            .eq('cdk_id', cdkId)\n        if (error) return { success: false, mappings: [], error: error.message }\n        return { success: true, mappings: data || [] }\n    },\n\n    /**\n     * 添加 CDK ↔ SKU 绑定\n     */\n    async addCdkSkuMapping(cdkId: string, skuId: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        console.log('[addCdkSkuMapping] params:', { cdkId, skuId })\n\n        const { data: existing } = await client\n            .from('cdk_sku_map').select('id').eq('cdk_id', cdkId).eq('sku_id', skuId).maybeSingle()\n\n        if (existing) {\n            console.log('[addCdkSkuMapping] Already exists, skipping')\n            return { success: true }\n        }\n\n        const { error: insertError } = await client.from('cdk_sku_map').insert({ cdk_id: cdkId, sku_id: skuId })\n        console.log('[addCdkSkuMapping] Insert result:', { insertError })\n\n        if (insertError) return { success: false, error: insertError.message }\n        return { success: true }\n    },\n\n    /**\n     * 删除 CDK ↔ SKU 绑定\n     */\n    async removeCdkSkuMapping(mappingId: string): Promise<{ success: boolean; error?: string }> {\n        const client = getAdminSupabaseClient()\n        const { error } = await client.from('cdk_sku_map').delete().eq('id', mappingId)\n        if (error) return { success: false, error: error.message }\n        return { success: true }\n    },\n}\n"],"version":3}