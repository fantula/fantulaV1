{"file":"goods-BnwZn77-.js","mappings":"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","names":[],"sources":["../../../../utils/request.ts","../../../../api/goods.ts"],"sourcesContent":["import type { AxiosRequestConfig } from 'axios'\nimport type { ApiResponse } from '@/types/api'\n\n/**\n * ⚠️ 已废弃：此文件不应再被使用\n * \n * 原因：在 utils 中直接使用 Nuxt Composables 违反 Nuxt 使用规则\n * \n * 新用法：\n * ```typescript\n * const http = useHttp()\n * const res = await http.get('/api/xxx')\n * ```\n * \n * 或直接使用 $axios：\n * ```typescript\n * const { $axios } = useNuxtApp()\n * const res = await $axios.get('/api/xxx')\n * ```\n */\n\n// 保留导出以避免编译错误，但实际调用会抛出错误\nexport const http = {\n  get<T = any>(url: string, params?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {\n    throw new Error('http.get 已废弃，请改用 useHttp() composable')\n  },\n\n  post<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {\n    throw new Error('http.post 已废弃，请改用 useHttp() composable')\n  },\n\n  put<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {\n    throw new Error('http.put 已废弃，请改用 useHttp() composable')\n  },\n\n  delete<T = any>(url: string, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {\n    throw new Error('http.delete 已废弃，请改用 useHttp() composable')\n  },\n\n  upload<T = any>(url: string, file: File, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {\n    throw new Error('http.upload 已废弃，请改用 useHttp() composable')\n  },\n\n  download(url: string, params?: any, filename?: string): Promise<void> {\n    throw new Error('http.download 已废弃，请改用 useHttp() composable')\n  }\n}","import { http } from '@/utils/request'\nimport { getSupabaseClient, callEdgeFunction } from '@/utils/supabase'\nimport type { Goods, GoodsCategory, PageParams, PageResponse, ApiResponse } from '@/types/api'\n\n/**\n * 商品相关API\n */\nexport const goodsApi = {\n  /**\n   * 获取商品列表 - 使用 Supabase 查询\n   * @param params 查询参数\n   */\n  async getGoodsList(params: PageParams & {\n    category?: string\n    categoryId?: string | number\n    keyword?: string\n    minPrice?: number\n    maxPrice?: number\n    sortBy?: 'price' | 'sales' | 'createTime'\n    sortOrder?: 'asc' | 'desc'\n  }): Promise<ApiResponse<PageResponse<Goods>>> {\n    const client = getSupabaseClient()\n\n    let query = client\n      .from('products')\n      .select('*', { count: 'exact' })\n      .eq('status', 'on')\n\n    // 分类过滤\n    if (params.categoryId && params.categoryId !== 'all') {\n      query = query.eq('category_id', params.categoryId)\n    }\n\n    // 关键词搜索\n    if (params.keyword) {\n      query = query.ilike('product_name', `%${params.keyword}%`)\n    }\n\n    // 排序\n    const sortField = params.sortBy === 'price' ? 'display_price'\n      : params.sortBy === 'sales' ? 'initial_sales'\n        : 'sort_order'\n    query = query.order(sortField, { ascending: params.sortOrder !== 'desc' })\n\n    // 分页\n    const page = params.page || 1\n    const limit = params.limit || 12\n    const offset = (page - 1) * limit\n    query = query.range(offset, offset + limit - 1)\n\n    const { data, error, count } = await query\n\n    if (error) {\n      return { code: 500, msg: error.message, data: { list: [], total: 0, page, limit, totalPage: 0 }, success: false }\n    }\n\n    // 适配字段名给前端使用\n    const list = (data || []).map(item => ({\n      id: item.id,\n      title: item.product_name,\n      product_name: item.product_name,\n      coverImage: item.image || '',\n      image: item.image || '',\n      description: '',\n      price: Number(item.display_price) || 0,\n      display_price: Number(item.display_price) || 0,\n      sales: item.initial_sales || 0,\n      initial_sales: item.initial_sales || 0,\n      rating: item.rating || 100,\n      status: item.status === 'on' ? 1 : 0,\n      badge_label: item.badge_label,\n      tags: (item.tags || []).join(','),\n      category_id: item.category_id\n    })) as Goods[]\n\n    const total = count || 0\n    const totalPage = Math.ceil(total / limit)\n\n    return {\n      code: 0,\n      msg: 'success',\n      data: { list, total, page, limit, totalPage },\n      success: true\n    }\n  },\n\n  /**\n   * 获取商品详情 - 使用 Supabase 直接查询（优化后，消除冷启动延迟）\n   * 库存由 checkSkuAvailability() 单独异步获取\n   * @param id 商品ID\n   */\n  async getGoodsDetail(id: number | string): Promise<ApiResponse<Goods>> {\n    try {\n      const client = getSupabaseClient()\n\n      // 1. 查询商品基础信息\n      const { data: product, error: productError } = await client\n        .from('products')\n        .select('*')\n        .eq('id', id)\n        .single()\n\n      if (productError || !product) {\n        return { code: 404, msg: productError?.message || '商品不存在', data: null as any, success: false }\n      }\n\n      // 2. 查询 SKU 列表（通过映射表）\n      const { data: skuMappings, error: skuError } = await client\n        .from('product_sku_map')\n        .select('sku:product_skus(*)')\n        .eq('product_id', id)\n        .order('sort_order', { ascending: true })\n\n      if (skuError) {\n        console.error('获取 SKU 列表失败:', skuError)\n      }\n\n      // 提取 SKU 数据\n      const skuList = (skuMappings || []).map(m => m.sku).filter(Boolean)\n\n      // 转换 SKU 数据格式\n      const skus = (skuList || []).map((sku: any) => {\n        const combination = sku.spec_combination as Record<string, string>\n        const firstSpec = Object.entries(combination)[0] || []\n\n        return {\n          id: sku.id,\n          spec_name: firstSpec[0] || '',\n          spec_value: firstSpec[1] || '',\n          spec_combination: combination,\n          price: Number(sku.price),\n          stock: 0, // 库存由 checkSkuAvailability 单独获取\n          image: sku.image,\n          intro: sku.intro,\n          duration: sku.duration\n        }\n      })\n\n      // 构建规格组（从 SKU 的 spec_combination 提取）\n      const specGroups: { name: string; values: string[] }[] = []\n      const groups: Record<string, Set<string>> = {}\n\n      skus.forEach((sku: any) => {\n        const combination = sku.spec_combination || {}\n        Object.entries(combination).forEach(([name, value]) => {\n          if (!groups[name]) groups[name] = new Set()\n          groups[name].add(value as string)\n        })\n      })\n\n      Object.keys(groups).forEach(name => {\n        specGroups.push({ name, values: Array.from(groups[name]) })\n      })\n\n      // 适配返回数据\n      const goods: Goods = {\n        id: product.id,\n        title: product.product_name,\n        product_name: product.product_name,\n        coverImage: product.image || '',\n        image: product.image || '',\n        description: product.description || '',\n        price: Number(product.display_price) || (skus[0]?.price || 0),\n        display_price: Number(product.display_price) || 0,\n        sales: product.initial_sales || 0,\n        initial_sales: product.initial_sales || 0,\n        rating: product.rating || 100,\n        status: product.status === 'on' ? 1 : 0,\n        badge_label: product.badge_label,\n        tags: (product.tags || []).join(','),\n        skus: skus as any,\n        detail_modules: product.detail_modules || [],\n        specGroups: specGroups,\n        allow_addon: product.allow_addon === true\n      } as Goods & { specGroups: any[]; allow_addon: boolean }\n\n      return { code: 0, msg: 'success', data: goods, success: true }\n    } catch (err) {\n      console.error('获取商品详情失败:', err)\n      return { code: 500, msg: '获取商品详情失败', data: null as any, success: false }\n    }\n  },\n\n  /**\n   * 获取热门商品\n   * @param limit 数量限制\n   */\n  getHotGoods(limit: number = 8): Promise<ApiResponse<Goods[]>> {\n    return http.get('/product/goods', { limit, isHot: true })\n  },\n\n  /**\n   * 获取推荐商品\n   * @param limit 数量限制\n   */\n  getRecommendGoods(limit: number = 8): Promise<ApiResponse<Goods[]>> {\n    return http.get('/product/goods', { limit, isRecommend: true })\n  },\n\n  /**\n   * 获取商品分类列表\n   */\n  async getCategories(): Promise<ApiResponse<GoodsCategory[]>> {\n    const client = getSupabaseClient()\n    const { data, error } = await client\n      .from('product_categories')\n      .select('*')\n      .eq('status', 'on')\n      .order('sort_order', { ascending: true })\n\n    if (error) {\n      return { code: 500, msg: error.message, data: [], success: false }\n    }\n\n    // 适配字段名 (supabase 使用 sort_order, 前端使用 sort)\n    const adaptedData = (data || []).map(item => ({\n      id: item.id,\n      name: item.name,\n      sort: item.sort_order,\n      status: item.status === 'on' ? 1 : 0\n    }))\n\n    return { code: 0, msg: 'success', data: adaptedData as any, success: true }\n  },\n\n  /**\n   * 搜索商品\n   * @param params 搜索参数\n   */\n  searchGoods(params: {\n    keyword: string\n    page: number\n    limit: number\n    category?: string\n    categoryId?: number\n    sortBy?: 'price' | 'sales' | 'createTime'\n    sortOrder?: 'asc' | 'desc'\n  }): Promise<ApiResponse<PageResponse<Goods>>> {\n    return http.get('/product/goods', params)\n  },\n\n  /**\n   * 获取商品SKU信息\n   * @param goodsCode 商品编码\n   */\n  getGoodsSkuInfo(goodsCode: string): Promise<ApiResponse<any>> {\n    return http.get(`/product/goods/getSkuInfo/${goodsCode}`)\n  },\n\n  /**\n   * 通过Unicode获取SKU详细信息\n   * @param unicode SKU唯一码\n   */\n  getSkuByUnicode(unicode: string): Promise<ApiResponse<any>> {\n    return http.get(`/product/goods/getSkuByUnicode/${unicode}`)\n  },\n\n  /**\n   * 查询SKU剩余库存\n   * @param skuUnicode SKU唯一码\n   */\n  getSkuResidue(skuUnicode: string): Promise<ApiResponse<number>> {\n    return http.get(`/product/goods/getSkuResidue/${skuUnicode}`)\n  },\n\n  /**\n   * 获取商品实时库存 (调用 Edge Function)\n   * @param id 商品ID\n   */\n  async getProductStock(id: string | number): Promise<ApiResponse<number>> {\n    const { data, error } = await callEdgeFunction<{ stock: number }>('products', {\n      method: 'GET',\n      params: { id: String(id) }\n    })\n\n    if (error) {\n      console.error('获取库存失败:', error)\n      return { code: 500, msg: error, data: 0, success: false }\n    }\n\n    return { code: 0, msg: 'success', data: data?.stock ?? 0, success: true }\n  }\n}"],"version":3}