{"file":"BaseCouponTicket-DeNYuNt9.js","mappings":"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","names":[],"sources":["../../../../api/coupon.ts","../../../../components/exchange/coupon/BaseCouponTicket.vue"],"sourcesContent":["import { getSupabaseClient } from '@/utils/supabase'\nimport type { ApiResponse } from '@/types/api'\n\nexport interface UserCoupon {\n    id: string\n    user_id: string\n    coupon_id: string\n    status: 'unused' | 'used' | 'expired'\n    redeemed_at: string\n    used_at: string | null\n    coupon: {\n        id: string\n        name: string\n        type: 'flat' | 'balance' | 'product'\n        value: number\n        min_usage: number\n        end_date: string | null\n    }\n}\n\n/**\n * 客户端优惠券 API\n */\nexport const couponApi = {\n    /**\n     * 获取用户持有的优惠券\n     */\n    async getUserCoupons(): Promise<ApiResponse<UserCoupon[]>> {\n        const client = getSupabaseClient()\n        const { data: { user } } = await client.auth.getUser()\n        if (!user) return { code: 401, msg: '未登录', success: false }\n\n        const { data, error } = await client\n            .from('user_coupons')\n            .select(`\n                *,\n                coupon:coupons(id, name, type, value, min_usage, end_date, sku_ids)\n            `)\n            .eq('user_id', user.id)\n            .order('redeemed_at', { ascending: false })\n\n        if (error) return { code: 500, msg: error.message, success: false }\n        return { code: 0, msg: 'success', data: data as any[], success: true }\n    },\n\n    /**\n     * 兑换优惠券码 (使用原子性 RPC 调用)\n     */\n    async redeemCoupon(code: string): Promise<ApiResponse<any>> {\n        const client = getSupabaseClient()\n\n        // 调用数据库原子性函数，防止并发刷券\n        const { data, error } = await client.rpc('redeem_coupon', {\n            p_code: code\n        })\n\n        if (error) {\n            return { code: 500, msg: error.message, success: false }\n        }\n\n        // RPC 返回 jsonb 对象\n        if (data && data.success) {\n            return {\n                code: 0,\n                msg: data.msg || '兑换成功',\n                data: data.coupon,\n                success: true\n            }\n        } else {\n            return {\n                code: 400,\n                msg: data?.error || '兑换失败',\n                success: false\n            }\n        }\n    },\n\n    /**\n     * 使用余额券 (将券内余额转入用户钱包)\n     */\n    async useBalanceCoupon(userCouponId: string): Promise<ApiResponse<any>> {\n        const client = getSupabaseClient()\n        const { data: { user } } = await client.auth.getUser()\n        if (!user) return { code: 401, msg: '未登录', success: false }\n\n        // 1. 获取用户持有的记录并校验类型\n        const { data: userCoupon, error: fetchUserCouponError } = await client\n            .from('user_coupons')\n            .select(`\n                *,\n                coupon:coupons(*)\n            `)\n            .eq('id', userCouponId)\n            .eq('user_id', user.id)\n            .single()\n\n        if (fetchUserCouponError || !userCoupon) {\n            return { code: 400, msg: '优惠券不存在', success: false }\n        }\n\n        if (userCoupon.status !== 'unused') {\n            return { code: 400, msg: '优惠券已使用或已过期', success: false }\n        }\n\n        if (userCoupon.coupon.type !== 'balance') {\n            return { code: 400, msg: '该优惠券不是余额券', success: false }\n        }\n\n        // 2. 更新逻辑 (生产环境必须使用数据库函数/事务)\n        // 这里需要:\n        // a. 更新 user_coupons.status = 'used'\n        // b. 更新 profiles.balance += coupon.value\n        // c. 插入 wallet_transactions 记录\n\n        // 我们通过 RPC 调用预定义的数据库函数 handle_balance_coupon (假设已存在或稍后创建)\n        // 如果没有 RPC，我们需要在客户端按顺序执行，但这不安全。\n        // 根据用户要求 \"不涉及功能的不要改动\"，我倾向于使用 Edge Function 或简单的多步操作。\n        // 但为了安全和一致性，由于我可以通过 apply_migration 创建数据库函数，这是最佳实践。\n\n        const { data, error } = await client.rpc('use_balance_coupon', {\n            p_user_coupon_id: userCouponId,\n            p_user_id: user.id\n        })\n\n        if (error) {\n            return { code: 500, msg: error.message, success: false }\n        }\n\n        // RPC 返回 jsonb 对象，需要检查 data.success 字段\n        if (data && data.success) {\n            return {\n                code: 0,\n                msg: '使用成功，余额已转入您的钱包',\n                success: true,\n                data: {\n                    new_balance: data.new_balance,\n                    added_amount: data.added_amount\n                }\n            }\n        } else {\n            return {\n                code: 400,\n                msg: data?.error || '使用失败',\n                success: false\n            }\n        }\n    },\n\n    /**\n     * 删除用户优惠券 (仅限于逻辑删除或隐藏，这里执行真实删除)\n     */\n    async deleteUserCoupon(userCouponId: string): Promise<ApiResponse<any>> {\n        const client = getSupabaseClient()\n        const { data: { user } } = await client.auth.getUser()\n        if (!user) return { code: 401, msg: '未登录', success: false }\n\n        // 仅允许删除属于该用户的记录\n        const { error } = await client\n            .from('user_coupons')\n            .delete()\n            .eq('id', userCouponId)\n            .eq('user_id', user.id)\n\n        if (error) {\n            return { code: 500, msg: error.message, success: false }\n        }\n        return { code: 0, msg: '删除成功', success: true }\n    },\n\n    /**\n     * 计算优惠券折扣 (结算页调用)\n     */\n    async calculateDiscount(couponId: string, amount: number, skuIds: string[]): Promise<{\n        success: boolean\n        valid: boolean\n        discount_amount: number\n        final_amount: number\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n        const { data: { user } } = await client.auth.getUser()\n        if (!user) return { success: false, valid: false, discount_amount: 0, final_amount: amount, error: '未登录' }\n\n        const { data, error } = await client.rpc('calculate_coupon_discount', {\n            p_user_id: user.id,\n            p_coupon_id: couponId,\n            p_order_amount: amount,\n            p_sku_ids: skuIds\n        })\n\n        if (error) return { success: false, valid: false, discount_amount: 0, final_amount: amount, error: error.message }\n\n        return {\n            success: true,\n            valid: data.valid,\n            discount_amount: data.discount_amount,\n            final_amount: data.final_amount,\n            error: data.error\n        }\n    }\n}\n","<template>\n  <div \n    class=\"coupon-ticket\" \n    :class=\"[\n      `color-${color}`, \n      `size-${size}`,\n      { 'is-disabled': disabled || status !== 'unused' }\n    ]\"\n    @click=\"$emit('click')\"\n  >\n    <!-- Left: Value Section -->\n    <div class=\"ticket-left\">\n      <div class=\"ticket-value\">\n        <span class=\"value-amount\">{{ value }}</span>\n        <span class=\"value-unit\" v-if=\"unit\">{{ unit }}</span>\n      </div>\n      <div class=\"ticket-type-label\">\n        <slot name=\"type-label\">{{ typeLabel }}</slot>\n      </div>\n    </div>\n\n    <!-- Right: Info Section -->\n    <div class=\"ticket-right\">\n      <div class=\"right-main\">\n        <div class=\"ticket-name\">{{ title }}</div>\n        <div class=\"ticket-desc\">{{ desc }}</div>\n      </div>\n      \n      <div class=\"ticket-footer\">\n        <div class=\"ticket-expiry\">\n          <el-icon><Clock /></el-icon>\n          {{ expiryText }}\n        </div>\n        \n        <!-- Action Slot or Default Status Badge -->\n        <div class=\"ticket-action\" @click.stop>\n          <slot name=\"action\">\n            <template v-if=\"status === 'unused' && !disabled\">\n                <button class=\"action-btn\" @click=\"$emit('action')\">\n                  {{ actionText }}\n                </button>\n            </template>\n            <div v-else class=\"status-badge\">{{ statusText }}</div>\n          </slot>\n        </div>\n      </div>\n    </div>\n\n    <!-- Decorative Punch Holes -->\n    <div class=\"punch-hole top\"></div>\n    <div class=\"punch-hole bottom\"></div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed } from 'vue'\nimport { Clock } from '@element-plus/icons-vue'\n\ninterface Props {\n  color?: 'purple' | 'gold' | 'cyan' | 'default'\n  size?: 'normal' | 'compact'\n  value: string | number\n  unit?: string\n  title: string\n  desc?: string\n  typeLabel?: string\n  expiryText?: string\n  status?: 'unused' | 'used' | 'expired'\n  disabled?: boolean\n  actionText?: string\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  color: 'default',\n  size: 'normal',\n  unit: '点',\n  status: 'unused',\n  disabled: false,\n  actionText: '去使用'\n})\n\ndefineEmits(['click', 'action'])\n\nconst statusText = computed(() => {\n  if (props.status === 'used') return '已使用'\n  if (props.status === 'expired') return '已过期'\n  return ''\n})\n</script>\n\n<style scoped>\n.coupon-ticket {\n  position: relative;\n  display: flex;\n  align-items: stretch;\n  background: rgba(255, 255, 255, 0.03);\n  border: 1px solid rgba(255, 255, 255, 0.05);\n  border-radius: 16px;\n  overflow: hidden;\n  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);\n  cursor: default;\n  height: 120px;\n}\n\n.coupon-ticket.size-compact {\n  height: 90px;\n  border-radius: 12px;\n}\n\n.coupon-ticket:hover:not(.is-disabled) {\n  transform: translateY(-2px);\n  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);\n}\n\n/* === Theme Colors === */\n\n/* Purple (Flat/Default) */\n.coupon-ticket.color-purple {\n  background: linear-gradient(135deg, rgba(217, 70, 239, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);\n  border-color: rgba(217, 70, 239, 0.2);\n}\n.coupon-ticket.color-purple:hover:not(.is-disabled) {\n  border-color: rgba(217, 70, 239, 0.4);\n  box-shadow: 0 8px 24px rgba(217, 70, 239, 0.15);\n}\n.coupon-ticket.color-purple .value-amount { color: #E879F9; }\n\n/* Gold (Balance) */\n.coupon-ticket.color-gold {\n  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(251, 191, 36, 0.05) 100%);\n  border-color: rgba(245, 158, 11, 0.2);\n}\n.coupon-ticket.color-gold:hover:not(.is-disabled) {\n  border-color: rgba(245, 158, 11, 0.4);\n  box-shadow: 0 8px 24px rgba(245, 158, 11, 0.15);\n}\n.coupon-ticket.color-gold .value-amount { color: #FBBF24; }\n\n/* Cyan (Product) */\n.coupon-ticket.color-cyan {\n  background: linear-gradient(135deg, rgba(6, 182, 212, 0.08) 0%, rgba(34, 211, 238, 0.05) 100%);\n  border-color: rgba(6, 182, 212, 0.2);\n}\n.coupon-ticket.color-cyan:hover:not(.is-disabled) {\n  border-color: rgba(6, 182, 212, 0.4);\n  box-shadow: 0 8px 24px rgba(6, 182, 212, 0.15);\n}\n.coupon-ticket.color-cyan .value-amount { color: #22D3EE; }\n\n\n/* Disabled / Used / Expired */\n.coupon-ticket.is-disabled {\n  opacity: 0.6;\n  filter: grayscale(0.8);\n  border-color: rgba(255,255,255,0.1);\n  background: rgba(255,255,255,0.02);\n  cursor: not-allowed;\n}\n.coupon-ticket.is-disabled:hover {\n    /* Slight re-color on hover to indicate interactable (e.g. delete) if needed, \n       but BaseTicket handles visual only. Parent handles click logic. \n       Usually we don't want hover effect on disabled unless it's a delete action. \n       Let's keep it minimal. */\n}\n.coupon-ticket.is-disabled .value-amount { color: #94A3B8; }\n\n\n/* Left Side */\n.ticket-left {\n  width: 130px;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  border-right: 1px dashed rgba(255, 255, 255, 0.1);\n  position: relative;\n  flex-shrink: 0;\n}\n\n.size-compact .ticket-left {\n  width: 100px;\n}\n\n.ticket-value {\n  display: flex; align-items: baseline; gap: 2px;\n}\n.value-amount {\n  font-size: 32px; font-weight: 700; font-family: 'Outfit', sans-serif; color: #fff;\n}\n.size-compact .value-amount {\n  font-size: 24px;\n}\n\n.value-unit {\n  font-size: 14px; color: rgba(255,255,255,0.6); margin-left: 2px;\n}\n.ticket-type-label {\n  font-size: 12px; color: #94A3B8; margin-top: 6px;\n}\n.size-compact .ticket-type-label {\n  margin-top: 2px;\n  font-size: 11px;\n}\n\n/* Right Side */\n.ticket-right {\n  flex: 1;\n  padding: 16px 24px;\n  display: flex;\n  flex-direction: column;\n  justify-content: space-between;\n  min-width: 0;\n}\n\n.size-compact .ticket-right {\n  padding: 12px 16px;\n}\n\n.ticket-name {\n  font-size: 16px; font-weight: 600; color: #fff;\n  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;\n}\n.size-compact .ticket-name {\n  font-size: 14px;\n}\n\n.ticket-desc {\n  font-size: 13px; color: #94A3B8; margin-top: 4px;\n}\n.size-compact .ticket-desc {\n  font-size: 12px; margin-top: 2px;\n}\n\n.ticket-footer {\n    display: flex; align-items: center; justify-content: space-between; margin-top: auto;\n}\n\n.ticket-expiry {\n  display: flex; align-items: center; gap: 4px; font-size: 12px; color: #64748B;\n}\n\n/* Action Button */\n.action-btn {\n  padding: 6px 16px;\n  border-radius: 8px;\n  font-size: 12px; font-weight: 600;\n  cursor: pointer; transition: all 0.2s; border: none;\n  background: rgba(255,255,255,0.1); color: #fff;\n}\n/* Theme-specific button colors could be passed or handled by parent class, \n   but defaulting to white/glass is safe or using the theme color. \n   Let's use a generic primary style or rely on specific overrides. */\n.color-purple .action-btn { background: rgba(217, 70, 239, 0.2); color: #E879F9; }\n.color-purple .action-btn:hover { background: rgba(217, 70, 239, 0.3); color: #fff; }\n\n.color-gold .action-btn { background: rgba(245, 158, 11, 0.2); color: #FBBF24; }\n.color-gold .action-btn:hover { background: rgba(245, 158, 11, 0.3); color: #fff; }\n\n.color-cyan .action-btn { background: rgba(6, 182, 212, 0.2); color: #22D3EE; }\n.color-cyan .action-btn:hover { background: rgba(6, 182, 212, 0.3); color: #fff; }\n\n/* Status Badge */\n.status-badge {\n    font-size: 12px; color: #64748B; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 6px;\n}\n\n/* Punch Holes */\n.punch-hole {\n  position: absolute; left: 130px; width: 12px; height: 12px;\n  background: #0f172a; /* Should match page bg, but page might have gradient. Using dark default. */\n  border-radius: 50%; transform: translateX(-50%);\n  z-index: 2;\n}\n.size-compact .punch-hole {\n  left: 100px;\n}\n.punch-hole.top { top: -6px; }\n.punch-hole.bottom { bottom: -6px; }\n</style>\n"],"version":3}