{"file":"uploadImage-C-btIIZs.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAcA,eAAsB,qBAClB,MACA,SAAiB,WACjB,YAKD;AACC,MAAI;AAEA,UAAM,eAAe,CAAC,cAAc,aAAa,aAAa,aAAa,YAAY;AACvF,QAAI,CAAC,aAAa,SAAS,KAAK,IAAI,GAAG;AACnC,aAAO;AAAA,QACH,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,IAEf;AAGA,UAAM,UAAU,KAAK,OAAO;AAC5B,QAAI,KAAK,OAAO,SAAS;AACrB,aAAO;AAAA,QACH,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,IAEf;AAGA,QAAI,QAAQ;AACZ,QAAI;AACA,YAAM,EAAE,kBAAA,IAAsB,MAAM,OAAO,eAAkB,EAAA,KAAA,OAAA,EAAA,EAAA;AAC7D,cAAQ,MAAM,kBAAA;AAAA,IAClB,SAAS,GAAG;AACR,cAAQ,KAAK,oCAAoC,CAAC;AAAA,IACtD;AAGA,QAAI,CAAC,OAAO;AACR,cAAQ,MAAM,aAAA;AAAA,IAClB;AAEA,QAAI,CAAC,OAAO;AACR,aAAO;AAAA,QACH,SAAS;AAAA,QACT,OAAO;AAAA,MAAA;AAAA,IAEf;AAGA,UAAM,WAAW,IAAI,SAAA;AACrB,aAAS,OAAO,QAAQ,IAAI;AAC5B,aAAS,OAAO,UAAU,MAAM;AAGhC,QAAI,YAAY;AACZ,aAAO,IAAI,QAAQ,CAAC,YAAY;AAC5B,cAAM,MAAM,IAAI,SAAA;AAEhB,YAAI,OAAO,aAAa,CAAC,UAAU;AAC/B,cAAI,MAAM,kBAAkB;AACxB,kBAAM,UAAU,KAAK,MAAO,MAAM,SAAS,MAAM,QAAS,GAAG;AAC7D,uBAAW,OAAO;AAAA,UACtB;AAAA,QACJ;AAEA,YAAI,SAAS,MAAM;AACf,cAAI;AACA,kBAAMA,UAAS,KAAK,MAAM,IAAI,YAAY;AAC1C,gBAAI,IAAI,UAAU,OAAO,IAAI,SAAS,KAAK;AACvC,sBAAQ,EAAE,SAAS,MAAM,KAAKA,QAAO,KAAK;AAAA,YAC9C,OAAO;AACH,sBAAQ,EAAE,SAAS,OAAO,OAAOA,QAAO,SAAS,cAAc,IAAI,MAAM,IAAA,CAAK;AAAA,YAClF;AAAA,UACJ,QAAQ;AACJ,oBAAQ,EAAE,SAAS,OAAO,OAAO,UAAU;AAAA,UAC/C;AAAA,QACJ;AAEA,YAAI,UAAU,MAAM;AAChB,kBAAQ,EAAE,SAAS,OAAO,OAAO,QAAQ;AAAA,QAC7C;AAEA,YAAI,KAAK,QAAQ,GAAG,kBAAkB,YAAY;AAClD,YAAI,iBAAiB,iBAAiB,UAAU,KAAK,EAAE;AACvD,YAAI,KAAK,QAAQ;AAAA,MACrB,CAAC;AAAA,IACL;AAGA,UAAM,WAAW,MAAM,MAAM,GAAG,kBAAkB,cAAc;AAAA,MAC5D,QAAQ;AAAA,MACR,SAAS;AAAA,QACL,iBAAiB,UAAU,KAAK;AAAA,MAAA;AAAA,MAEpC,MAAM;AAAA,IAAA,CACT;AAED,UAAM,SAAS,MAAM,SAAS,KAAA;AAE9B,QAAI,CAAC,SAAS,IAAI;AACd,aAAO;AAAA,QACH,SAAS;AAAA,QACT,OAAO,OAAO,SAAS,cAAc,SAAS,MAAM;AAAA,MAAA;AAAA,IAE5D;AAEA,WAAO;AAAA,MACH,SAAS;AAAA,MACT,KAAK,OAAO;AAAA,IAAA;AAAA,EAEpB,SAAS,GAAQ;AACb,YAAQ,MAAM,qBAAqB,CAAC;AACpC,WAAO,EAAE,SAAS,OAAO,OAAO,EAAE,WAAW,OAAA;AAAA,EACjD;AACJ;","names":["result"],"sources":["../../../../utils/uploadImage.ts"],"sourcesContent":["import { getAuthToken, EDGE_FUNCTIONS_URL } from './supabase'\n\n/**\n * 上传进度回调类型\n */\nexport type UploadProgressCallback = (progress: number) => void\n\n/**\n * 上传图片到 Cloudflare R2（通过 Edge Function）\n * @param file 要上传的图片文件\n * @param folder 存储目录，默认 'uploads'\n * @param onProgress 可选的进度回调，参数为 0-100 的百分比\n * @returns 上传结果，包含公开 URL\n */\nexport async function uploadImageToStorage(\n    file: File,\n    folder: string = 'uploads',\n    onProgress?: UploadProgressCallback\n): Promise<{\n    success: boolean\n    url?: string\n    error?: string\n}> {\n    try {\n        // 验证文件类型\n        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']\n        if (!allowedTypes.includes(file.type)) {\n            return {\n                success: false,\n                error: '只支持 JPG、PNG、GIF、WebP 格式的图片'\n            }\n        }\n\n        // 验证文件大小（10MB，与后端一致）\n        const maxSize = 10 * 1024 * 1024 // 10MB\n        if (file.size > maxSize) {\n            return {\n                success: false,\n                error: '图片大小不能超过 10MB'\n            }\n        }\n\n        // 获取认证 Token (优先尝试后台管理员 Token)\n        let token = null\n        try {\n            const { getAdminAuthToken } = await import('./supabase-admin')\n            token = await getAdminAuthToken()\n        } catch (e) {\n            console.warn('Failed to load admin token logic', e)\n        }\n\n        // 如果后台没登录，再尝试前台（仅作备用，以防万一）\n        if (!token) {\n            token = await getAuthToken()\n        }\n\n        if (!token) {\n            return {\n                success: false,\n                error: '请先登录后台管理员账号'\n            }\n        }\n\n        // 构建 FormData\n        const formData = new FormData()\n        formData.append('file', file)\n        formData.append('folder', folder)\n\n        // 如果提供了进度回调，使用 XMLHttpRequest 以支持进度事件\n        if (onProgress) {\n            return new Promise((resolve) => {\n                const xhr = new XMLHttpRequest()\n\n                xhr.upload.onprogress = (event) => {\n                    if (event.lengthComputable) {\n                        const percent = Math.round((event.loaded / event.total) * 100)\n                        onProgress(percent)\n                    }\n                }\n\n                xhr.onload = () => {\n                    try {\n                        const result = JSON.parse(xhr.responseText)\n                        if (xhr.status >= 200 && xhr.status < 300) {\n                            resolve({ success: true, url: result.url })\n                        } else {\n                            resolve({ success: false, error: result.error || `上传失败 (HTTP ${xhr.status})` })\n                        }\n                    } catch {\n                        resolve({ success: false, error: '解析响应失败' })\n                    }\n                }\n\n                xhr.onerror = () => {\n                    resolve({ success: false, error: '网络错误' })\n                }\n\n                xhr.open('POST', `${EDGE_FUNCTIONS_URL}/upload-r2`)\n                xhr.setRequestHeader('Authorization', `Bearer ${token}`)\n                xhr.send(formData)\n            })\n        }\n\n        // 不需要进度时，使用 fetch（更简洁）\n        const response = await fetch(`${EDGE_FUNCTIONS_URL}/upload-r2`, {\n            method: 'POST',\n            headers: {\n                'Authorization': `Bearer ${token}`\n            },\n            body: formData\n        })\n\n        const result = await response.json()\n\n        if (!response.ok) {\n            return {\n                success: false,\n                error: result.error || `上传失败 (HTTP ${response.status})`\n            }\n        }\n\n        return {\n            success: true,\n            url: result.url\n        }\n    } catch (e: any) {\n        console.error('Upload exception:', e)\n        return { success: false, error: e.message || '上传失败' }\n    }\n}\n\n/**\n * 删除图片（现在通过 delete-r2 Edge Function 实现）\n * @param url 图片的公开 URL\n * @returns 删除结果\n * @deprecated 请使用 adminImageApi.deleteImages() 替代，它会自动处理 R2 删除\n */\nexport async function deleteImageFromStorage(url: string): Promise<{\n    success: boolean\n    error?: string\n}> {\n    // 单独删除现在通过 API 层处理，这里保留接口兼容性\n    console.warn('deleteImageFromStorage is deprecated, use adminImageApi.deleteImages() instead')\n    return { success: true }\n}\n"],"version":3}