{"file":"_id_-CYx45PvK.js","mappings":"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","names":["_ssrRenderAttrs","_mergeProps","_unref","ArrowLeft","_isRef","_ssrRenderComponent","_withCtx","_createTextVNode","_ssrRenderList"],"sources":["../../../../composables/admin/useAdminSkuEditor.ts","../../../../pages/_mgmt_9Xfa3/products/sku/[id].vue"],"sourcesContent":["\nimport { ref, computed, onMounted } from 'vue'\nimport { useRouter, useRoute } from 'vue-router'\nimport { ElMessage } from 'element-plus'\nimport { adminProductApi } from '@/api/admin/product'\nimport { adminSkuApi, type SharedSkuGroup } from '@/api/admin/sku'\n\nexport function useAdminSkuEditor() {\n    const route = useRoute()\n    const router = useRouter()\n    const productId = route.params.id as string\n\n    // State\n    const loading = ref(true)\n    const saving = ref(false)\n    const product = ref<any>(null)\n    const specMode = ref<'custom' | 'shared'>('custom')\n    const sharedSkuTag = ref<number | undefined>(undefined)\n    const sharedGroups = ref<SharedSkuGroup[]>([])\n\n    // Editor Data Structure\n    const currentSpecs = ref<any[]>([])\n    const currentSkus = ref<any[]>([])\n\n    // Key for re-rendering editor when mode changes\n    const editorKey = computed(() => `${specMode.value}-${sharedSkuTag.value || 'custom'}`)\n    const shouldShowEditor = computed(() => {\n        if (specMode.value === 'custom') return true\n        return specMode.value === 'shared' && !!sharedSkuTag.value\n    })\n\n    // Actions\n    const loadSharedGroups = async () => {\n        const res = await adminSkuApi.getSharedSkuGroups()\n        if (res.success) {\n            sharedGroups.value = res.groups || []\n            // Refill if in shared mode\n            if (specMode.value === 'shared' && sharedSkuTag.value) {\n                handleSharedGroupChange(sharedSkuTag.value)\n            }\n        }\n    }\n\n    const loadProductData = async () => {\n        if (!productId) { router.back(); return }\n        try {\n            const res = await adminProductApi.getProductWithSkus(productId)\n            if (res.success && res.product) {\n                product.value = res.product\n\n                if (res.skus && res.skus.length > 0) {\n                    const firstTag = res.skus[0].tag\n                    // Determine if all SKUs belong to same shared group\n                    const isShared = firstTag && res.skus.every(s => s.tag === firstTag)\n\n                    if (isShared) {\n                        specMode.value = 'shared'\n                        sharedSkuTag.value = firstTag\n                    } else {\n                        specMode.value = 'custom'\n                        // Map Specs\n                        currentSpecs.value = res.specs ? res.specs.map(s => ({\n                            name: s.name,\n                            values: s.values.map(v => v.value),\n                            inputVisible: false, inputValue: ''\n                        })) : []\n\n                        // Map SKUs\n                        currentSkus.value = res.skus.map(s => ({\n                            id: s.id,\n                            key: Object.values(s.spec_combination || {}).join('::'),\n                            specValues: s.spec_combination || {},\n                            product_type: s.product_type,\n                            price: s.price,\n                            duration: s.duration,\n                            intro: s.intro,\n                            image: s.image,\n                            tag: s.tag\n                        }))\n                    }\n                }\n            } else {\n                ElMessage.error(res.error || '商品加载失败')\n            }\n        } catch (e: any) {\n            ElMessage.error(e.message || '系统错误')\n        } finally {\n            loading.value = false\n        }\n    }\n\n    const handleSpecModeChange = (val: 'custom' | 'shared') => {\n        if (val === 'custom') {\n            sharedSkuTag.value = undefined\n            currentSpecs.value = []\n            currentSkus.value = []\n        } else {\n            currentSpecs.value = []\n            currentSkus.value = []\n        }\n    }\n\n    const handleSharedGroupChange = (tag: number) => {\n        const group = sharedGroups.value.find(g => g.tag === tag)\n        if (group) {\n            // Convert to Editor Format for Preview\n            const specMap = new Map<string, Set<string>>()\n            const skus = group.skus.map(s => {\n                Object.entries(s.spec_combination).forEach(([k, v]) => {\n                    if (!specMap.has(k)) specMap.set(k, new Set())\n                    specMap.get(k)!.add(v as string)\n                })\n                return {\n                    id: s.id,\n                    key: Object.values(s.spec_combination || {}).join('::'),\n                    specValues: s.spec_combination,\n                    product_type: s.product_type,\n                    price: s.price,\n                    duration: s.duration,\n                    intro: s.intro,\n                    image: s.image,\n                    tag: s.tag\n                }\n            })\n\n            currentSpecs.value = Array.from(specMap.entries()).map(([name, values]) => ({\n                name, values: Array.from(values), inputVisible: false, inputValue: ''\n            }))\n            currentSkus.value = skus\n        }\n    }\n\n    const saveSkus = async (editorInstance: any) => {\n        // Collect Data\n        let payload: any[] = []\n\n        if (specMode.value === 'custom') {\n            if (!editorInstance) return\n            const rawSkus = editorInstance.getSkus()\n            if (rawSkus.length === 0) {\n                ElMessage.warning('请至少配置一种规格')\n                return\n            }\n            payload = rawSkus.map((s: any, i: number) => ({\n                id: s.id,\n                spec_combination: s.specValues,\n                product_type: s.product_type,\n                price: s.price,\n                duration: s.duration,\n                image: s.image,\n                intro: s.intro,\n                sort_order: i\n            }))\n        }\n\n        saving.value = true\n        try {\n            const res = await adminProductApi.updateProductSkus(productId, {\n                mode: specMode.value,\n                sharedTag: sharedSkuTag.value || undefined,\n                skus: payload\n            })\n\n            if (res.success) {\n                ElMessage.success('配置已保存')\n                router.push('/_mgmt_9Xfa3/products')\n            } else {\n                ElMessage.error(res.error)\n            }\n        } finally {\n            saving.value = false\n        }\n    }\n\n    const goToSharedManager = () => window.open('/_mgmt_9Xfa3/products/shared-sku')\n\n    onMounted(async () => {\n        await Promise.all([loadProductData(), loadSharedGroups()])\n    })\n\n    return {\n        productId,\n        loading,\n        saving,\n        product,\n        specMode,\n        sharedSkuTag,\n        sharedGroups,\n        currentSpecs,\n        currentSkus,\n        editorKey,\n        shouldShowEditor,\n\n        handleSpecModeChange,\n        handleSharedGroupChange,\n        goToSharedManager,\n        saveSkus\n    }\n}\n","<template>\n  <div class=\"sku-manager-page\">\n    <!-- Header -->\n    <div class=\"page-header\">\n      <div class=\"header-left\">\n        <el-button @click=\"router.back()\" :icon=\"ArrowLeft\" circle class=\"back-btn\" />\n        <div class=\"product-info\" v-if=\"product\">\n          <img v-if=\"product.image\" :src=\"product.image\" class=\"product-thumb\" />\n          <div class=\"product-details\">\n            <h1 class=\"page-title\">规格管理: {{ product.product_name }}</h1>\n            <span class=\"product-id\">ID: {{ product.id }}</span>\n          </div>\n        </div>\n      </div>\n      <div class=\"header-actions\">\n         <el-button type=\"primary\" size=\"large\" @click=\"handleSave\" :loading=\"saving\">保存配置</el-button>\n      </div>\n    </div>\n    \n    <div class=\"main-content\" v-loading=\"loading\">\n       <div class=\"content-card\">\n          <!-- Mode Switch -->\n          <div class=\"spec-editor-header\">\n             <div class=\"panel-title\">配置模式</div>\n             <div class=\"spec-mode-switch\">\n                <el-radio-group v-model=\"specMode\" @change=\"handleSpecModeChange\">\n                  <el-radio-button label=\"custom\">自定义规格</el-radio-button>\n                  <el-radio-button label=\"shared\">引用共享规格</el-radio-button>\n                </el-radio-group>\n             </div>\n          </div>\n\n          <!-- Shared Mode Selector -->\n          <div v-if=\"specMode === 'shared'\" class=\"shared-spec-selector\">\n             <el-alert type=\"info\" show-icon :closable=\"false\" style=\"margin-bottom: 20px;\">\n                <template #title>引用共享规格组后，此商品的 SKU 将自动与该组保持同步。如需修改，请前往“共享规格库”。</template>\n             </el-alert>\n             <div class=\"selector-row\">\n                <span class=\"label\">选择规格组:</span>\n                <el-select \n                    v-model=\"sharedSkuTag\" \n                    placeholder=\"请选择共享规格组\" \n                    style=\"width: 300px\"\n                    @change=\"handleSharedGroupChange\"\n                >\n                    <el-option \n                      v-for=\"group in sharedGroups\" \n                      :key=\"group.tag\" \n                      :label=\"`#${group.tag} (${group.skus.length} SKU)`\" \n                      :value=\"group.tag\"\n                    />\n                </el-select>\n                <el-button type=\"primary\" link @click=\"goToSharedManager\" style=\"margin-left: 10px;\">管理共享库</el-button>\n             </div>\n          </div>\n\n          <!-- Sku Editor Component -->\n          <AdminSkuEditor\n             v-if=\"shouldShowEditor\"\n             ref=\"skuEditorRef\"\n             :key=\"editorKey\"\n             :mode=\"specMode === 'shared' ? 'linked' : 'standalone'\"\n             :read-only=\"specMode === 'shared'\"\n             :initial-specs=\"currentSpecs\"\n             :initial-skus=\"currentSkus\"\n             :product-id=\"productId\"\n             :tag=\"specMode === 'shared' ? sharedSkuTag : undefined\"\n          />\n          \n          <div v-else-if=\"specMode === 'shared' && !sharedSkuTag\" class=\"empty-tip\">\n             请选择一个共享规格组预览\n          </div>\n\n       </div>\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref } from 'vue'\nimport { useRouter } from 'vue-router'\nimport { ArrowLeft } from '@element-plus/icons-vue'\nimport AdminSkuEditor from '@/components/admin/SkuEditor.vue'\nimport { useAdminSkuEditor } from '@/composables/admin/useAdminSkuEditor'\n\nconst router = useRouter()\nconst skuEditorRef = ref<InstanceType<typeof AdminSkuEditor> | null>(null)\n\nconst {\n    productId,\n    loading,\n    saving,\n    product,\n    specMode,\n    sharedSkuTag,\n    sharedGroups,\n    currentSpecs,\n    currentSkus,\n    editorKey,\n    shouldShowEditor,\n\n    handleSpecModeChange,\n    handleSharedGroupChange,\n    goToSharedManager,\n    saveSkus\n} = useAdminSkuEditor()\n\nconst handleSave = () => saveSkus(skuEditorRef.value)\n\n</script>\n\n<style scoped>\n.sku-manager-page {\n    padding: 20px;\n    background: #f8f9fa;\n    min-height: 100vh;\n}\n.page-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: #fff;\n    padding: 20px;\n    border-radius: 12px;\n    box-shadow: 0 2px 12px rgba(0,0,0,0.05);\n    margin-bottom: 20px;\n}\n.header-left {\n    display: flex;\n    align-items: center;\n    gap: 20px;\n}\n.product-info {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n}\n.product-thumb {\n    width: 60px;\n    height: 60px;\n    border-radius: 8px;\n    object-fit: cover;\n    border: 1px solid #eee;\n}\n.product-details h1 {\n    font-size: 20px;\n    font-weight: 600;\n    margin: 0 0 5px 0;\n}\n.product-id {\n    font-size: 12px;\n    color: #999;\n    font-family: monospace;\n}\n.main-content {\n    background: #fff;\n    border-radius: 12px;\n    padding: 30px;\n    box-shadow: 0 2px 12px rgba(0,0,0,0.05);\n}\n.spec-editor-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 25px;\n    border-bottom: 1px solid #eee;\n    padding-bottom: 15px;\n}\n.panel-title {\n    font-size: 16px;\n    font-weight: 600;\n    color: #333;\n}\n.empty-tip {\n    text-align: center;\n    color: #999;\n    padding: 40px;\n}\n.selector-row {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n</style>\n"],"version":3}