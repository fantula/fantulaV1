{"file":"order-7ENcviEB.js","mappings":"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","names":[],"sources":["../../../../api/client/order.ts"],"sourcesContent":["/**\n * 客户端订单 API\n * 遵循 CLIENT_DEVELOPMENT_GUIDE.md 规范\n */\n\nimport { getSupabaseClient } from '@/utils/supabase'\n\n// ========================================\n// 类型定义\n// ========================================\n\nexport interface ClientOrder {\n    id: string\n    order_no: string\n    order_type: 'virtual' | 'shared_account' | 'one_time_cdk'\n    status: 'pending' | 'pending_delivery' | 'active' | 'expired' | 'completed' | 'refunding' | 'refunded'\n    quantity: number\n    total_amount: number\n    created_at: string\n    expires_at?: string\n    slot_index?: number\n    product_snapshot?: {\n        product_id: string\n        product_name: string\n        image: string\n    }\n    sku_snapshot?: {\n        sku_id: string\n        spec_combination: Record<string, string>\n        duration: number\n        price: number\n    }\n    cdk_snapshot?: string[]\n}\n\nexport interface ClientPreOrder {\n    id: string\n    order_no: string\n    status: 'pending' | 'confirmed' | 'converted' | 'expired' | 'cancelled'\n    quantity: number\n    unit_price: number\n    total_amount: number\n    product_snapshot: {\n        product_id: string\n        product_name: string\n        image: string\n    }\n    sku_snapshot: {\n        sku_id: string\n        spec_combination: Record<string, string>\n        duration: number\n        price: number\n    }\n    source: 'buy_now' | 'cart'\n    expires_at: string\n    created_at: string\n}\n\n// ========================================\n// 订单 API\n// ========================================\n\nexport const clientOrderApi = {\n    /**\n     * 获取用户订单列表 (已支付订单)\n     */\n    async getOrderList(params?: {\n        limit?: number\n        status?: string\n    }): Promise<{\n        success: boolean\n        data?: ClientOrder[]\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        let query = client\n            .from('orders')\n            .select('id, order_no, order_type, status, quantity, total_amount, created_at, expires_at, product_snapshot, sku_snapshot')\n            .order('created_at', { ascending: false })\n\n        if (params?.limit) {\n            query = query.limit(params.limit)\n        }\n\n        if (params?.status && params.status !== 'all') {\n            query = query.eq('status', params.status)\n        }\n\n        const { data, error } = await query\n\n        if (error) {\n            console.error('获取订单列表失败:', error)\n            return { success: false, error: error.message }\n        }\n\n        return { success: true, data: data || [] }\n    },\n\n    /**\n     * 获取订单详情\n     */\n    async getOrderDetail(orderId: string): Promise<{\n        success: boolean\n        data?: ClientOrder & { cdkList?: any[]; slotList?: any[] }\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client\n            .from('orders')\n            .select('*, cdk_snapshot, slot_occupancy_ids') // Select cdk_snapshot and slot_occupancy_ids\n            .eq('id', orderId)\n            .single()\n\n        if (error || !data) {\n            return { success: false, error: error?.message || '订单不存在' }\n        }\n\n        // 获取 CDK 详情\n        let cdkList: any[] = []\n        const cdkIds: string[] = data.cdk_snapshot?.locked_cdk_ids || data.cdk_snapshot || []\n\n        // 兼容旧数据格式 (cdk_snapshot 可能是对象或数组)\n        const realCdkIds = Array.isArray(cdkIds) ? cdkIds : (cdkIds as any).locked_cdk_ids || []\n\n        if (realCdkIds.length > 0) {\n            const { data: cdks } = await client\n                .from('cdks')\n                .select('id, code, account_data')\n                .in('id', realCdkIds)\n\n            if (cdks) {\n                cdkList = cdks.map((cdk: any) => {\n                    let parsed = null\n                    try { parsed = JSON.parse(cdk.code) } catch { }\n                    return {\n                        id: cdk.id,\n                        code: cdk.code,\n                        parsed,\n                        accountData: cdk.account_data\n                    }\n                })\n            }\n        }\n\n        // 获取车位详情 (针对 shared_account)\n        let slotList: any[] = []\n        if (data.slot_occupancy_ids && data.slot_occupancy_ids.length > 0) {\n            const { data: slots } = await client\n                .from('slot_occupancies')\n                .select('id, slot_index, cdk_id')\n                .in('id', data.slot_occupancy_ids)\n\n            if (slots) {\n                slotList = slots\n            }\n        }\n\n        return {\n            success: true,\n            data: { ...data, cdkList, slotList }\n        }\n    },\n\n    /**\n     * 获取待支付预订单列表\n     */\n    async getPendingPreOrders(): Promise<{\n        success: boolean\n        data?: ClientPreOrder[]\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client\n            .from('pre_orders')\n            .select('*')\n            .eq('status', 'pending')\n            .gt('expires_at', new Date().toISOString())\n            .order('created_at', { ascending: false })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        return { success: true, data: data || [] }\n    },\n\n    /**\n     * 获取预订单详情\n     */\n    async getPreOrderDetail(preOrderId: string): Promise<{\n        success: boolean\n        data?: ClientPreOrder\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('get_pre_order', {\n            p_pre_order_id: preOrderId\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '预订单不存在' }\n        }\n\n        return { success: true, data: data.pre_order }\n    },\n\n    /**\n     * 创建预订单 (立即购买)\n     */\n    async createPreOrder(\n        skuId: string,\n        quantity: number = 1,\n        source: 'buy_now' | 'cart' = 'buy_now'\n    ): Promise<{\n        success: boolean\n        preOrderId?: string\n        orderNo?: string\n        totalAmount?: number\n        expiresAt?: string\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('create_pre_order', {\n            p_sku_id: skuId,\n            p_quantity: quantity,\n            p_source: source\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '创建预订单失败' }\n        }\n\n        return {\n            success: true,\n            preOrderId: data.pre_order_id,\n            orderNo: data.order_no,\n            totalAmount: data.total_amount,\n            expiresAt: data.expires_at\n        }\n    },\n\n    /**\n     * 确认预订单并支付\n     */\n    async confirmPreOrder(\n        preOrderId: string,\n        payMethod: 'balance' | 'wechat',\n        couponId?: string\n    ): Promise<{\n        success: boolean\n        orderNo?: string\n        orderId?: string\n        totalAmount?: number\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const payload: any = {\n            p_pre_order_id: preOrderId,\n            p_pay_method: payMethod\n        }\n\n        if (couponId) {\n            payload.p_coupon_id = couponId\n        }\n\n        const { data, error } = await client.rpc('confirm_pre_order', payload)\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '支付失败' }\n        }\n\n        return {\n            success: true,\n            orderNo: data.order_no,\n            orderId: data.order_id,\n            totalAmount: data.total_amount\n        }\n    },\n\n    /**\n     * 取消预订单\n     */\n    async cancelPreOrder(preOrderId: string): Promise<{\n        success: boolean\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('cancel_pre_order', {\n            p_pre_order_id: preOrderId\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '取消失败' }\n        }\n\n        return { success: true }\n    },\n\n    /**\n     * 应用优惠券到预订单\n     */\n    async applyCoupon(\n        preOrderId: string,\n        couponId: string | null\n    ): Promise<{\n        success: boolean\n        totalAmount?: number\n        discountAmount?: number\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('apply_coupon_to_pre_order', {\n            p_pre_order_id: preOrderId,\n            p_coupon_id: couponId\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '应用优惠券失败' }\n        }\n\n        return {\n            success: true,\n            totalAmount: data.total_amount,\n            discountAmount: data.discount_amount\n        }\n    },\n\n    // ========================================\n    // 续费 API\n    // ========================================\n\n    /**\n     * 获取订单可续费的 SKU 列表\n     */\n    async getRenewalSkus(orderId: string): Promise<{\n        success: boolean\n        orderId?: string\n        cdkId?: string\n        endTime?: string\n        product?: {\n            id: string\n            name: string\n            image: string\n        }\n        skus?: Array<{\n            sku_id: string\n            spec_combination: Record<string, string>\n            price: number\n            duration: number\n            product_type: string\n            image?: string\n        }>\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('get_renewal_skus', {\n            p_order_id: orderId\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '获取续费SKU失败' }\n        }\n\n        return {\n            success: true,\n            orderId: data.order_id,\n            cdkId: data.cdk_id,\n            endTime: data.end_time,\n            product: data.product,\n            skus: data.skus || []\n        }\n    },\n\n    /**\n     * 创建续费预订单\n     */\n    async createRenewalPreOrder(\n        skuId: string,\n        oldOrderId: string\n    ): Promise<{\n        success: boolean\n        preOrderId?: string\n        orderNo?: string\n        totalAmount?: number\n        expiresAt?: string\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n\n        const { data, error } = await client.rpc('create_renewal_pre_order', {\n            p_sku_id: skuId,\n            p_old_order_id: oldOrderId\n        })\n\n        if (error) {\n            return { success: false, error: error.message }\n        }\n\n        if (!data?.success) {\n            return { success: false, error: data?.error || '创建续费订单失败' }\n        }\n\n        return {\n            success: true,\n            preOrderId: data.pre_order_id,\n            orderNo: data.order_no,\n            totalAmount: data.total_amount,\n            expiresAt: data.expires_at\n        }\n    },\n\n    // ========================================\n    // 退款 API\n    // ========================================\n\n    /**\n     * 创建退款申请\n     */\n    async createRefundRequest(orderId: string, reason: string, reasonDetail: string = ''): Promise<{\n        success: boolean\n        requestId?: string\n        message?: string\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('create_refund_request', {\n            p_order_id: orderId,\n            p_reason: reason,\n            p_reason_detail: reasonDetail\n        })\n\n        if (error) return { success: false, error: error.message }\n        if (!data?.success) return { success: false, error: data?.error || '申请失败' }\n\n        return { success: true, requestId: data.request_id, message: data.message }\n    },\n\n    /**\n     * 获取退款申请详情\n     */\n    async getRefundRequest(orderId: string): Promise<{\n        success: boolean\n        data?: any\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('get_refund_request', { p_order_id: orderId })\n\n        if (error) return { success: false, error: error.message }\n        if (!data?.success) return { success: false, error: data?.error }\n\n        return { success: true, data: data.request }\n    },\n\n    /**\n     * 取消退款申请\n     */\n    async cancelRefundRequest(orderId: string): Promise<{\n        success: boolean\n        message?: string\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('cancel_user_refund_request', { p_order_id: orderId })\n\n        if (error) return { success: false, error: error.message }\n        if (!data?.success) return { success: false, error: data?.error || '取消失败' }\n\n        return { success: true, message: data.message }\n    },\n\n    /**\n     * 获取订单退款状态（待审核请求和取消次数）\n     */\n    async getOrderRefundInfo(orderId: string): Promise<{\n        success: boolean\n        pendingRequest?: {\n            id: string\n            reason: string\n            created_at: string\n        } | null\n        cancelledCount?: number\n        error?: string\n    }> {\n        const client = getSupabaseClient()\n        const { data, error } = await client.rpc('get_order_refund_info', { p_order_id: orderId })\n\n        if (error) return { success: false, error: error.message }\n        if (!data?.success) return { success: false, error: data?.error }\n\n        return {\n            success: true,\n            pendingRequest: data.pending_request,\n            cancelledCount: data.cancelled_count\n        }\n    },\n}\n"],"version":3}