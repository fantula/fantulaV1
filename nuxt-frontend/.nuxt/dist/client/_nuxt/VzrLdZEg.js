import{ad as r,f as p,g,c as d,o as l,n as v,a as o,D as k,t as u,aI as f,d as m,b as _,E as y,w as b,l as h,dr as w,aG as C,_ as x}from"./o2XBa361.js";const G={async getUserCoupons(){const e=r(),{data:{user:t}}=await e.auth.getUser();if(!t)return{code:401,msg:"未登录",success:!1};const{data:a,error:s}=await e.from("user_coupons").select(`
                *,
                coupon:coupons(id, name, type, value, min_usage, end_date, sku_ids)
            `).eq("user_id",t.id).order("redeemed_at",{ascending:!1});return s?{code:500,msg:s.message,success:!1}:{code:0,msg:"success",data:a,success:!0}},async redeemCoupon(e){const t=r(),{data:a,error:s}=await t.rpc("redeem_coupon",{p_code:e});return s?{code:500,msg:s.message,success:!1}:a&&a.success?{code:0,msg:a.msg||"兑换成功",data:a.coupon,success:!0}:{code:400,msg:a?.error||"兑换失败",success:!1}},async useBalanceCoupon(e){const t=r(),{data:{user:a}}=await t.auth.getUser();if(!a)return{code:401,msg:"未登录",success:!1};const{data:s,error:c}=await t.from("user_coupons").select(`
                *,
                coupon:coupons(*)
            `).eq("id",e).eq("user_id",a.id).single();if(c||!s)return{code:400,msg:"优惠券不存在",success:!1};if(s.status!=="unused")return{code:400,msg:"优惠券已使用或已过期",success:!1};if(s.coupon.type!=="balance")return{code:400,msg:"该优惠券不是余额券",success:!1};const{data:n,error:i}=await t.rpc("use_balance_coupon",{p_user_coupon_id:e,p_user_id:a.id});return i?{code:500,msg:i.message,success:!1}:n&&n.success?{code:0,msg:"使用成功，余额已转入您的钱包",success:!0,data:{new_balance:n.new_balance,added_amount:n.added_amount}}:{code:400,msg:n?.error||"使用失败",success:!1}},async deleteUserCoupon(e){const t=r(),{data:{user:a}}=await t.auth.getUser();if(!a)return{code:401,msg:"未登录",success:!1};const{error:s}=await t.from("user_coupons").delete().eq("id",e).eq("user_id",a.id);return s?{code:500,msg:s.message,success:!1}:{code:0,msg:"删除成功",success:!0}},async calculateDiscount(e,t,a){const s=r(),{data:{user:c}}=await s.auth.getUser();if(!c)return{success:!1,valid:!1,discount_amount:0,final_amount:t,error:"未登录"};const{data:n,error:i}=await s.rpc("calculate_coupon_discount",{p_user_id:c.id,p_coupon_id:e,p_order_amount:t,p_sku_ids:a});return i?{success:!1,valid:!1,discount_amount:0,final_amount:t,error:i.message}:{success:!0,valid:n.valid,discount_amount:n.discount_amount,final_amount:n.final_amount,error:n.error}}},B={class:"ticket-left"},T={class:"ticket-value"},$={class:"value-amount"},U={key:0,class:"value-unit"},q={class:"ticket-type-label"},z={class:"ticket-right"},E={class:"right-main"},N={class:"ticket-name"},V={class:"ticket-desc"},D={class:"ticket-footer"},S={class:"ticket-expiry"},I={key:1,class:"status-badge"},L=p({__name:"BaseCouponTicket",props:{color:{default:"default"},size:{default:"normal"},value:{},unit:{default:"点"},title:{},desc:{},typeLabel:{},expiryText:{},status:{default:"unused"},disabled:{type:Boolean,default:!1},actionText:{default:"去使用"}},emits:["click","action"],setup(e){const t=e,a=g(()=>t.status==="used"?"已使用":t.status==="expired"?"已过期":"");return(s,c)=>{const n=y;return l(),d("div",{class:v(["coupon-ticket",[`color-${e.color}`,`size-${e.size}`,{"is-disabled":e.disabled||e.status!=="unused"}]]),onClick:c[2]||(c[2]=i=>s.$emit("click"))},[o("div",B,[o("div",T,[o("span",$,u(e.value),1),e.unit?(l(),d("span",U,u(e.unit),1)):k("",!0)]),o("div",q,[f(s.$slots,"type-label",{},()=>[m(u(e.typeLabel),1)],!0)])]),o("div",z,[o("div",E,[o("div",N,u(e.title),1),o("div",V,u(e.desc),1)]),o("div",D,[o("div",S,[_(n,null,{default:b(()=>[_(h(w))]),_:1}),m(" "+u(e.expiryText),1)]),o("div",{class:"ticket-action",onClick:c[1]||(c[1]=C(()=>{},["stop"]))},[f(s.$slots,"action",{},()=>[e.status==="unused"&&!e.disabled?(l(),d("button",{key:0,class:"action-btn",onClick:c[0]||(c[0]=i=>s.$emit("action"))},u(e.actionText),1)):(l(),d("div",I,u(a.value),1))],!0)])])]),c[3]||(c[3]=o("div",{class:"punch-hole top"},null,-1)),c[4]||(c[4]=o("div",{class:"punch-hole bottom"},null,-1))],2)}}}),M=x(L,[["__scopeId","data-v-3f846438"]]);export{M as B,G as c};
