const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BPs5C_y9.js","./o2XBa361.js","./entry.DI7xQWfr.css"])))=>i.map(i=>d[i]);
import{f as le,g as se,r as p,G as O,w as s,o as d,a as i,b as t,i as te,d as V,c as m,F as G,k as K,t as M,B as c,_ as ne,am as pe,ax as oe,h as Ie,n as Z,D as L,j as xe,l as x,E as Ue,b1 as $e,eu as De,ev as Se,bJ as ze,a_ as Be,af as Te,aG as ee,aH as Ae,ap as Me,b2 as Oe,ag as Fe}from"./o2XBa361.js";import{E as ie}from"./-Yx_0iEM.js";import{E as re}from"./1SfIsks3.js";import{E as _e}from"./DytS51kl.js";import{E as Le}from"./C1T5KPmY.js";import{E as Ne}from"./BTJpnMK3.js";import{E as Re}from"./BOgRz4Th.js";import{a as ve,E as fe}from"./0BTaD5f-.js";import{a as ge,E as ye}from"./CrjkcmUY.js";import{E as de}from"./CziALilw.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{a as q,b as N}from"./XmVVhx5S.js";import{v as we}from"./BwD4Hz0h.js";import{E as ae}from"./BfOrkIVm.js";import{E as je}from"./DFiWfk7u.js";/* empty css        */import"./Culj45X8.js";import"./Dnj8X3EN.js";import"./CqX7ZdKI.js";import"./Dlk0BVst.js";import"./BB_Ol6Sd.js";import"./DVQwC1Y0.js";import"./Bh6H2ams.js";import"./Cq9Fpw4b.js";import"./t2w4jifC.js";import"./DtTI1xRr.js";import"./CleHDoLI.js";import"./Ds34GQx2.js";import"./Dzr5IOAO.js";import"./hXKBSGVD.js";import"./B_FoF6yT.js";import"./BlW_46uR.js";import"./C9zJf5rn.js";import"./qVmxJdp3.js";import"./ClnTspdU.js";import"./DC3lfPj1.js";import"./B8yeDp5P.js";import"./Z6faUBN3.js";import"./KSqZSeJ0.js";import"./CQuNCUIC.js";import"./FKUjHIpz.js";import"./D6FW0B1r.js";import"./DwwA_QlG.js";const Pe={class:"cat-manager"},Ge={class:"add-cat-row"},Ke={class:"cat-list"},qe=le({__name:"CategoryManagerModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","change"],setup(R,{emit:S}){const z=R,g=S,v=se({get:()=>z.modelValue,set:r=>g("update:modelValue",r)}),n=p(!1),y=p([]),u=p(""),U=async()=>{n.value=!0;const r=await q.getCategories();r.success&&(y.value=r.categories),n.value=!1},B=async()=>{if(!u.value.trim()){c.warning("请输入分类名称");return}n.value=!0;const r=await q.createCategory(u.value);r.success?(c.success("分类添加成功"),u.value="",await U(),g("change")):c.error("添加失败: "+r.error),n.value=!1},$=r=>{ae.confirm(`确认删除分类 "${r.name}" 吗？`,"删除分类",{type:"warning"}).then(async()=>{n.value=!0;const a=await q.deleteCategory(r.id);a.success?(c.success("分类删除成功"),await U(),g("change")):c.error("删除失败: "+a.error),n.value=!1})};return(r,a)=>{const b=re,E=ie,I=_e,w=de,D=we;return d(),O(w,{modelValue:v.value,"onUpdate:modelValue":a[1]||(a[1]=h=>v.value=h),title:"分类管理",width:"500px","append-to-body":"","z-index":2e3,onOpen:U},{default:s(()=>[i("div",Pe,[i("div",Ge,[t(b,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=h=>u.value=h),placeholder:"新分类名称",style:{"margin-right":"10px"}},null,8,["modelValue"]),t(E,{type:"primary",onClick:B,loading:n.value},{default:s(()=>[...a[2]||(a[2]=[V("添加分类",-1)])]),_:1},8,["loading"])]),t(I),te((d(),m("div",Ke,[(d(!0),m(G,null,K(y.value,h=>(d(),m("div",{key:h.id,class:"cat-item"},[i("span",null,M(h.name),1),t(E,{link:"",type:"danger",size:"small",onClick:f=>$(h)},{default:s(()=>[...a[3]||(a[3]=[V("删除",-1)])]),_:1},8,["onClick"])]))),128))])),[[D,n.value]])])]),_:1},8,["modelValue"])}}}),Je=ne(qe,[["__scopeId","data-v-c7ce2fa3"]]),He={class:"dialog-footer"},Qe=le({__name:"ImageUploadModal",props:{modelValue:{type:Boolean},categories:{}},emits:["update:modelValue","success"],setup(R,{emit:S}){const z=R,g=S,v=se({get:()=>z.modelValue,set:r=>g("update:modelValue",r)}),n=pe({categoryId:"",name:""}),y=p([]),u=p(!1),U=(r,a)=>{y.value=a,!n.name&&r.name&&(n.name=r.name)},B=async()=>{if(!n.categoryId){c.warning("请选择分类");return}if(y.value.length===0){c.warning("请选择图片文件");return}if(n.name&&n.name.length>50){c.warning("图片名称过长，请精简");return}u.value=!0;try{const r=y.value[0].raw,{uploadImageToStorage:a}=await oe(async()=>{const{uploadImageToStorage:I}=await import("./BPs5C_y9.js");return{uploadImageToStorage:I}},__vite__mapDeps([0,1,2]),import.meta.url),b=await a(r);if(!b.success){c.error("文件上传失败: "+b.error),u.value=!1;return}const E=await N.createImage({name:n.name||r.name,url:b.url,category_id:n.categoryId});E.success?(c.success("上传成功"),v.value=!1,g("success")):c.error("保存图片记录失败: "+E.error)}catch(r){console.error("Upload error:",r),c.error("上传失败: "+(r.message||"未知错误"))}finally{u.value=!1}},$=()=>{n.categoryId="",n.name="",y.value=[]};return(r,a)=>{const b=ye,E=ge,I=ve,w=re,D=ie,h=je,f=fe,W=de;return d(),O(W,{modelValue:v.value,"onUpdate:modelValue":a[3]||(a[3]=k=>v.value=k),title:"上传图片",width:"500px",onClosed:$,"append-to-body":"","z-index":2e3},{footer:s(()=>[i("span",He,[t(D,{onClick:a[2]||(a[2]=k=>v.value=!1)},{default:s(()=>[...a[6]||(a[6]=[V("取消",-1)])]),_:1}),t(D,{type:"primary",onClick:B,loading:u.value},{default:s(()=>[...a[7]||(a[7]=[V("开始上传",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(f,{model:n,"label-width":"80px"},{default:s(()=>[t(I,{label:"所属分类",required:""},{default:s(()=>[t(E,{modelValue:n.categoryId,"onUpdate:modelValue":a[0]||(a[0]=k=>n.categoryId=k),placeholder:"请选择分类",style:{width:"100%"}},{default:s(()=>[(d(!0),m(G,null,K(R.categories,k=>(d(),O(b,{key:k.id,label:k.name,value:k.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(I,{label:"图片名称"},{default:s(()=>[t(w,{modelValue:n.name,"onUpdate:modelValue":a[1]||(a[1]=k=>n.name=k),placeholder:"默认使用文件名"},null,8,["modelValue"])]),_:1}),t(I,{label:"选择图片",required:""},{default:s(()=>[t(h,{class:"upload-demo",action:"#","auto-upload":!1,limit:1,"on-change":U,"file-list":y.value,"list-type":"picture"},{tip:s(()=>[...a[5]||(a[5]=[i("div",{class:"el-upload__tip"},"只能上传 jpg/png 文件，且不超过 2MB",-1)])]),default:s(()=>[t(D,{type:"primary"},{default:s(()=>[...a[4]||(a[4]=[V("点击选择文件",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),We=ne(Qe,[["__scopeId","data-v-f047ae8e"]]),Xe={class:"media-layout"},Ye={class:"media-sidebar"},Ze={class:"category-nav"},et={key:0,class:"nav-count"},tt={class:"nav-list"},ot=["onClick"],at={class:"nav-label"},lt={class:"sidebar-footer"},st={class:"media-content"},nt={class:"content-toolbar"},it={class:"toolbar-left"},rt={class:"toolbar-right"},dt={key:0,class:"batch-actions"},ut={class:"selection-info"},ct={class:"content-body"},mt={key:0,class:"empty-state"},pt={key:1,class:"image-grid-container"},_t=["onClick"],vt={class:"img-preview"},ft={class:"img-overlay"},gt={class:"overlay-actions"},yt={key:0,class:"selection-mark"},wt={class:"img-meta"},kt=["title"],Vt={class:"img-info"},bt={key:0,class:"cat-badge"},ht={class:"date"},Ct={key:0,class:"content-footer"},Et={class:"dialog-footer"},It=["src"],xt=le({__name:"images",setup(R){const S=p(!1),z=p(!1),g=p([]),v=p([]),n=p(""),y=p(""),u=p([]),U=p(!1),B=p(!1),$=p(!1),r=p(!1),a=p("");Ie(async()=>{await b(),await w()});const b=async()=>{z.value=!0;const l=await q.getCategories();l.success&&(g.value=l.categories),z.value=!1},E=l=>{n.value!==l&&(n.value=l,w())},I=se(()=>v.value.length),w=async()=>{S.value=!0,u.value=[];try{const l=await N.getImages({category_id:n.value,keyword:y.value});l.success?v.value=l.images||[]:c.error(l.error||"获取图片失败")}finally{S.value=!1}},D=()=>{w()},h=l=>{const e=u.value.indexOf(l);e>-1?u.value.splice(e,1):u.value.push(l)},f=pe({id:"",name:"",category_id:""}),W=l=>{f.id=l.id,f.name=l.name,f.category_id=l.category_id||"",$.value=!0},k=async()=>{const l=await N.updateImage(f.id,{name:f.name,category_id:f.category_id});l.success?(c.success("更新成功"),$.value=!1,w()):c.error(l.error||"更新失败")},ke=l=>{ae.confirm("确认删除此图片？","警告",{type:"warning"}).then(async()=>{const e=await N.deleteImage(l.id);e.success?(c.success("删除成功"),w()):c.error(e.error)})},Ve=()=>{ae.confirm(`确认删除选中的 ${u.value.length} 张图片？`,"批量删除",{type:"warning"}).then(async()=>{const l=await N.deleteImages(u.value);l.success?(c.success("批量删除成功"),w()):c.error(l.error)})},X=p(!1),be=async()=>{X.value=!0;try{const{getAdminAuthToken:l}=await oe(async()=>{const{getAdminAuthToken:_}=await import("./o2XBa361.js").then(A=>A.fe);return{getAdminAuthToken:_}},__vite__mapDeps([1,2]),import.meta.url),e=await l();if(!e)return c.error("请登录管理员账号");const{EDGE_FUNCTIONS_URL:T}=await oe(async()=>{const{EDGE_FUNCTIONS_URL:_}=await import("./o2XBa361.js").then(A=>A.ff);return{EDGE_FUNCTIONS_URL:_}},__vite__mapDeps([1,2]),import.meta.url),F=await(await fetch(`${T}/list-r2`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({prefix:"uploads"})})).json();if(F.error)throw new Error(F.error);const J=F.objects||[],Y=new Set(v.value.map(_=>_.url)),H=J.filter(_=>!Y.has(_.url));if(H.length===0){c.success("已是最新");return}let j=g.value.find(_=>_.name==="未分类")?.id;if(!j){const _=await q.createCategory("未分类");_.success&&(j=_.category?.id),await b()}let P=0;for(const _ of H){const A=_.key.split("/").pop();(await N.createImage({name:A,url:_.url,category_id:j})).success&&P++}c.success(`同步完成，新增 ${P} 张图片`),w()}catch(l){c.error("同步失败: "+l.message)}finally{X.value=!1}},he=()=>{w()},Ce=l=>{a.value=l,r.value=!0},Ee=l=>l?new Date(l).toLocaleDateString():"";return(l,e)=>{const T=Ue,C=ie,F=re,J=_e,Y=Le,H=Ne,j=Re,P=ve,_=ye,A=ge,ue=fe,ce=de,me=we;return d(),m("div",Xe,[i("div",Ye,[e[15]||(e[15]=i("div",{class:"sidebar-header"},[i("h3",{class:"sidebar-title"},"图片分类")],-1)),i("div",Ze,[i("div",{class:Z(["nav-item",{active:n.value===""}]),onClick:e[0]||(e[0]=o=>E(""))},[t(T,null,{default:s(()=>[t(x($e))]),_:1}),e[12]||(e[12]=i("span",{class:"nav-label"},"全部图片",-1)),I.value>0&&n.value===""?(d(),m("span",et,M(I.value),1)):L("",!0)],2),e[13]||(e[13]=i("div",{class:"nav-divider"},null,-1)),te((d(),m("div",tt,[(d(!0),m(G,null,K(g.value,o=>(d(),m("div",{key:o.id,class:Z(["nav-item",{active:n.value===o.id,"is-uncategorized":o.name==="未分类"}]),onClick:Q=>E(o.id)},[o.name==="未分类"?(d(),O(T,{key:0},{default:s(()=>[t(x(De))]),_:1})):(d(),O(T,{key:1},{default:s(()=>[t(x(Se))]),_:1})),i("span",at,M(o.name),1)],10,ot))),128))])),[[me,z.value]])]),i("div",lt,[t(C,{block:"",onClick:e[1]||(e[1]=o=>U.value=!0)},{default:s(()=>[t(T,{class:"el-icon--left"},{default:s(()=>[t(x(ze))]),_:1}),e[14]||(e[14]=V(" 管理分类 ",-1))]),_:1})])]),i("div",st,[i("div",nt,[i("div",it,[t(F,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=o=>y.value=o),placeholder:"搜索图片...","prefix-icon":"Search",clearable:"",style:{width:"240px"},onKeyup:xe(D,["enter"]),onClear:D},null,8,["modelValue"])]),i("div",rt,[u.value.length>0?(d(),m("div",dt,[i("span",ut,"已选 "+M(u.value.length)+" 项",1),t(C,{type:"danger",link:"",onClick:Ve},{default:s(()=>[...e[16]||(e[16]=[V("批量删除",-1)])]),_:1}),t(J,{direction:"vertical"}),t(C,{link:"",onClick:e[3]||(e[3]=o=>u.value=[])},{default:s(()=>[...e[17]||(e[17]=[V("取消选择",-1)])]),_:1})])):L("",!0),u.value.length>0?(d(),O(J,{key:1,direction:"vertical"})):L("",!0),t(C,{onClick:be,loading:X.value,icon:x(Be)},{default:s(()=>[...e[18]||(e[18]=[V("R2 同步",-1)])]),_:1},8,["loading","icon"]),t(C,{type:"primary",onClick:e[4]||(e[4]=o=>B.value=!0),icon:x(Te)},{default:s(()=>[...e[19]||(e[19]=[V("上传图片",-1)])]),_:1},8,["icon"])])]),te((d(),m("div",ct,[v.value.length===0?(d(),m("div",mt,[t(Y,{description:"暂无图片"})])):(d(),m("div",pt,[(d(!0),m(G,null,K(v.value,o=>(d(),m("div",{key:o.id,class:Z(["grid-item",{selected:u.value.includes(o.id)}]),onClick:Q=>h(o.id)},[i("div",vt,[t(H,{src:o.url,fit:"cover",loading:"lazy",class:"real-image"},null,8,["src"]),i("div",ft,[i("div",gt,[t(C,{circle:"",size:"small",icon:x(Ae),onClick:ee(Q=>Ce(o.url),["stop"])},null,8,["icon","onClick"]),t(C,{circle:"",size:"small",type:"primary",icon:x(Me),onClick:ee(Q=>W(o),["stop"])},null,8,["icon","onClick"]),t(C,{circle:"",size:"small",type:"danger",icon:x(Oe),onClick:ee(Q=>ke(o),["stop"])},null,8,["icon","onClick"])])]),u.value.includes(o.id)?(d(),m("div",yt,[t(T,null,{default:s(()=>[t(x(Fe))]),_:1})])):L("",!0)]),i("div",wt,[i("div",{class:"img-name",title:o.name},M(o.name),9,kt),i("div",Vt,[o.category?(d(),m("span",bt,M(o.category.name),1)):L("",!0),i("span",ht,M(Ee(o.created_at)),1)])])],10,_t))),128))]))])),[[me,S.value]]),v.value.length>0?(d(),m("div",Ct,[t(j,{background:"",layout:"total, prev, pager, next",total:v.value.length,"page-size":50,"hide-on-single-page":""},null,8,["total"])])):L("",!0)]),t(Je,{modelValue:U.value,"onUpdate:modelValue":e[5]||(e[5]=o=>U.value=o),onChange:b},null,8,["modelValue"]),t(We,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=o=>B.value=o),categories:g.value,onSuccess:he},null,8,["modelValue","categories"]),t(ce,{modelValue:$.value,"onUpdate:modelValue":e[10]||(e[10]=o=>$.value=o),title:"编辑图片信息",width:"400px","append-to-body":"","z-index":2e3},{footer:s(()=>[i("span",Et,[t(C,{onClick:e[9]||(e[9]=o=>$.value=!1)},{default:s(()=>[...e[20]||(e[20]=[V("取消",-1)])]),_:1}),t(C,{type:"primary",onClick:k},{default:s(()=>[...e[21]||(e[21]=[V("保存",-1)])]),_:1})])]),default:s(()=>[t(ue,{model:f,"label-width":"80px"},{default:s(()=>[t(P,{label:"名称"},{default:s(()=>[t(F,{modelValue:f.name,"onUpdate:modelValue":e[7]||(e[7]=o=>f.name=o)},null,8,["modelValue"])]),_:1}),t(P,{label:"分类"},{default:s(()=>[t(A,{modelValue:f.category_id,"onUpdate:modelValue":e[8]||(e[8]=o=>f.category_id=o),style:{width:"100%"}},{default:s(()=>[(d(!0),m(G,null,K(g.value,o=>(d(),O(_,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(ce,{modelValue:r.value,"onUpdate:modelValue":e[11]||(e[11]=o=>r.value=o),width:"800px","custom-class":"preview-dialog","append-to-body":""},{default:s(()=>[i("img",{src:a.value,style:{"max-width":"100%","max-height":"600px",display:"block",margin:"0 auto"}},null,8,It)]),_:1},8,["modelValue"])])}}}),So=ne(xt,[["__scopeId","data-v-18ec3e70"]]);export{So as default};
