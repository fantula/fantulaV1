const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BT0O4NXn.js","./gYbOYKrZ.js","./entry.DI7xQWfr.css"])))=>i.map(i=>d[i]);
import{f as xe,r as h,am as G,g as Z,h as Ue,c as n,a as t,b as s,w as o,l as U,i as J,aU as ee,D as f,t as p,d as _,E as Pe,C as Te,a1 as ze,o as i,a2 as Ae,G as A,F as R,k as B,b2 as Re,p as Be,ek as De,el as $e,T as Me,b1 as Ne,em as Oe,n as ne,dM as de,B as S,ax as je,_ as Fe}from"./gYbOYKrZ.js";import{E as Ke}from"./CswOF4xx.js";import{E as qe,a as Le}from"./DHvcgjJz.js";import{a as Ge,E as Je}from"./CdHOYNgq.js";import{E as We,a as Xe}from"./A8Zj-15Y.js";import{E as Ye}from"./BPU0QgcX.js";import{E as He}from"./B94kvl1B.js";import{E as Qe}from"./CzVV9LeR.js";import{E as Ze}from"./DrogL690.js";import{E as et}from"./CrM0zeZk.js";import{E as tt}from"./CxsxdZaY.js";import{E as st}from"./BO6-pa8Z.js";import{E as lt}from"./qZy57oqE.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{a as at,b as re,c as te}from"./9gheNwfe.js";import{v as ot}from"./CUySdIcD.js";import{a as it}from"./DMMqLNeM.js";import"./D4AXxtJy.js";import"./Dnj8X3EN.js";import"./BB_Ol6Sd.js";import"./CoqpTYH6.js";import"./CqTJWtX6.js";import"./CaswxL1d.js";import"./BdJc3h2o.js";import"./C3yI_83l.js";import"./BlcygIWm.js";import"./Bh6H2ams.js";import"./CUkNyi1D.js";import"./BSx1rCp4.js";import"./Cq9Fpw4b.js";import"./BxcDqkou.js";import"./B-n2-D39.js";import"./Cr8dt13I.js";import"./C5EOtA6j.js";import"./DxwfhIR6.js";import"./BYT9QUPE.js";import"./CrRq4wwb.js";import"./YvAJPawC.js";import"./pxhmPWjv.js";import"./MkrgA_tt.js";import"./BNtqh2Az.js";import"./Djfz0t-N.js";import"./BPYHQo7_.js";import"./DEN0lkI5.js";import"./D6FW0B1r.js";import"./C6CbiQn9.js";import"./B9zwl8KS.js";const nt={class:"cdk-post-page"},dt={class:"wizard-header"},rt={class:"header-left"},ut={class:"header-center"},ct={class:"wizard-body"},pt={class:"centered-container"},mt={class:"step-content"},vt={class:"form-card"},_t={style:{float:"left"}},ft={style:{float:"right",color:"#8492a6","font-size":"13px"}},kt={key:0},gt={key:1},yt={key:2},bt={class:"step-content"},ht={class:"form-card"},Ct={class:"card-title"},wt={key:0},It={class:"dynamic-fields"},Vt={key:1},St={class:"kv-list"},Et={key:2},xt={class:"card-actions"},Ut={key:0,class:"parse-tip"},Pt={key:0,class:"parse-dashboard"},Tt={class:"stat-item success"},zt={class:"num"},At={class:"stat-item warning"},Rt={class:"num"},Bt={class:"stat-item danger"},Dt={class:"num"},$t={class:"common-section"},Mt=["src"],Nt={key:1,class:"placeholder"},Ot={class:"step-content"},jt={class:"form-card confirmation-card"},Ft={class:"success-icon"},Kt={class:"summary-box"},qt={class:"summary-item"},Lt={class:"value"},Gt={class:"summary-item"},Jt={class:"value"},Wt={class:"summary-item"},Xt={class:"value"},Yt={key:0},Ht={class:"summary-item"},Qt={class:"value"},Zt={class:"summary-item"},es={class:"value"},ts={key:1},ss={class:"summary-item"},ls={class:"value"},as={class:"summary-item"},os={class:"value"},is={key:2},ns={class:"summary-item"},ds={class:"value highlight"},rs={class:"wizard-footer"},us={class:"picker-container"},cs={class:"picker-sidebar"},ps=["onClick"],ms={class:"picker-main"},vs={class:"picker-toolbar"},_s={class:"picker-grid"},fs=["onClick"],ks={class:"picker-img-name"},gs=xe({__name:"post",setup(ys){const se=Te(),le=ze(),C=h(0),M=h(!1),ae=h([]),W=h([]),X=h(!1),P=h([]),u=G({categoryId:"",productId:"",skuIds:[]}),ue={virtual:"virtual",shared:"shared_account",one_time:"one_time_cdk"},m=Z(()=>{const a=le.query.type;return ue[a]||"virtual"}),ce=Z(()=>u.categoryId?W.value.filter(a=>a.category_id===u.categoryId):[]),D=Z(()=>W.value.find(a=>a.id===u.productId)),w=G({stock:10,fields:["邮箱"]}),k=G({maxSlots:5,attributes:[{key:"账号",value:""},{key:"密码",value:""}]}),T=G({rawContent:""}),Y=h(!1),v=h(null),pe=()=>{v.value=null},me=async()=>{if(T.rawContent){Y.value=!0;try{const a=T.rawContent.split(`
`).map(d=>d.trim()).filter(d=>d),e=[...new Set(a)],c=u.skuIds.length>0?u.skuIds:P.value.map(d=>d.id);let r=new Set;if(c.length>0){const{data:d}=await de().from("cdk_sku_map").select("cdk:cdks!inner(code, cdk_type)").in("sku_id",c).eq("cdk.cdk_type","one_time");d&&(r=new Set(d.map(I=>I.cdk?.code).filter(Boolean)))}const E=[],g=[],y=[];e.forEach(d=>{d.length<4?y.push(d):r.has(d)?g.push(d):E.push(d)});const b=a.length-e.length;b>0&&S.info(`已自动去除 ${b} 条重复输入`),v.value={valid:E,duplicates:g,invalid:y}}catch{S.error("解析校验失败，请重试"),v.value=null}finally{Y.value=!1}}},N=h("");Ue(async()=>{const[a,e]=await Promise.all([at.getCategories(),re.getProducts()]);a.success&&(ae.value=a.categories),e.success&&(W.value=e.products)});const ve=()=>{u.productId="",u.skuIds=[],P.value=[]},_e=async a=>{if(u.skuIds=[],P.value=[],!!a){X.value=!0;try{const e=await re.getProductWithSkus(a);if(e.success&&e.skus){const c=m.value,r=e.skus.filter(g=>g.product_type===c);let E=r;if(c==="virtual"){const{data:g}=await de().from("cdk_sku_map").select("sku_id, cdk:cdks!inner(cdk_type)").eq("cdk.cdk_type","virtual"),y=new Set((g||[]).map(b=>b.sku_id));E=r.filter(b=>!y.has(b.id))}P.value=E.map(g=>{const y=Object.values(g.spec_combination||{}).join(" ");return{id:g.id,label:y||"默认规格"}})}}finally{X.value=!1}v.value=null,T.rawContent="",k.maxSlots=5,k.attributes.splice(0,k.attributes.length,{key:"账号",value:""},{key:"密码",value:""})}},j=a=>({virtual:"虚拟充值",shared_account:"账号/合租",one_time_cdk:"激活码"})[a]||a||"-",fe=()=>w.fields.push(""),ke=a=>w.fields.splice(a,1),F=h(!1),O=h(!1),H=h([]),Q=h([]),$=h(""),ge=async()=>{if(F.value=!0,Q.value.length===0){const a=await te.imageCategory.getCategories();a.success&&(Q.value=a.categories)}K()},K=async()=>{O.value=!0;const a=await te.image.getImages({category_id:$.value});a.success&&(H.value=a.images),O.value=!1},oe=a=>{N.value=a,F.value=!1,S.success("已选择图片")},ye=async a=>{O.value=!0;try{const{uploadImageToStorage:e}=await je(async()=>{const{uploadImageToStorage:r}=await import("./BT0O4NXn.js");return{uploadImageToStorage:r}},__vite__mapDeps([0,1,2]),import.meta.url),c=await e(a.raw);c.success&&(await te.image.createImage({name:a.name,url:c.url,category_id:$.value||void 0}),oe(c.url),K())}finally{O.value=!1}},be=()=>{ge()},he=async()=>{if(C.value===0){if(!u.productId)return S.warning("请先选择商品");C.value=1}else if(C.value===1){if(m.value==="shared_account"&&k.attributes.some(a=>!a.key||!a.value))return S.warning("请补全所有账号资源的字段名称与内容");if(m.value==="one_time_cdk"){if(!v.value)return S.warning("请先点击解析并校验激活码");if(v.value.valid.length===0)return S.warning("没有可用的有效激活码，请检查输入")}C.value=2}else{M.value=!0;try{const a=m.value,c={virtual:"virtual",shared_account:"shared",one_time_cdk:"one_time"}[a||""]||"one_time";let r=[],E=N.value?{image:N.value}:void 0;if(a==="one_time_cdk")r=v.value?.valid||[];else if(a==="virtual"){const I={fields:w.fields.filter(V=>V.trim())};r=[JSON.stringify(I)]}else if(a==="shared_account"){const I={};k.attributes.forEach(V=>{V.key&&(I[V.key]=V.value)}),r=[JSON.stringify(I)]}if(r.length===0){S.warning("没有可添加的资源"),M.value=!1;return}let g=u.skuIds.length>0?u.skuIds:P.value.map(I=>I.id);if(g.length===0){S.warning("该商品没有可用的 SKU，请先创建 SKU"),M.value=!1;return}let y=0,b=[];const d=await it.createCdks({sku_ids:g,cdk_type:c,codes:r,max_slots:a==="shared_account"?k.maxSlots:1,stock:a==="virtual"?w.stock:1,account_data:E,product_snapshot:D.value?{product_id:D.value.id,product_name:D.value.product_name,product_image:D.value.image||void 0}:void 0});if(d.success?y+=d.count:b.push(d.error||"未知错误"),y>0){S.success(`成功添加 ${y} 条资源`);const V={virtual:"virtual",shared:"accounts",one_time:"keys"}[le.query.type]||"virtual";se.push(`/_mgmt_9Xfa3/cdk/${V}`)}else b.length>0&&S.error(b[0])}catch(a){S.error(a.message||"添加失败")}finally{M.value=!1}}},Ce=()=>{C.value>0&&C.value--};return(a,e)=>{const c=Pe,r=Ke,E=Le,g=qe,y=Je,b=Ge,d=Xe,I=Ye,V=We,ie=He,q=Qe,L=Ze,we=et,Ie=tt,Ve=st,Se=lt,Ee=ot;return i(),n("div",nt,[t("div",dt,[t("div",rt,[s(r,{link:"",class:"back-btn",onClick:e[0]||(e[0]=l=>U(se).back())},{default:o(()=>[s(c,{class:"back-icon"},{default:o(()=>[s(U(Ae))]),_:1}),e[10]||(e[10]=_(" 返回列表 ",-1))]),_:1}),e[11]||(e[11]=t("div",{class:"header-titles"},[t("div",{class:"main-title"},"添加资源"),t("div",{class:"sub-title"},"ADD RESOURCES")],-1))]),t("div",ut,[s(g,{active:C.value,"finish-status":"success",simple:"",style:{width:"100%",background:"transparent"}},{default:o(()=>[s(E,{title:"选择商品"}),s(E,{title:"配置资源"}),s(E,{title:"确认添加"})]),_:1},8,["active"])]),e[12]||(e[12]=t("div",{class:"header-right"},null,-1))]),t("div",ct,[t("div",pt,[J(t("div",mt,[t("div",vt,[e[13]||(e[13]=t("h3",{class:"card-title"},"基础信息",-1)),s(V,{model:u,"label-position":"top"},{default:o(()=>[s(d,{label:"商品分类"},{default:o(()=>[s(b,{modelValue:u.categoryId,"onUpdate:modelValue":e[1]||(e[1]=l=>u.categoryId=l),placeholder:"请选择分类",filterable:"",onChange:ve,size:"large",style:{width:"100%"}},{default:o(()=>[(i(!0),n(R,null,B(ae.value,l=>(i(),A(y,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(d,{label:"选择商品"},{default:o(()=>[s(b,{modelValue:u.productId,"onUpdate:modelValue":e[2]||(e[2]=l=>u.productId=l),placeholder:"请选择商品",filterable:"",onChange:_e,size:"large",style:{width:"100%"},disabled:!u.categoryId},{default:o(()=>[(i(!0),n(R,null,B(ce.value,l=>(i(),A(y,{key:l.id,label:l.product_name,value:l.id},{default:o(()=>[t("span",_t,p(l.product_name),1),t("span",ft,p(j(l.product_type)),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),s(d,{label:"关联 SKU (可多选)"},{default:o(()=>[s(b,{modelValue:u.skuIds,"onUpdate:modelValue":e[3]||(e[3]=l=>u.skuIds=l),multiple:"",placeholder:"该资源将应用于哪些 SKU",size:"large",style:{width:"100%"},disabled:!u.productId,loading:X.value},{default:o(()=>[(i(!0),n(R,null,B(P.value,l=>(i(),A(y,{key:l.id,label:l.label,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"])]),_:1}),D.value?(i(),A(I,{key:0,title:`当前资源类型: ${j(m.value)}`,type:"info","show-icon":"",closable:!1,style:{"margin-top":"20px"}},{default:o(()=>[m.value==="virtual"?(i(),n("div",kt,"系统将引导您配置库存数量与订单填写字段。")):f("",!0),m.value==="shared_account"?(i(),n("div",gt,"系统将引导您输入账号密码及最大并发数。")):f("",!0),m.value==="one_time_cdk"?(i(),n("div",yt,"系统将引导您批量导入激活码内容。")):f("",!0)]),_:1},8,["title"])):f("",!0)]),_:1},8,["model"])])],512),[[ee,C.value===0]]),J(t("div",bt,[t("div",ht,[t("h3",Ct,"资源配置: "+p(j(m.value)),1),m.value==="virtual"?(i(),n("div",wt,[s(V,{model:w,"label-position":"top"},{default:o(()=>[s(d,{label:"可用库存数"},{default:o(()=>[s(ie,{modelValue:w.stock,"onUpdate:modelValue":e[4]||(e[4]=l=>w.stock=l),min:1,size:"large",style:{width:"100%"}},null,8,["modelValue"]),e[14]||(e[14]=t("div",{class:"form-tip"},"设置该资源的可用服务位数量 (如 GPT KEY 的并发上限)",-1))]),_:1}),s(q,{"content-position":"left"},{default:o(()=>[...e[15]||(e[15]=[_("订单填写字段配置",-1)])]),_:1}),t("div",It,[(i(!0),n(R,null,B(w.fields,(l,x)=>(i(),n("div",{key:x,class:"field-row"},[s(L,{modelValue:w.fields[x],"onUpdate:modelValue":z=>w.fields[x]=z,placeholder:"输入字段名 (如: 游戏账号)"},null,8,["modelValue","onUpdate:modelValue"]),s(r,{type:"danger",circle:"",plain:"",onClick:z=>ke(x)},{default:o(()=>[s(c,null,{default:o(()=>[s(U(Re))]),_:1})]),_:1},8,["onClick"])]))),128)),s(r,{type:"dashed",class:"add-field-btn",onClick:fe},{default:o(()=>[s(c,null,{default:o(()=>[s(U(Be))]),_:1}),e[16]||(e[16]=_(" 添加字段 ",-1))]),_:1}),e[17]||(e[17]=t("div",{class:"form-tip"},"用户下单时需要填写的辅助信息字段。",-1))])]),_:1},8,["model"])])):f("",!0),m.value==="shared_account"?(i(),n("div",Vt,[s(V,{"label-position":"top"},{default:o(()=>[s(d,{label:"最大车位数"},{default:o(()=>[s(ie,{modelValue:k.maxSlots,"onUpdate:modelValue":e[5]||(e[5]=l=>k.maxSlots=l),min:1,max:10,"controls-position":"right"},null,8,["modelValue"]),e[18]||(e[18]=t("div",{class:"form-tip"},"决定该资源可同时服务的用户数",-1))]),_:1}),s(q,{"content-position":"left"},{default:o(()=>[...e[19]||(e[19]=[_("属性配置",-1)])]),_:1}),t("div",St,[(i(!0),n(R,null,B(k.attributes,(l,x)=>(i(),n("div",{key:x,class:"kv-row"},[s(L,{modelValue:l.key,"onUpdate:modelValue":z=>l.key=z,placeholder:"字段名(如:账号)",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"]),e[20]||(e[20]=t("span",{class:"separator"},":",-1)),s(L,{modelValue:l.value,"onUpdate:modelValue":z=>l.value=z,placeholder:"字段值",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"]),k.attributes.length>1?(i(),A(r,{key:0,circle:"",plain:"",size:"small",onClick:z=>k.attributes.splice(x,1)},{default:o(()=>[s(c,null,{default:o(()=>[s(U(De))]),_:1})]),_:1},8,["onClick"])):f("",!0)]))),128)),s(r,{type:"dashed",size:"small",class:"add-attr-btn",onClick:e[6]||(e[6]=l=>k.attributes.push({key:"",value:""}))},{default:o(()=>[...e[21]||(e[21]=[_(" + 添加属性 ",-1)])]),_:1})])]),_:1})])):f("",!0),m.value==="one_time_cdk"?(i(),n("div",Et,[s(V,{model:T,"label-position":"top"},{default:o(()=>[s(d,{label:"批量输入卡密"},{default:o(()=>[s(L,{modelValue:T.rawContent,"onUpdate:modelValue":e[7]||(e[7]=l=>T.rawContent=l),type:"textarea",rows:8,placeholder:`支持直接粘贴，自动去重过滤。
AAAA-BBBB-CCCC
1111-2222-3333`,onInput:pe},null,8,["modelValue"])]),_:1}),t("div",xt,[s(r,{type:"primary",onClick:me,loading:Y.value,disabled:!T.rawContent},{default:o(()=>[s(c,null,{default:o(()=>[s(U($e))]),_:1}),e[22]||(e[22]=_(" 解析并校验 ",-1))]),_:1},8,["loading","disabled"]),v.value?f("",!0):(i(),n("span",Ut,"未解析，请先点击解析按钮"))]),s(Me,{name:"el-zoom-in-top"},{default:o(()=>[v.value?(i(),n("div",Pt,[t("div",Tt,[t("span",zt,p(v.value.valid.length),1),e[23]||(e[23]=t("span",{class:"label"},"可用数量",-1))]),t("div",At,[t("span",Rt,p(v.value.duplicates.length),1),e[24]||(e[24]=t("span",{class:"label"},"重复/库存已存",-1))]),t("div",Bt,[t("span",Dt,p(v.value.invalid.length),1),e[25]||(e[25]=t("span",{class:"label"},"格式无效",-1))])])):f("",!0)]),_:1}),v.value&&v.value.valid.length>0?(i(),A(I,{key:0,title:"解析完成",type:"success",closable:!1,"show-icon":"",style:{"margin-top":"16px"}},{default:o(()=>[_(" 将仅入库 "+p(v.value.valid.length)+" 条有效卡密。重复与无效项将被忽略。 ",1)]),_:1})):f("",!0)]),_:1},8,["model"])])):f("",!0),s(q),t("div",$t,[e[27]||(e[27]=t("span",{class:"section-label"},"详情页帮助图片 (可选)",-1)),t("div",{class:"image-selector",onClick:be},[N.value?(i(),n("img",{key:0,src:N.value,class:"preview-img"},null,8,Mt)):(i(),n("div",Nt,[s(c,null,{default:o(()=>[s(U(Ne))]),_:1}),e[26]||(e[26]=t("span",null,"选择图片",-1))]))])])])],512),[[ee,C.value===1]]),J(t("div",Ot,[t("div",jt,[t("div",Ft,[s(c,null,{default:o(()=>[s(U(Oe))]),_:1})]),e[42]||(e[42]=t("h2",null,"准备就绪",-1)),e[43]||(e[43]=t("p",null,"请确认以下信息无误后提交",-1)),t("div",Kt,[t("div",qt,[e[28]||(e[28]=t("span",{class:"label"},"商品:",-1)),t("span",Lt,p(D.value?.product_name),1)]),t("div",Gt,[e[29]||(e[29]=t("span",{class:"label"},"SKU:",-1)),t("span",Jt,p(P.value.filter(l=>u.skuIds.includes(l.id)).map(l=>l.label).join(", ")||"通用"),1)]),t("div",Wt,[e[30]||(e[30]=t("span",{class:"label"},"类型:",-1)),t("span",Xt,p(j(m.value)),1)]),s(q),m.value==="virtual"?(i(),n("div",Yt,[t("div",Ht,[e[31]||(e[31]=t("span",{class:"label"},"新增库存:",-1)),e[32]||(e[32]=_()),t("span",Qt,p(w.stock),1)]),t("div",Zt,[e[33]||(e[33]=t("span",{class:"label"},"配置字段:",-1)),e[34]||(e[34]=_()),t("span",es,p(w.fields.join(", ")||"无"),1)])])):f("",!0),m.value==="shared_account"?(i(),n("div",ts,[t("div",ss,[e[35]||(e[35]=t("span",{class:"label"},"最大车位数:",-1)),e[36]||(e[36]=_()),t("span",ls,p(k.maxSlots),1)]),t("div",as,[e[37]||(e[37]=t("span",{class:"label"},"属性字段:",-1)),e[38]||(e[38]=_()),t("span",os,p(k.attributes.map(l=>l.key).join("/")),1)])])):f("",!0),m.value==="one_time_cdk"?(i(),n("div",is,[t("div",ns,[e[39]||(e[39]=t("span",{class:"label"},"有效激活码:",-1)),e[40]||(e[40]=_()),t("span",ds,p(v.value?.valid?.length||0),1),e[41]||(e[41]=_(" 条",-1))])])):f("",!0)])])],512),[[ee,C.value===2]])])]),t("div",rs,[s(r,{size:"large",onClick:Ce,disabled:C.value===0},{default:o(()=>[...e[44]||(e[44]=[_("上一步",-1)])]),_:1},8,["disabled"]),s(r,{type:"primary",size:"large",class:"next-btn",onClick:he,loading:M.value},{default:o(()=>[_(p(C.value===2?"确认添加":"下一步"),1)]),_:1},8,["loading"])]),s(Se,{modelValue:F.value,"onUpdate:modelValue":e[9]||(e[9]=l=>F.value=l),title:"图库选择",width:"800px","append-to-body":"","destroy-on-close":"",class:"picker-dialog"},{default:o(()=>[t("div",us,[t("div",cs,[t("div",{class:ne(["picker-cat-item",{active:$.value===""}]),onClick:e[8]||(e[8]=l=>{$.value="",K()})},"全部图片",2),(i(!0),n(R,null,B(Q.value,l=>(i(),n("div",{key:l.id,class:ne(["picker-cat-item",{active:$.value===l.id}]),onClick:x=>{$.value=l.id,K()}},p(l.name),11,ps))),128))]),J((i(),n("div",ms,[t("div",vs,[s(we,{action:"#","auto-upload":!1,"show-file-list":!1,"on-change":ye},{default:o(()=>[s(r,{type:"primary",size:"small"},{default:o(()=>[...e[45]||(e[45]=[_("上传新图片",-1)])]),_:1})]),_:1})]),t("div",_s,[(i(!0),n(R,null,B(H.value,l=>(i(),n("div",{key:l.id,class:"picker-img-card",onClick:x=>oe(l.url)},[s(Ie,{src:l.url,fit:"cover"},null,8,["src"]),t("div",ks,p(l.name),1)],8,fs))),128))]),H.value.length===0?(i(),A(Ve,{key:0,description:"暂无图片"})):f("",!0)])),[[Ee,O.value]])])]),_:1},8,["modelValue"])])}}}),El=Fe(gs,[["__scopeId","data-v-6f09973b"]]);export{El as default};
