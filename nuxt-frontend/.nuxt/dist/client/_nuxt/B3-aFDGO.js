import{f as A,r as u,h as D,aj as I,ab as F,c as N,a as t,b as i,n as O,G as d,w as n,t as h,B as r,E as P,o as c,l as w,H as U,eF as V,d as m,eG as G,i as H,a_ as M,_ as q}from"./gYbOYKrZ.js";import{E as J}from"./CswOF4xx.js";import{a as K,E as Q}from"./Dj2lpOJg.js";import{E as W}from"./BxcDqkou.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{A as x}from"./Ng33ccKC.js";import{v as X}from"./CUySdIcD.js";import"./D4AXxtJy.js";import"./Dnj8X3EN.js";import"./BSx1rCp4.js";import"./Cq9Fpw4b.js";import"./BdJc3h2o.js";import"./C3yI_83l.js";import"./CaswxL1d.js";import"./BlcygIWm.js";import"./Bh6H2ams.js";import"./CUkNyi1D.js";import"./pxhmPWjv.js";import"./-tO7MSA0.js";import"./CrRq4wwb.js";import"./C5EOtA6j.js";import"./BPYHQo7_.js";import"./Cr8dt13I.js";import"./DtgOm6Sf.js";import"./BB_Ol6Sd.js";import"./BYT9QUPE.js";import"./CzVV9LeR.js";/* empty css        */const p="http://localhost:3001",g={async getStatus(){try{return await(await fetch(`${p}/status`)).json()}catch(a){return console.error("Failed to get scheduler status:",a),{isRunning:!1,lastRun:null,lastResult:null}}},async getLogs(a=20){try{return await(await fetch(`${p}/logs?limit=${a}`)).json()}catch(o){return console.error("Failed to get scheduler logs:",o),{success:!1,logs:[]}}},async start(){try{return await(await fetch(`${p}/start`,{method:"POST"})).json()}catch(a){return{success:!1,message:a.message}}},async stop(){try{return await(await fetch(`${p}/stop`,{method:"POST"})).json()}catch(a){return{success:!1,message:a.message}}},async runTask(a){try{return await(await fetch(`${p}/run/${a}`,{method:"POST"})).json()}catch(o){return{success:!1,error:o.message}}}},Y={class:"scheduler-page"},Z={class:"status-grid"},ss={class:"icon-wrapper"},ts={class:"info"},es={class:"value"},as={class:"actions"},os={class:"status-card info"},ns={class:"info-item"},is={class:"value"},ls={class:"tasks-grid"},rs={class:"task-item"},cs=A({__name:"scheduler",setup(a){const o=u({isRunning:!1,lastRun:null,lastResult:null}),T=u([]),f=u(!1),_=u(!1),k=u(""),b=async()=>{const e=await g.getStatus();o.value=e},E=async()=>{_.value=!0;try{const e=await g.getLogs();e.success&&(T.value=e.logs)}finally{_.value=!1}},C=async e=>{f.value=!0;try{const s=e?await g.start():await g.stop();s.success?(r.success(e?"服务已启动":"服务已停止"),await b()):r.warning(s.message||"操作失败")}catch(s){r.error("操作异常: "+s.message)}finally{f.value=!1}},L=async e=>{k.value=e;try{const s=await g.runTask(e);s.success?(r.success(`执行完成，处理 ${s.expired_count||0} 条数据`),await E()):r.error(s.error||"执行失败")}catch(s){r.error("执行异常: "+s.message)}finally{k.value=""}},S=e=>e?new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-";let R=null;return D(()=>{b(),E(),R=I(b,3e4)}),F(()=>{R&&clearInterval(R)}),(e,s)=>{const $=P,v=J,y=Q,j=W,B=K,z=X;return c(),N("div",Y,[t("div",Z,[t("div",{class:O(["status-card",{active:o.value.isRunning}])},[t("div",ss,[o.value.isRunning?(c(),d($,{key:0,class:"rotating"},{default:n(()=>[i(w(U))]),_:1})):(c(),d($,{key:1},{default:n(()=>[i(w(V))]),_:1}))]),t("div",ts,[s[3]||(s[3]=t("div",{class:"label"},"服务状态",-1)),t("div",es,h(o.value.isRunning?"运行中":"已停止"),1)]),t("div",as,[o.value.isRunning?(c(),d(v,{key:1,type:"danger",size:"small",onClick:s[1]||(s[1]=l=>C(!1)),loading:f.value},{default:n(()=>[...s[5]||(s[5]=[m("停止服务",-1)])]),_:1},8,["loading"])):(c(),d(v,{key:0,type:"success",size:"small",onClick:s[0]||(s[0]=l=>C(!0)),loading:f.value},{default:n(()=>[...s[4]||(s[4]=[m("启动服务",-1)])]),_:1},8,["loading"]))])],2),t("div",os,[t("div",ns,[s[6]||(s[6]=t("div",{class:"label"},"上次执行",-1)),t("div",is,h(S(o.value.lastRun)),1)]),s[7]||(s[7]=t("div",{class:"info-divider"},null,-1)),s[8]||(s[8]=t("div",{class:"info-item"},[t("div",{class:"label"},"执行频率"),t("div",{class:"value"},"每 5 分钟")],-1))])]),i(x,{title:"手动触发任务",class:"mt-4"},{default:n(()=>[t("div",ls,[t("div",rs,[s[10]||(s[10]=t("div",{class:"task-meta"},[t("span",{class:"task-name"},"清理过期预订单"),t("span",{class:"task-desc"},"检测并释放超时的待支付订单库存")],-1)),i(v,{type:"primary",plain:"",icon:w(G),onClick:s[2]||(s[2]=l=>L("cleanup_expired_preorders")),loading:k.value==="cleanup_expired_preorders"},{default:n(()=>[...s[9]||(s[9]=[m("执行",-1)])]),_:1},8,["icon","loading"])])])]),_:1}),i(x,{title:"执行日志",class:"mt-4"},{"header-actions":n(()=>[i(v,{icon:w(M),circle:"",onClick:E,loading:_.value},null,8,["icon","loading"])]),default:n(()=>[H((c(),d(B,{data:T.value,style:{width:"100%"},stripe:""},{default:n(()=>[i(y,{label:"执行时间",width:"200"},{default:n(({row:l})=>[m(h(S(l.executed_at)),1)]),_:1}),i(y,{prop:"task_name",label:"任务名称"}),i(y,{label:"状态",width:"100"},{default:n(({row:l})=>[i(j,{type:l.status==="success"?"success":"danger",size:"small"},{default:n(()=>[m(h(l.status==="success"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),i(y,{prop:"affected_count",label:"处理数量",width:"120",align:"right"})]),_:1},8,["data"])),[[z,_.value]])]),_:1})])}}}),Hs=q(cs,[["__scopeId","data-v-fa174296"]]);export{Hs as default};
