import{dM as u}from"./o2XBa361.js";const _={async getCdks(s){let e=u().from("cdks").select(`
                *,
                sku_mappings:cdk_sku_map(id, sku_id, sku:product_skus(id, spec_combination, price, product_type)),
                slot_occupancies(id, slot_index, status)
            `,{count:"exact"});if(s?.cdk_type&&(e=e.eq("cdk_type",s.cdk_type)),s?.status&&(e=e.eq("status",s.status)),e=e.order("created_at",{ascending:!1}),s?.limit){const n=s.offset||0;e=e.range(n,n+s.limit-1)}const{data:c,error:r,count:l}=await e;return r?{success:!1,cdks:[],total:0,error:r.message}:{success:!0,cdks:c||[],total:l||0}},async createCdks(s){const t=u();if(s.cdk_type==="virtual"){const{data:o}=await t.from("cdk_sku_map").select("sku_id, cdk:cdks!inner(id, cdk_type)").in("sku_id",s.sku_ids).eq("cdk.cdk_type","virtual");if(o&&o.length>0)return{success:!1,count:0,error:"存在 SKU 已有虚拟库存资源，请在 CDK 列表中编辑现有资源"}}let e=[];const c=s.product_snapshot||null;s.cdk_type==="shared"?e=s.codes.map(o=>({code:o,cdk_type:s.cdk_type,max_slots:s.max_slots||1,stock:1,account_data:s.account_data||null,status:"idle",product_snapshot:c})):s.cdk_type==="virtual"?e=[{code:s.codes[0]||`VIRTUAL-${Date.now()}`,cdk_type:s.cdk_type,max_slots:1,stock:s.stock||1,account_data:s.account_data||null,status:"idle",product_snapshot:c}]:e=s.codes.map(o=>({code:o,cdk_type:s.cdk_type,max_slots:1,stock:1,account_data:s.account_data||null,status:"idle",product_snapshot:c}));const{data:r,error:l}=await t.from("cdks").insert(e).select("id");if(l)return{success:!1,count:0,error:l.message};const n=[];for(const o of r||[])for(const a of s.sku_ids)n.push({cdk_id:o.id,sku_id:a});if(n.length>0){const{error:o}=await t.from("cdk_sku_map").insert(n);if(o)return console.error("CDK SKU 映射创建失败:",o),{success:!0,count:r?.length||0,error:`CDK 已创建但 SKU 映射失败: ${o.message}`}}if(s.cdk_type==="shared"&&r&&r.length>0){const o=Math.min(Math.max(s.max_slots||1,1),10),a=[];for(const d of r)for(let i=1;i<=o;i++)a.push({cdk_id:d.id,slot_index:i,status:"idle"});if(a.length>0){const{error:d}=await t.from("slot_occupancies").insert(a);if(d)return console.error("槽位记录创建失败:",d),{success:!0,count:r?.length||0,error:`CDK 已创建但槽位创建失败: ${d.message}`}}}return{success:!0,count:r?.length||0}},async deleteCdk(s){const t=u(),{data:e}=await t.from("cdks").select("status").eq("id",s).single();if(e?.status!=="idle")return{success:!1,error:"只能删除未使用的 CDK"};const{count:c}=await t.from("order_deliveries").select("*",{count:"exact",head:!0}).eq("cdk_id",s);if(c&&c>0)return{success:!1,error:`无法删除：有 ${c} 笔订单关联到此 CDK`};const{error:r}=await t.from("cdks").delete().eq("id",s);return r?{success:!1,error:r.message}:{success:!0}},async deleteCdks(s){if(!s.length)return{success:!0,count:0};const t=u(),{error:e,count:c}=await t.from("cdks").delete({count:"exact"}).in("id",s).eq("status","idle");return e?{success:!1,count:0,error:e.message}:{success:!0,count:c||0}},async enableCdk(s){const t=u(),{data:e}=await t.from("cdks").select("status").eq("id",s).single();if(e?.status!=="disabled")return{success:!1,error:"只能上架已下架的 CDK"};const{error:c}=await t.from("cdks").update({status:"idle"}).eq("id",s);return c?{success:!1,error:c.message}:{success:!0}},async disableCdk(s){const t=u(),{data:e}=await t.from("cdks").select("status").eq("id",s).single();if(e?.status!=="idle")return{success:!1,error:"只能下架空闲状态的 CDK"};const{error:c}=await t.from("cdks").update({status:"disabled"}).eq("id",s);return c?{success:!1,error:c.message}:{success:!0}},async enableCdks(s){if(!s.length)return{success:!0,count:0};const t=u(),{error:e,count:c}=await t.from("cdks").update({status:"idle"}).in("id",s).eq("status","disabled");return e?{success:!1,count:0,error:e.message}:{success:!0,count:c||0}},async disableCdks(s){if(!s.length)return{success:!0,count:0};const t=u(),{error:e,count:c}=await t.from("cdks").update({status:"disabled"}).in("id",s).eq("status","idle");return e?{success:!1,count:0,error:e.message}:{success:!0,count:c||0}},async getCdkById(s){const t=u(),{data:e,error:c}=await t.from("cdks").select("*, sku_mappings:cdk_sku_map(id, sku_id, sku:product_skus(id, spec_combination, price, product_type))").eq("id",s).single();return c?{success:!1,error:c.message}:{success:!0,cdk:e}},async updateCdk(s,t){const e=u(),{data:c}=await e.from("cdks").select("cdk_type, max_slots").eq("id",s).single();if(!c)return{success:!1,error:"CDK 不存在"};if(c.cdk_type==="shared"&&t.max_slots!==void 0){const n=Math.min(Math.max(t.max_slots,1),10),o=c.max_slots||1,{count:a}=await e.from("slot_occupancies").select("*",{count:"exact",head:!0}).eq("cdk_id",s).eq("status","occupied");if(n<(a||0))return{success:!1,error:`不能减少到 ${n}，当前已使用 ${a} 个车位`};const{count:d}=await e.from("slot_occupancies").select("*",{count:"exact",head:!0}).eq("cdk_id",s);if(!d||d===0){const i=[];for(let k=0;k<n;k++)i.push({cdk_id:s,slot_index:k,status:"idle"});i.length>0&&await e.from("slot_occupancies").insert(i)}else if(n>o){const i=[];for(let k=o;k<n;k++)i.push({cdk_id:s,slot_index:k,status:"idle"});i.length>0&&await e.from("slot_occupancies").insert(i)}n<o&&await e.from("slot_occupancies").delete().eq("cdk_id",s).gte("slot_index",n).eq("status","idle"),t.max_slots=n}const r={};if(t.max_slots!==void 0&&(r.max_slots=t.max_slots),t.code!==void 0&&(r.code=t.code),t.account_data!==void 0&&(r.account_data=t.account_data),t.stock!==void 0&&(r.stock=t.stock),t.product_snapshot!==void 0&&(r.product_snapshot=t.product_snapshot),Object.keys(r).length===0)return{success:!1,error:"没有可更新的数据"};const{error:l}=await e.from("cdks").update(r).eq("id",s);return l?{success:!1,error:l.message}:{success:!0}},async getCdkSkuMappings(s){const t=u(),{data:e,error:c}=await t.from("cdk_sku_map").select("id, sku_id, sku:product_skus(id, spec_combination, price, product_type), created_at").eq("cdk_id",s);return c?{success:!1,mappings:[],error:c.message}:{success:!0,mappings:e||[]}},async addCdkSkuMapping(s,t){const e=u();console.log("[addCdkSkuMapping] params:",{cdkId:s,skuId:t});const{data:c}=await e.from("cdk_sku_map").select("id").eq("cdk_id",s).eq("sku_id",t).maybeSingle();if(c)return console.log("[addCdkSkuMapping] Already exists, skipping"),{success:!0};const{error:r}=await e.from("cdk_sku_map").insert({cdk_id:s,sku_id:t});return console.log("[addCdkSkuMapping] Insert result:",{insertError:r}),r?{success:!1,error:r.message}:{success:!0}},async removeCdkSkuMapping(s){const t=u(),{error:e}=await t.from("cdk_sku_map").delete().eq("id",s);return e?{success:!1,error:e.message}:{success:!0}}};export{_ as a};
