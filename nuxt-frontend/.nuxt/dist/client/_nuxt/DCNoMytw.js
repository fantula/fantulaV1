import{a as le,E as ne}from"./CrjkcmUY.js";import{E as se}from"./-Yx_0iEM.js";import{E as ie}from"./Ci1VNkC9.js";import{E as re}from"./C8OXdh39.js";import{E as ue}from"./DC3lfPj1.js";import{f as de,r as m,J as me,h as pe,c as v,b as a,w as o,dM as $,o as r,l as E,a_ as ce,d as i,a as d,t as s,D as g,E as _e,H as fe,F as ve,G as b,ag as ge,B as T,_ as be}from"./o2XBa361.js";import{E as ye}from"./COgFiiev.js";import{E as he,a as Ee}from"./CvpqM1dK.js";import{E as ke}from"./Cq9RPQ5L.js";import{E as we}from"./1SfIsks3.js";import{E as xe}from"./C1T5KPmY.js";import{E as Ve}from"./CziALilw.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{P as Ce}from"./DLUP05ph.js";import{A as Te}from"./DHlfceZi.js";import{A as Ae}from"./BrR7l0bw.js";import{D as Se}from"./Demiahkb.js";import{u as Be}from"./Ce6k4emn.js";import{u as De}from"./CRWHP3jh.js";import{E as qe}from"./BfOrkIVm.js";import"./qVmxJdp3.js";import"./CqX7ZdKI.js";import"./Dlk0BVst.js";import"./DtTI1xRr.js";import"./Bh6H2ams.js";import"./t2w4jifC.js";import"./Dnj8X3EN.js";import"./ClnTspdU.js";import"./Cq9Fpw4b.js";import"./B8yeDp5P.js";import"./B_FoF6yT.js";import"./BlW_46uR.js";import"./Ds34GQx2.js";import"./Dzr5IOAO.js";import"./Culj45X8.js";import"./BB_Ol6Sd.js";import"./Z6faUBN3.js";import"./KSqZSeJ0.js";import"./CQuNCUIC.js";import"./C9zJf5rn.js";import"./Bx0EXMjc.js";import"./hXKBSGVD.js";import"./BCItYl8Z.js";import"./BHSqheQV.js";import"./DVQwC1Y0.js";import"./FKUjHIpz.js";import"./D6FW0B1r.js";import"./CleHDoLI.js";import"./DytS51kl.js";/* empty css        */import"./BOgRz4Th.js";/* empty css        *//* empty css        *//* empty css        */import"./BwD4Hz0h.js";import"./DwwA_QlG.js";const ze={class:"page-container"},Ue=["onClick"],$e={class:"user-cell"},Fe={class:"uid-text"},Ne={class:"product-cell"},je=["src"],Ie={class:"spec-text"},Re={class:"amount"},Oe={key:0,class:"discount"},Pe={key:1,class:"no-discount"},Le={key:0,class:"loading-state"},Me={class:"amount"},He={class:"amount"},Ge={key:4,class:"review-form mt-4"},Je={class:"form-row"},Ke={class:"hint"},Qe={class:"form-row"},We={key:2,class:"empty-receipt"},Xe={key:0,class:"dialog-footer-actions"},Ye=de({__name:"index",setup(Ze){const{formatPrice:F,formatDate:O}=De(),{getOrderStatusLabel:P,getOrderStatusType:L}=Be(),M=l=>P(l),H=l=>L(l),A=l=>O(l);function G(l){return l?typeof l=="string"?l:typeof l=="object"?Object.entries(l).map(([e,u])=>`${e}: ${u}`).join(" / "):"-":"-"}const D=m(!1),N=m([]),j=m(0),k=m(1),w=m(20),x=m(""),V=m(!1),q=m(!1),S=m(!1),y=m(null),n=m(null),h=m(0),B=m("");async function C(){D.value=!0;try{let e=$().from("orders").select(`
        *,
        _profile:profiles!orders_user_id_fkey(id, uid, avatar)
      `,{count:"exact"});x.value?e=e.eq("status",x.value):e=e.in("status",["refunding","refunded"]);const{data:u,error:f,count:_}=await e.order("created_at",{ascending:!1}).range((k.value-1)*w.value,k.value*w.value-1);!f&&u&&(N.value=u,j.value=_||0)}catch(l){console.error("加载订单失败:",l)}D.value=!1}me([k,w,x],()=>C());function J(l){l&&(navigator.clipboard.writeText(l),T.success("已复制"))}async function K(l){y.value=l,V.value=!0,n.value=null,h.value=parseFloat(l.total_amount||0),B.value="",q.value=!0;try{const e=$(),{data:u,error:f}=await e.from("refund_requests").select("*").eq("order_id",l.id).order("created_at",{ascending:!1}).limit(1).single();!f&&u&&(n.value=u)}catch(e){console.error("获取退款申请失败:",e)}finally{q.value=!1}}const Q=l=>({pending:"待审核",approved:"已通过",rejected:"已拒绝"})[l]||l,W=l=>({pending:"warning",approved:"success",rejected:"danger"})[l]||"info";async function I(l){if(!n.value)return;if(l&&h.value<=0){T.warning("请填写退款金额");return}const e=l?"同意退款":"拒绝退款";try{await qe.confirm(l?`确定退款 ¥${h.value} 给用户？`:"确定拒绝此退款申请？订单将恢复原状态。",e,{confirmButtonText:"确定",cancelButtonText:"取消"})}catch{return}S.value=!0;try{const u=$(),{data:f,error:_}=await u.rpc("admin_review_refund",{p_request_id:n.value.id,p_approved:l,p_refund_amount:l?h.value:null,p_admin_note:B.value||null});if(_)throw _;if(!f?.success){T.error(f?.error||"操作失败");return}T.success(f?.message||"操作成功"),V.value=!1,C()}catch(u){T.error(u.message||"操作失败")}finally{S.value=!1}}return pe(()=>C()),(l,e)=>{const u=ne,f=le,_=se,p=ie,X=re,R=ue,Y=_e,z=ye,c=Ee,U=he,Z=ke,ee=we,te=xe,ae=Ve;return r(),v("div",ze,[a(Ce,{title:"退款管理",description:"显示退款中和已退款的订单，审核用户的退款申请"}),a(Te,null,{actions:o(()=>[a(f,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=t=>x.value=t),placeholder:"状态筛选",style:{width:"120px","margin-right":"12px"}},{default:o(()=>[a(u,{label:"全部",value:""}),a(u,{label:"退款中",value:"refunding"}),a(u,{label:"已退款",value:"refunded"})]),_:1},8,["modelValue"]),a(_,{onClick:C,icon:E(ce)},{default:o(()=>[...e[9]||(e[9]=[i("刷新",-1)])]),_:1},8,["icon"])]),_:1}),a(Ae,{data:N.value,loading:D.value,total:j.value,"current-page":k.value,"onUpdate:currentPage":e[1]||(e[1]=t=>k.value=t),"page-size":w.value,"onUpdate:pageSize":e[2]||(e[2]=t=>w.value=t),onPageChange:C},{default:o(()=>[a(p,{label:"订单号","min-width":"150"},{default:o(({row:t})=>[d("span",{class:"mono-text",onClick:oe=>J(t.order_no)},s(t.order_no),9,Ue)]),_:1}),a(p,{label:"用户","min-width":"140"},{default:o(({row:t})=>[d("div",$e,[a(X,{size:28,src:t._profile?.avatar||E(Se)},null,8,["src"]),d("span",Fe,s(t._profile?.uid||"无UID"),1)])]),_:1}),a(p,{label:"商品","min-width":"200"},{default:o(({row:t})=>[d("div",Ne,[t.product_snapshot?.image?(r(),v("img",{key:0,src:t.product_snapshot.image,class:"product-thumb"},null,8,je)):g("",!0),d("span",null,s(t.product_snapshot?.product_name||"未知商品"),1)])]),_:1}),a(p,{label:"规格","min-width":"140"},{default:o(({row:t})=>[d("span",Ie,s(G(t.sku_snapshot?.spec_combination)),1)]),_:1}),a(p,{label:"数量",width:"60",align:"center"},{default:o(({row:t})=>[d("span",null,s(t.quantity||1),1)]),_:1}),a(p,{label:"总支付",width:"90"},{default:o(({row:t})=>[d("span",Re,s(E(F)(t.total_amount)),1)]),_:1}),a(p,{label:"优惠券",width:"80"},{default:o(({row:t})=>[t.coupon_snapshot?.discount_amount?(r(),v("span",Oe," -"+s(E(F)(t.coupon_snapshot.discount_amount)),1)):(r(),v("span",Pe,"-"))]),_:1}),a(p,{label:"状态",width:"90"},{default:o(({row:t})=>[a(R,{type:H(t.status)||"info",size:"small"},{default:o(()=>[i(s(M(t.status)),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"创建时间",width:"150"},{default:o(({row:t})=>[i(s(A(t.created_at)),1)]),_:1}),a(p,{label:"到期时间",width:"150"},{default:o(({row:t})=>[i(s(A(t.end_time||t.expires_at)),1)]),_:1}),a(p,{label:"操作",width:"120",fixed:"right",align:"center"},{default:o(({row:t})=>[a(_,{link:"",type:"primary",onClick:oe=>K(t)},{default:o(()=>[i(s(t.status==="refunding"?"审核":"查看"),1)]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","loading","total","current-page","page-size"]),a(ae,{modelValue:V.value,"onUpdate:modelValue":e[8]||(e[8]=t=>V.value=t),title:"退款申请审核",width:"600px","destroy-on-close":""},{footer:o(()=>[n.value?.status==="pending"?(r(),v("div",Xe,[a(_,{onClick:e[5]||(e[5]=t=>I(!1)),loading:S.value},{default:o(()=>[...e[13]||(e[13]=[i(" 拒绝退款 ",-1)])]),_:1},8,["loading"]),a(_,{type:"primary",onClick:e[6]||(e[6]=t=>I(!0)),loading:S.value,icon:E(ge)},{default:o(()=>[...e[14]||(e[14]=[i(" 同意退款 ",-1)])]),_:1},8,["loading","icon"])])):(r(),b(_,{key:1,onClick:e[7]||(e[7]=t=>V.value=!1)},{default:o(()=>[...e[15]||(e[15]=[i("关闭",-1)])]),_:1}))]),default:o(()=>[q.value?(r(),v("div",Le,[a(Y,{class:"is-loading"},{default:o(()=>[a(E(fe))]),_:1}),e[10]||(e[10]=i(" 正在加载退款申请... ",-1))])):n.value?(r(),v(ve,{key:1},[n.value.status==="pending"?(r(),b(z,{key:0,title:"该订单等待退款审核",type:"warning","show-icon":"",closable:!1,class:"mb-4"})):g("",!0),n.value.status==="approved"?(r(),b(z,{key:1,title:"该订单已完成退款",type:"success","show-icon":"",closable:!1,class:"mb-4"})):g("",!0),n.value.status==="rejected"?(r(),b(z,{key:2,title:"该退款申请已被拒绝",type:"danger","show-icon":"",closable:!1,class:"mb-4"})):g("",!0),a(U,{title:"订单信息",column:2,border:"",class:"mb-4"},{default:o(()=>[a(c,{label:"订单号"},{default:o(()=>[i(s(y.value?.order_no),1)]),_:1}),a(c,{label:"订单金额"},{default:o(()=>[d("span",Me,"¥"+s(y.value?.total_amount),1)]),_:1}),a(c,{label:"商品"},{default:o(()=>[i(s(y.value?.product_snapshot?.product_name),1)]),_:1}),a(c,{label:"原状态"},{default:o(()=>[i(s(n.value?.original_status),1)]),_:1})]),_:1}),a(U,{title:"退款申请",column:1,border:""},{default:o(()=>[a(c,{label:"退款原因"},{default:o(()=>[i(s(n.value.reason),1)]),_:1}),n.value.reason_detail?(r(),b(c,{key:0,label:"补充说明"},{default:o(()=>[i(s(n.value.reason_detail),1)]),_:1})):g("",!0),a(c,{label:"申请时间"},{default:o(()=>[i(s(A(n.value.created_at)),1)]),_:1}),a(c,{label:"申请状态"},{default:o(()=>[a(R,{type:W(n.value.status)},{default:o(()=>[i(s(Q(n.value.status)),1)]),_:1},8,["type"])]),_:1})]),_:1}),n.value.status!=="pending"?(r(),b(U,{key:3,title:"审核结果",column:1,border:"",class:"mt-4"},{default:o(()=>[n.value.refund_amount?(r(),b(c,{key:0,label:"退款金额"},{default:o(()=>[d("span",He,"¥"+s(n.value.refund_amount),1)]),_:1})):g("",!0),n.value.admin_note?(r(),b(c,{key:1,label:"管理员备注"},{default:o(()=>[i(s(n.value.admin_note),1)]),_:1})):g("",!0),a(c,{label:"审核时间"},{default:o(()=>[i(s(A(n.value.reviewed_at)),1)]),_:1})]),_:1})):g("",!0),n.value.status==="pending"?(r(),v("div",Ge,[d("div",Je,[e[11]||(e[11]=d("label",null,"退款金额：",-1)),a(Z,{modelValue:h.value,"onUpdate:modelValue":e[3]||(e[3]=t=>h.value=t),min:0,max:parseFloat(y.value?.total_amount||0),precision:2,"controls-position":"right",style:{width:"150px"}},null,8,["modelValue","max"]),d("span",Ke,"（订单金额: ¥"+s(y.value?.total_amount)+"）",1)]),d("div",Qe,[e[12]||(e[12]=d("label",null,"管理员备注：",-1)),a(ee,{modelValue:B.value,"onUpdate:modelValue":e[4]||(e[4]=t=>B.value=t),type:"textarea",rows:2,placeholder:"审核备注（选填）",style:{flex:"1"}},null,8,["modelValue"])])])):g("",!0)],64)):(r(),v("div",We,[a(te,{description:"未找到退款申请记录","image-size":80})]))]),_:1},8,["modelValue"])])}}}),va=be(Ye,[["__scopeId","data-v-ba2e4f28"]]);export{va as default};
