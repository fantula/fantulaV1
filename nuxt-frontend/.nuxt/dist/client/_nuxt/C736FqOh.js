import{z as vs,r as h,g as b,ab as fs,B as C,C as ns,eH as D,aj as es,f as rs,c as f,aD as ls,a as s,x as ps,t as d,d as q,I as K,o as c,_ as is,ad as _s,h as ms,G as Y,D as N,b as l,l as t,w,F as ts,k as os,n as as,E as hs,a1 as gs,a2 as ys,aU as ks,bI as ws,aQ as bs,aA as Is,Z as Cs,L as qs,a4 as Ss,aX as xs,dm as Ps}from"./CEI0siaN.js";import{E as Fs}from"./BTKFVfca.js";import{E as Os}from"./CoJKtQsI.js";/* empty css        */import{C as $s}from"./9N0sxF3G.js";import{W as As}from"./1A56VrIH.js";import"./Cp1EI20B.js";import"./Dnj8X3EN.js";import"./CgQ-l74f.js";/* empty css        */import"./BshxmKU8.js";function Bs(){const F=ns(),p=vs(),i=h(!0),_=h(""),r=h([]),g=h(!1),k=h(!1),O=h(!1),$=h(""),A=h(0),u=h(null),n=h(0),B=h(0);let S=null,I=null;const V=b(()=>r.value.reduce((o,a)=>o+a.total_amount,0)),M=b(()=>r.value.reduce((o,a)=>o+a.total_amount,0)),z=b(()=>p.user?.balance??0),U=b(()=>r.value.map(o=>o.sku_snapshot?.sku_id).filter(Boolean)),T=b(()=>r.value.map(o=>o.product_snapshot?.product_id).filter(Boolean)),L=b(()=>{const o=Math.floor(B.value/60),a=B.value%60;return`${o}:${a.toString().padStart(2,"0")}`}),j=async()=>{if(!O.value){O.value=!0;try{await p.fetchUserInfo(),C.success("é¢åº¦å·²æ›´æ–°")}catch{C.error("æ›´æ–°å¤±è´¥")}finally{O.value=!1}}},G=o=>{const a=()=>{const y=Date.now();B.value=Math.max(0,Math.floor((o-y)/1e3)),B.value<=0&&(H(),S&&clearInterval(S))};a(),S=es(a,1e3)},H=async()=>{if(_.value="è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ä¸‹å•",r.value.length>0)try{await D.expirePreOrder(r.value[0].id)}catch(o){console.error("Failed to expire order",o)}},Q=()=>{I&&clearInterval(I),I=es(async()=>{if(_.value||g.value||r.value.length===0)return;const o=r.value[0].id,a=await D.getPreOrder(o);if(a.success&&a.pre_order){const y=a.pre_order.status;if(y==="converted"||y==="confirmed"){k.value||($.value=a.pre_order.order_no,A.value=a.pre_order.total_amount,k.value=!0,clearInterval(I),clearInterval(S));return}if(y==="expired"||y==="cancelled"){_.value="è®¢å•å·²å¤±æ•ˆæˆ–å·²å…³é—­",clearInterval(I),clearInterval(S);return}a.pre_order.total_amount!==r.value[0].total_amount&&(r.value[0].total_amount=a.pre_order.total_amount)}},3e3)},W=async o=>{i.value=!0,_.value="";try{if(!p.isLoggedIn&&(await p.fetchUserInfo(),!p.isLoggedIn)){C.warning("è¯·å…ˆç™»å½•"),F.push("/");return}if(o.length===0)throw new Error("ç¼ºå°‘è®¢å• ID");const a=[];for(const m of o){const E=await D.getPreOrder(m);E.success&&E.pre_order&&a.push(E.pre_order)}if(a.length===0)throw new Error("è®¢å•ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");r.value=a;const y=Math.min(...a.map(m=>new Date(m.expires_at).getTime()));G(y),Q()}catch(a){_.value=a.message}finally{i.value=!1}},J=async o=>{u.value=o;const a=o?.id||null,y=r.value[0];if(y){i.value=!0;try{const m=await D.applyCouponToPreOrder(y.id,a);m.success?(m.total_amount!==void 0&&(y.total_amount=m.total_amount,n.value=m.discount_amount||0),o?C.success("ä¼˜æƒ åˆ¸ä½¿ç”¨æˆåŠŸ"):C.success("å·²å–æ¶ˆä¼˜æƒ åˆ¸")):(C.error(m.error||"åº”ç”¨ä¼˜æƒ åˆ¸å¤±è´¥"),o&&(u.value=null),n.value=0)}catch(m){C.error("ç³»ç»Ÿå¼‚å¸¸: "+(m.message||JSON.stringify(m))),console.error(m)}finally{i.value=!1}}},R=async()=>{if(!g.value){if(r.value.length>0&&r.value[0].status!=="pending"){C.error("è®¢å•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢");return}if(z.value<M.value){C.warning("é¢åº¦ä¸è¶³ï¼Œè¯·å…ˆå……å€¼"),F.push("/profile/recharge");return}g.value=!0;try{const o=r.value[0],a=await D.confirmPreOrder(o.id,"balance",u.value?.id);if(!a.success){C.error(a.error||"æ”¯ä»˜å¤±è´¥");return}$.value=a.order_no||"",A.value=M.value,k.value=!0,await p.fetchUserInfo()}catch(o){C.error(o.message||"ç³»ç»Ÿå¼‚å¸¸")}finally{g.value=!1}}},X=o=>o?Object.values(o).join(" / "):"é»˜è®¤è§„æ ¼";return fs(()=>{S&&clearInterval(S),I&&clearInterval(I)}),{loading:i,error:_,preOrders:r,paying:g,showPaySuccess:k,refreshingBalance:O,lastOrderId:$,lastOrderAmount:A,selectedCoupon:u,couponDiscount:n,remainingSeconds:B,totalProductAmount:V,finalPayAmount:M,userBalance:z,orderSkuIds:U,orderProductIds:T,formatCountdown:L,loadPreOrders:W,handleCouponSelect:J,handlePay:R,formatSpec:X,refreshBalance:j}}const Ms={class:"pay-success-modal glass-card"},Ns={class:"success-info"},Ts={class:"info-row"},Es={class:"info-value info-link"},Ds={class:"info-row"},Vs={class:"info-value info-amount"},zs={class:"info-row"},Us={class:"info-value info-paytype"},Ls={class:"info-row"},Rs={class:"info-value info-time"},js=rs({__name:"PaySuccessModal",props:{orderId:{type:String,default:"N/A"},payType:{type:String,default:"balance"},amount:{type:[String,Number],default:0}},emits:["close"],setup(F,{emit:p}){const i=F,_=p,r=b(()=>i.orderId||"N/A"),g=b(()=>{try{const u=typeof i.amount=="string"?parseFloat(i.amount||"0"):i.amount||0;return isNaN(u)?"0.00":u.toFixed(2)}catch{return"0.00"}}),k=b(()=>({alipay:"æ”¯ä»˜å®æ”¯ä»˜",balance:"ä½™é¢æ”¯ä»˜",other:"å…¶ä»–æ”¯ä»˜"})[i.payType]||"æœªçŸ¥æ”¯ä»˜æ–¹å¼"),O=b(()=>{try{return new Date().toLocaleString("zh-CN",{hour12:!1})}catch{return"åˆšåˆš"}}),$=()=>{_("close");try{K("/")}catch{window.location.href="/"}},A=()=>{_("close");try{i.orderId&&i.orderId!=="N/A"?K(`/profile/order/${i.orderId}`):K("/profile/orders")}catch{window.location.href="/profile/orders"}};return(u,n)=>(c(),f("div",{class:"modal-mask",onClick:n[0]||(n[0]=ls(B=>u.$emit("close"),["self"]))},[s("div",Ms,[n[8]||(n[8]=ps('<div class="success-header" data-v-14a59af2><div class="success-circle" data-v-14a59af2><div class="success-icon-wrapper" data-v-14a59af2><svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-14a59af2><polyline points="20 6 9 17 4 12" data-v-14a59af2></polyline></svg></div></div><div class="success-title" data-v-14a59af2>æ”¯ä»˜æˆåŠŸ</div><div class="success-desc" data-v-14a59af2>æ‚¨çš„è®¢å•å·²ç¡®è®¤ï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°</div></div>',1)),s("div",Ns,[s("div",Ts,[n[1]||(n[1]=s("span",{class:"info-label"},"è®¢å•ç¼–å·",-1)),s("span",Es,d(r.value),1)]),n[5]||(n[5]=s("div",{class:"info-divider"},null,-1)),s("div",Ds,[n[2]||(n[2]=s("span",{class:"info-label"},"æ”¯ä»˜é‡‘é¢",-1)),s("span",Vs,"Â¥"+d(g.value),1)]),n[6]||(n[6]=s("div",{class:"info-divider"},null,-1)),s("div",zs,[n[3]||(n[3]=s("span",{class:"info-label"},"æ”¯ä»˜æ–¹å¼",-1)),s("span",Us,d(k.value),1)]),n[7]||(n[7]=s("div",{class:"info-divider"},null,-1)),s("div",Ls,[n[4]||(n[4]=s("span",{class:"info-label"},"æ”¯ä»˜æ—¶é—´",-1)),s("span",Rs,d(O.value),1)])]),n[9]||(n[9]=s("div",{class:"status-box"},[s("div",{class:"status-icon"},"ğŸš€"),s("div",{class:"status-text"},"ç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨å‘è´§ï¼Œè¯·ç¨å€™æŸ¥çœ‹")],-1)),s("div",{class:"success-actions"},[s("button",{class:"order-btn",onClick:A}," å‰å¾€æŸ¥çœ‹è®¢å• "),s("button",{class:"home-btn",onClick:$}," è¿”å›é¦–é¡µ ")]),n[10]||(n[10]=s("div",{class:"success-tip"},[q(" å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœ "),s("span",{class:"kefu-phone"},"åœ¨çº¿å®¢æœ")],-1))])]))}}),Gs=is(js,[["__scopeId","data-v-14a59af2"]]),Hs={async getCheckoutFaqs(){const F=_s(),{data:p,error:i}=await F.from("faq_categories").select("id").eq("is_active",!0).eq("is_checkout_visible",!0);if(i||!p||p.length===0)return{success:!0,faqs:[]};const _=p.map(k=>k.id),{data:r,error:g}=await F.from("faqs").select("id, question, answer, sort_order").in("category_id",_).eq("is_active",!0).order("sort_order",{ascending:!0}).limit(5);return g?(console.error("Fetch checkout FAQ error",g),{success:!1,faqs:[]}):{success:!0,faqs:r||[]}}},Qs={class:"checkout-page"},Ws={class:"checkout-content"},Js={class:"checkout-header"},Xs={key:0,class:"checkout-loading"},Zs={key:1,class:"checkout-error"},Ks={key:2,class:"checkout-main"},Ys={class:"order-section"},se={key:0,class:"countdown-bar"},ee={class:"time-highlight"},te={class:"order-list"},oe={class:"order-header-row"},ae={class:"order-no"},ne={class:"order-body"},re={class:"product-thumb"},le={class:"sq-cover-img-container"},ie=["src"],ce={class:"product-info"},de={class:"product-name"},ue={class:"product-meta-row"},ve={class:"product-price"},fe={class:"price-val"},pe={class:"qty"},_e={key:1,class:"faq-section"},me={class:"faq-card glass-card"},he={class:"faq-list"},ge=["onClick"],ye={class:"q-text"},ke={class:"faq-answer"},we={class:"tips-container"},be={class:"tips-card glass-card"},Ie={class:"summary-section"},Ce={class:"summary-card glass-card sticky-card"},qe={class:"price-rows"},Se={class:"price-row"},xe={class:"val"},Pe={class:"coupon-label"},Fe={class:"coupon-action"},Oe={key:0,class:"val discount"},$e={key:1,class:"placeholder"},Ae={class:"price-row total"},Be={class:"val final"},Me={class:"payment-method"},Ne={class:"balance-card active"},Te={class:"balance-icon"},Ee={class:"balance-info"},De={class:"user-balance-row"},Ve={class:"user-balance"},ze={class:"check-mark"},Ue={class:"action-area"},Le=["disabled"],Re={key:0,class:"btn-loader"},je={key:1},Ge={key:2},He=rs({__name:"[id]",setup(F){const p=gs(),i=ns(),_=h(!1),r=h(!1),g=h([]),k=h(null),{loading:O,error:$,preOrders:A,paying:u,showPaySuccess:n,lastOrderId:B,lastOrderAmount:S,selectedCoupon:I,couponDiscount:V,remainingSeconds:M,formatCountdown:z,totalProductAmount:U,finalPayAmount:T,userBalance:L,orderSkuIds:j,orderProductIds:G,loadPreOrders:H,handleCouponSelect:Q,handlePay:W,formatSpec:J,refreshBalance:R,refreshingBalance:X}=Bs(),o=b(()=>{const x=p.params.id,e=p.query.ids;return e?e.split(","):x?[x]:[]}),a=b(()=>L.value<T.value),y=()=>{if(a.value){r.value=!0;return}W()},m=x=>{k.value=k.value===x?null:x},E=async()=>{const x=await Hs.getCheckoutFaqs();x.success&&(g.value=x.faqs)},cs=()=>{r.value=!1,R()};ms(()=>{H(o.value),E()});const ds=()=>{n.value=!1,i.push("/profile/orders")};return(x,e)=>{const P=hs,ss=Fs,us=Os;return c(),f("div",Qs,[s("div",Ws,[s("div",Js,[s("button",{class:"back-btn",onClick:e[0]||(e[0]=v=>t(i).back())},[l(P,null,{default:w(()=>[l(t(ys))]),_:1}),e[4]||(e[4]=q(" è¿”å› ",-1))]),e[5]||(e[5]=s("div",{class:"page-title"},"è®¢å•ç»“ç®—",-1))]),t(O)?(c(),f("div",Xs,[...e[6]||(e[6]=[s("div",{class:"glass-loader"},null,-1),s("p",null,"æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...",-1)])])):t($)?(c(),f("div",Zs,[e[7]||(e[7]=s("div",{class:"error-icon"},"âš ï¸",-1)),s("p",null,d(t($)),1),s("button",{class:"action-btn",onClick:e[1]||(e[1]=v=>t(i).push("/"))},"è¿”å›é¦–é¡µ")])):t(A).length>0?(c(),f("div",Ks,[s("div",Ys,[t(M)>0?(c(),f("div",se,[l(P,null,{default:w(()=>[l(t(ks))]),_:1}),s("span",null,[e[8]||(e[8]=q("è¯·åœ¨ ",-1)),s("strong",ee,d(t(z)),1),e[9]||(e[9]=q(" å†…å®Œæˆæ”¯ä»˜ï¼Œè¶…æ—¶å°†é‡Šæ”¾åº“å­˜",-1))])])):N("",!0),s("div",te,[(c(!0),f(ts,null,os(t(A),v=>(c(),f("div",{key:v.id,class:"order-card glass-card"},[s("div",oe,[s("span",ae,"è®¢å•å·: "+d(v.order_no),1),e[10]||(e[10]=s("span",{class:"order-status"},"å¾…æ”¯ä»˜",-1))]),s("div",ne,[s("div",re,[s("div",le,[s("img",{src:v.product_snapshot?.image||"/images/shared/logo.png",class:"sq-cover-img"},null,8,ie)])]),s("div",ce,[s("div",de,d(v.product_snapshot?.product_name),1),s("div",ue,[l(ss,{size:"small",effect:"dark",class:"spec-tag"},{default:w(()=>[q(d(t(J)(v.sku_snapshot?.spec_combination)),1)]),_:2},1024)])]),s("div",ve,[s("div",fe,d(v.unit_price.toFixed(2))+" ç‚¹",1),s("div",pe,"x"+d(v.quantity),1)])])]))),128))]),g.value.length>0?(c(),f("div",_e,[s("div",me,[s("h4",null,[l(P,null,{default:w(()=>[l(t(ws))]),_:1}),e[11]||(e[11]=q(" å¸¸è§é—®é¢˜",-1))]),s("div",he,[(c(!0),f(ts,null,os(g.value,(v,Z)=>(c(),f("div",{key:v.id,class:as(["faq-item",{active:k.value===Z}])},[s("div",{class:"faq-question",onClick:Qe=>m(Z)},[s("span",ye,d(v.question),1),l(P,{class:"arrow-icon"},{default:w(()=>[l(t(bs))]),_:1})],8,ge),s("div",{class:"faq-answer-wrapper",style:Is({maxHeight:k.value===Z?"200px":"0"})},[s("div",ke,d(v.answer),1)],4)],2))),128))])])])):N("",!0),s("div",we,[s("div",be,[s("h4",null,[l(P,null,{default:w(()=>[l(t(Cs))]),_:1}),e[12]||(e[12]=q(" æ¸©é¦¨æç¤º",-1))]),e[13]||(e[13]=s("ul",null,[s("li",null,"èµ„æºå·²ä¸ºæ‚¨é”å®šï¼Œè¯·å°½å¿«å®Œæˆæ”¯ä»˜ã€‚"),s("li",null,"è¶…æ—¶æœªæ”¯ä»˜å°†è‡ªåŠ¨é‡Šæ”¾ï¼Œéœ€é‡æ–°ä¸‹å•ã€‚"),s("li",null,"å¦‚é‡é—®é¢˜ï¼Œè¯·è”ç³»åœ¨çº¿å®¢æœã€‚")],-1))])])]),s("div",Ie,[s("div",Ce,[e[21]||(e[21]=s("h3",{class:"card-title"},"æ”¯ä»˜è¯¦æƒ…",-1)),s("div",qe,[s("div",Se,[e[14]||(e[14]=s("span",null,"å•†å“æ€»é¢",-1)),s("span",xe,d(t(U).toFixed(2))+" ç‚¹",1)]),s("div",{class:"price-row coupon-row",onClick:e[2]||(e[2]=v=>_.value=!0)},[s("div",Pe,[e[15]||(e[15]=s("span",null,"ä¼˜æƒ åˆ¸",-1)),t(I)?(c(),Y(ss,{key:0,size:"small",type:"danger",effect:"dark",class:"discount-tag"},{default:w(()=>[q(" å·²æŠµæ‰£ "+d(t(V).toFixed(2))+" ç‚¹ ",1)]),_:1})):N("",!0)]),s("div",Fe,[t(I)?(c(),f("span",Oe,"-"+d(t(V).toFixed(2))+" ç‚¹",1)):(c(),f("span",$e,"é€‰æ‹©ä¼˜æƒ åˆ¸")),l(P,null,{default:w(()=>[l(t(qs))]),_:1})])]),e[17]||(e[17]=s("div",{class:"divider"},null,-1)),s("div",Ae,[e[16]||(e[16]=s("span",null,"åº”ä»˜é‡‘é¢",-1)),s("span",Be,d(t(T).toFixed(2))+" ç‚¹",1)])]),s("div",Me,[e[19]||(e[19]=s("div",{class:"method-title"},"æ”¯ä»˜æ–¹å¼",-1)),s("div",Ne,[s("div",Te,[l(P,null,{default:w(()=>[l(t(Ss))]),_:1})]),s("div",Ee,[e[18]||(e[18]=s("div",{class:"method-name"},"é¢åº¦æ”¯ä»˜",-1)),s("div",De,[s("span",Ve,"å¯ç”¨é¢åº¦: "+d(t(L).toFixed(2))+" ç‚¹",1),l(us,{link:"",type:"primary",size:"small",onClick:ls(t(R),["stop"]),loading:t(X),class:"refresh-btn"},{default:w(()=>[l(P,null,{default:w(()=>[l(t(xs))]),_:1})]),_:1},8,["onClick","loading"])])]),s("div",ze,[l(P,null,{default:w(()=>[l(t(Ps))]),_:1})])])]),s("div",Ue,[s("button",{class:as(["pay-btn",{insufficient:a.value}]),disabled:t(u)||t(M)<=0,onClick:y},[t(u)?(c(),f("div",Re)):a.value?(c(),f("span",je,"é¢åº¦ä¸è¶³ï¼Œå»å……å€¼")):(c(),f("span",Ge,"ç«‹å³æ”¯ä»˜ "+d(t(T).toFixed(2))+" ç‚¹",1))],10,Le),e[20]||(e[20]=s("div",{class:"agreement-text"},[q(" ç‚¹å‡»æ”¯ä»˜å³è¡¨ç¤ºåŒæ„ "),s("a",{href:"/docs/terms",target:"_blank"},"æœåŠ¡åè®®"),q(" å’Œ "),s("a",{href:"/docs/privacy",target:"_blank"},"éšç§åè®®")],-1))])])])])):N("",!0)]),t(n)?(c(),Y(Gs,{key:0,orderId:t(B),amount:t(S),payType:"balance",onClose:ds},null,8,["orderId","amount"])):N("",!0),l($s,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=v=>_.value=v),orderAmount:t(U),skuIds:t(j),productIds:t(G),currentCouponId:t(I)?.id,onSelect:t(Q)},null,8,["modelValue","orderAmount","skuIds","productIds","currentCouponId","onSelect"]),r.value?(c(),Y(As,{key:1,onClose:cs})):N("",!0)])}}}),nt=is(He,[["__scopeId","data-v-7e7f7ac5"]]);export{nt as default};
