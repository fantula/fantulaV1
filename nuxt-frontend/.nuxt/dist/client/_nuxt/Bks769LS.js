import{E as te}from"./BCllKHMW.js";import{E as ae,a as oe}from"./ClIUVBla.js";import{E as le,a as se}from"./DC_bmF7B.js";import{E as ne}from"./PbH8IyH8.js";import{E as re}from"./BU1aYbpV.js";import{a as ie}from"./D-7LAYt0.js";import{E as de}from"./CZLDLz6s.js";import{E as ue}from"./BTKFVfca.js";import{a as me,E as ce}from"./B77-r_qQ.js";import{E as pe}from"./CoJKtQsI.js";import{f as A,r as b,g as L,J as O,c as h,o as f,a as l,b as s,w as i,F as R,k as T,G as M,_ as z,a1 as fe,am as ve,h as _e,l as q,B as V,C as ge,d as I,D as j,t as Y}from"./CEI0siaN.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{d as y}from"./C-2dxbDp.js";import{S as be}from"./B6YmYHDh.js";import{a as ke,E as ye}from"./DIhsiPve.js";/* empty css        */import{b as K,a as he,c as F}from"./ByqilF2g.js";import"./97-vZjNt.js";import"./DqBrY_lx.js";import"./BB_Ol6Sd.js";import"./C6m5ANi3.js";import"./Cp1EI20B.js";import"./Dnj8X3EN.js";import"./Bh6H2ams.js";import"./Cq9Fpw4b.js";import"./DW0_wk9g.js";import"./CCDBlmbt.js";import"./92s3wAHG.js";import"./BjbJQEzT.js";import"./wVnq5BSo.js";import"./BC9Y1jC9.js";import"./CNYNJsmX.js";import"./CCoZ80-G.js";import"./CChPPi86.js";import"./B_7HZhJl.js";import"./CXRxotb2.js";import"./DE5qJ7kT.js";import"./BzZM8Et6.js";import"./CB_o0Cdi.js";import"./aSYcAdI9.js";import"./uZ_KtR8H.js";import"./OwHC_0Ap.js";import"./BPYXJYQz.js";import"./BV_QTDOQ.js";import"./DgMG35os.js";const De={class:"admin-sku-selector"},Ve={class:"selector-controls"},xe=A({__name:"AdminSkuSelector",props:{modelValue:{},categories:{},products:{}},emits:["update:modelValue"],setup(x,{emit:P}){const v=x,S=P,k=b(""),_=b(""),c=b([]),n=b([]),D=b(!1),w=L(()=>k.value?v.products.filter(r=>r.category_id===k.value):v.products),a=r=>{let o="";r.tag_name?o=r.tag_name:r.spec_combination&&Object.keys(r.spec_combination).length?o=Object.entries(r.spec_combination).map(([m,t])=>`${m}:${t}`).join(" | "):o="默认规格";const d=r.price!==void 0?` (¥${r.price})`:"";return o+d},U=()=>{_.value="",c.value=[],n.value=[]},E=async r=>{if(c.value=[],n.value=[],!r)return;D.value=!0;const o=await K.getProductWithSkus(r);if(o.success&&o.skus){n.value=o.skus;const d=new Set(v.modelValue.map(m=>m.id));c.value=o.skus.filter(m=>d.has(m.id)).map(m=>m.id)}D.value=!1},C=()=>{const r=new Set(n.value.map(t=>t.id)),o=v.modelValue.filter(t=>!r.has(t.id)),d=v.products.find(t=>t.id===_.value),m=c.value.map(t=>{const e=n.value.find(u=>u.id===t);return e?{id:e.id,productName:d?.product_name||"未知商品",spec:a(e)}:null}).filter(Boolean);S("update:modelValue",[...o,...m])};return O(()=>v.modelValue,r=>{if(n.value.length>0){const o=new Set(r.map(d=>d.id));c.value=n.value.filter(d=>o.has(d.id)).map(d=>d.id)}},{deep:!0}),(r,o)=>{const d=ye,m=ke;return f(),h("div",De,[l("div",Ve,[s(m,{modelValue:k.value,"onUpdate:modelValue":o[0]||(o[0]=t=>k.value=t),placeholder:"分类筛选",style:{width:"140px"},clearable:"",onChange:U},{default:i(()=>[(f(!0),h(R,null,T(x.categories,t=>(f(),M(d,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(m,{modelValue:_.value,"onUpdate:modelValue":o[1]||(o[1]=t=>_.value=t),placeholder:"选择商品",style:{flex:"1",margin:"0 12px"},filterable:"",disabled:!x.categories.length&&!x.products.length,onChange:E},{default:i(()=>[(f(!0),h(R,null,T(w.value,t=>(f(),M(d,{key:t.id,label:t.product_name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),s(m,{modelValue:c.value,"onUpdate:modelValue":o[2]||(o[2]=t=>c.value=t),placeholder:"选择 SKU (可多选)",style:{flex:"1","max-width":"400px","margin-right":"12px"},loading:D.value,disabled:!_.value,multiple:"","collapse-tags":"","collapse-tags-tooltip":"",filterable:"",onChange:C,onRemoveTag:C},{default:i(()=>[(f(!0),h(R,null,T(n.value,t=>(f(),M(d,{key:t.id,label:a(t),value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])])])}}}),Se=z(xe,[["__scopeId","data-v-66238d5d"]]),we={class:"coupon-post-page"},Ee={class:"form-content"},Ce={class:"date-picker-wrapper"},Ie={key:0,class:"date-text"},Ye={class:"value"},Me={key:0,class:"form-tip"},Pe={class:"card-header"},Ue={class:"product-selector"},$e={class:"preview-container"},Be={class:"coupon-ticket product-ticket"},Ne={class:"ticket-left"},Re={class:"ticket-amount"},Te={class:"ticket-right"},je={class:"ticket-name"},Fe={class:"ticket-date"},Ke=A({__name:"post",setup(x){const P=fe(),v=ge(),S=b(),k=b(!1),_=P.query.id,c=L(()=>!!_),n=b(!1),D=b([]),w=b([]),a=ve({name:"",value:0,startDate:y().format("YYYY-MM-DD"),endDate:"",skuInfos:[],totalQuantity:1e3,status:!0}),U={name:[{required:!0,message:"请输入名称",trigger:"blur"}],value:[{required:!0,message:"请输入优惠金额",trigger:"blur"}]},E=t=>y(t).format("YYYY-MM-DD"),C=t=>y(t).isBefore(y(),"day");O(n,t=>{t&&(a.endDate="")});const r=t=>{let e="";t.tag_name?e=t.tag_name:t.spec_combination&&Object.keys(t.spec_combination).length?e=Object.entries(t.spec_combination).map(([g,$])=>`${g}:${$}`).join(" | "):e="默认规格";const u=t.price!==void 0?` (¥${t.price})`:"";return e+u},o=async()=>{try{const[e,u]=await Promise.all([he.getCategories(),K.getProducts({page_size:1e3})]);e.success&&(D.value=e.categories||[]),u.success&&(w.value=u.products||[])}catch{console.error("Failed to load dependency data")}if(!_)return;const t=await F.coupon.getCouponById(_);if(t.success&&t.coupon){const e=t.coupon;if(a.name=e.name,a.value=Number(e.value),a.status=e.status,a.startDate=e.start_date?y(e.start_date).format("YYYY-MM-DD"):y().format("YYYY-MM-DD"),a.totalQuantity=e.total_quantity||1e3,e.end_date?(n.value=!1,a.endDate=y(e.end_date).format("YYYY-MM-DD")):(n.value=!0,a.endDate=""),e.sku_ids&&e.sku_ids.length){const u=await K.getSkusByIds(e.sku_ids);u.success&&u.skus&&(a.skuInfos=u.skus.map(g=>({id:g.id,productName:g.productName||"未知商品",spec:r(g)})))}}else V.error(t.error||"获取详情失败")},d=t=>{a.skuInfos.splice(t,1)},m=async()=>{S.value&&await S.value.validate(async t=>{if(t){if(a.skuInfos.length===0){V.warning("请至少添加一个关联商品 SKU");return}if(!n.value&&!a.endDate){V.warning("请选择结束日期");return}k.value=!0;try{const e={name:a.name,type:"product",value:a.value,sku_ids:a.skuInfos.map(g=>g.id),min_usage:0,total_quantity:0,start_date:n.value?null:a.startDate,end_date:n.value?null:a.endDate,status:a.status};let u;c.value?u=await F.coupon.updateCoupon(_,e):u=await F.coupon.createCoupon(e),u.success?(V.success(c.value?"更新成功":"创建成功"),v.back()):V.error(u.error||"保存失败")}catch{V.error("保存异常")}finally{k.value=!1}}})};return _e(()=>{o()}),(t,e)=>{const u=te,g=oe,$=se,Q=le,G=ne,H=re,J=ie,B=de,W=ue,N=ce,X=pe,Z=me,ee=ae;return f(),h("div",we,[s(be,{title:c.value?"编辑商品券":"新增商品券","sub-title":c.value?"修改商品券信息":"创建一个新的指定商品优惠券","submit-text":c.value?"保存":"新增",loading:k.value,onSubmit:m,onCancel:e[0]||(e[0]=p=>q(v).back()),onBack:e[1]||(e[1]=p=>q(v).back())},null,8,["title","sub-title","submit-text","loading"]),l("div",Ee,[s(ee,{ref_key:"formRef",ref:S,model:a,rules:U,"label-width":"120px","label-position":"top",size:"large"},{default:i(()=>[s(B,{shadow:"never",class:"form-card"},{header:i(()=>[...e[6]||(e[6]=[l("div",{class:"card-header"},[l("span",null,"基础信息")],-1)])]),default:i(()=>[s(Q,{gutter:24},{default:i(()=>[s($,{span:12},{default:i(()=>[s(g,{label:"优惠券名称",prop:"name"},{default:i(()=>[s(u,{modelValue:a.name,"onUpdate:modelValue":e[2]||(e[2]=p=>a.name=p),placeholder:"例如：iPhone 15 专属优惠券"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s(G,{"content-position":"left"},{default:i(()=>[...e[7]||(e[7]=[I("发放规则",-1)])]),_:1}),s(g,{label:"有效期"},{default:i(()=>[l("div",Ce,[n.value?j("",!0):(f(),h("div",Ie,[e[8]||(e[8]=l("span",{class:"label"},"开始：",-1)),l("span",Ye,Y(E(a.startDate)),1)])),n.value?j("",!0):(f(),M(H,{key:1,modelValue:a.endDate,"onUpdate:modelValue":e[3]||(e[3]=p=>a.endDate=p),type:"date",placeholder:"选择结束日期","value-format":"YYYY-MM-DD",style:{flex:"1",margin:"0 12px"},"disabled-date":C},null,8,["modelValue"])),s(J,{modelValue:n.value,"onUpdate:modelValue":e[4]||(e[4]=p=>n.value=p),label:"永久有效",border:""},null,8,["modelValue"])]),n.value?j("",!0):(f(),h("div",Me,"默认从今日开始生效，请选择截止日期"))]),_:1})]),_:1}),s(B,{shadow:"never",class:"form-card"},{header:i(()=>[l("div",Pe,[e[10]||(e[10]=l("span",null,"关联商品 SKU",-1)),s(W,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:i(()=>[...e[9]||(e[9]=[I("购买指定 SKU 时可用",-1)])]),_:1})])]),default:i(()=>[l("div",Ue,[s(Se,{modelValue:a.skuInfos,"onUpdate:modelValue":e[5]||(e[5]=p=>a.skuInfos=p),categories:D.value,products:w.value},null,8,["modelValue","categories","products"]),s(Z,{data:a.skuInfos,style:{width:"100%","margin-top":"16px"},border:"","empty-text":"暂无关联 SKU"},{default:i(()=>[s(N,{prop:"productName",label:"商品名称"}),s(N,{prop:"spec",label:"规格 (SKU)"}),s(N,{label:"操作",width:"100",align:"center"},{default:i(({$index:p})=>[s(X,{link:"",type:"danger",onClick:qe=>d(p)},{default:i(()=>[...e[11]||(e[11]=[I("移除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1}),s(B,{shadow:"never",class:"form-card",style:{"margin-top":"24px"}},{header:i(()=>[...e[12]||(e[12]=[l("div",{class:"card-header"},[l("span",null,"效果预览")],-1)])]),default:i(()=>[l("div",$e,[l("div",Be,[l("div",Ne,[l("div",Re,[e[13]||(e[13]=l("small",null,"¥",-1)),I(Y(a.value||"0"),1)]),e[14]||(e[14]=l("div",{class:"ticket-cond"},"指定商品",-1))]),l("div",Te,[l("div",je,Y(a.name||"优惠券名称"),1),l("div",Fe,Y(n.value?"永久有效":`${E(a.startDate)} 至 ${a.endDate||"?"}`),1),e[15]||(e[15]=l("div",{class:"ticket-btn"},"去购买",-1))])])])]),_:1})]),_:1},8,["model"])])])}}}),Ot=z(Ke,[["__scopeId","data-v-9a907a68"]]);export{Ot as default};
