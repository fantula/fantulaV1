import{dM as u}from"./o2XBa361.js";import{a as S}from"./Bdid5VjX.js";import{a as q,b,c as C,d as A}from"./XmVVhx5S.js";import{a as U}from"./CM1YTunQ.js";const x={async getCoupons(e){let s=u().from("coupons").select("*",{count:"exact"});if(e?.type&&(s=s.eq("type",e.type)),e?.status!==void 0&&(s=s.eq("status",e.status)),s=s.order("created_at",{ascending:!1}),e?.limit){const a=e.offset||0;s=s.range(a,a+e.limit-1)}const{data:r,error:c,count:o}=await s;return c?{success:!1,coupons:[],total:0,error:c.message}:{success:!0,coupons:r||[],total:o||0}},async getCouponById(e){const t=u(),{data:s,error:r}=await t.from("coupons").select("*").eq("id",e).single();return r?{success:!1,error:r.message}:{success:!0,coupon:s}},async createCoupon(e){const t=u(),s={name:e.name,type:e.type,value:e.value,sku_ids:e.sku_ids||e.product_ids||[],min_usage:e.min_usage||0,total_quantity:e.total_quantity||null,start_date:e.start_date||null,end_date:e.end_date||null,status:e.status!==void 0?e.status:!0},{data:r,error:c}=await t.from("coupons").insert(s).select().single();return c?{success:!1,error:c.message}:{success:!0,coupon:r}},async updateCoupon(e,t){const s=u(),r={...t};r.product_ids&&(r.sku_ids=r.product_ids,delete r.product_ids);const{error:c}=await s.from("coupons").update(r).eq("id",e);return c?{success:!1,error:c.message}:{success:!0}},async generateCouponCodes(e,t=1,s="random",r,c){const o=u(),a={p_coupon_id:e,p_quantity:t,p_mode:s};s==="universal"&&(a.p_custom_code=r,a.p_usage_limit=c);const{data:n,error:l}=await o.rpc("admin_generate_coupon_codes",a);if(l)return{success:!1,error:l.message};const p=n;return p.success?{success:!0,count:p.count}:{success:!1,error:p.error}},async deleteCoupon(e){const t=u(),{error:s}=await t.from("coupons").delete().eq("id",e);return s?{success:!1,error:s.message}:{success:!0}},async getCouponCodes(e,t){const s=u(),r=t?.page||1,c=t?.size||20,o=(r-1)*c;let a=s.from("coupon_codes").select("*",{count:"exact"}).eq("coupon_id",e);t?.status&&(a=a.eq("status",t.status)),a=a.order("created_at",{ascending:!1}).range(o,o+c-1);const{data:n,error:l,count:p}=await a;return l?{success:!1,codes:[],total:0,error:l.message}:{success:!0,codes:n||[],total:p||0}},async toggleStatus(e,t){return this.updateCoupon(e,{status:t})},async deleteCouponCodes(e){const t=u(),{data:s,error:r}=await t.rpc("admin_delete_coupon_codes",{p_ids:e});if(r)return{success:!1,error:r.message};const c=s;return c.success?{success:!0,count:c.count}:{success:!1,error:c.error}},async getCouponStats(e){const t=u(),s=e.page,r=e.pageSize,c=(s-1)*r;let o=t.from("coupon_codes").select(`
                id,
                code,
                status,
                used_at,
                user_uid,
                order_id,
                coupon:coupons(name, type, value)
            `,{count:"exact"}).neq("status","available");e.code&&(o=o.ilike("code",`%${e.code}%`)),e.userUid&&(o=o.eq("user_uid",e.userUid)),o=o.order("used_at",{ascending:!1}).range(c,c+r-1);const{data:a,error:n,count:l}=await o;return n?{success:!1,data:[],total:0,error:n.message}:{success:!0,data:(a||[]).map(i=>({id:i.id,user_uid:i.user_uid,used_at:i.used_at,created_at:i.created_at,order_id:i.order_id,code:i.code,status:i.status,coupon_name:i.coupon?.name,coupon_type:i.coupon?.type,value:i.coupon?.value})),total:l||0}},async deleteCouponUsages(e){const t=u(),{error:s,count:r}=await t.from("coupon_codes").delete().in("id",e);return s?{success:!1,error:s.message}:{success:!0,count:r||e.length}},async updateCouponCode(e,t){const s=u(),{error:r}=await s.from("coupons").update({code:t}).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}}},E={async getProducts(e){const t=u(),s=e?.page||1,r=e?.page_size||20,c=(s-1)*r;let o=t.from("products").select("*",{count:"exact"});e?.category_id&&(o=o.eq("category_id",e.category_id)),e?.status&&(o=o.eq("status",e.status)),e?.keyword&&(o=o.ilike("product_name",`%${e.keyword}%`)),o=o.order("created_at",{ascending:!1}).range(c,c+r-1);const{data:a,error:n,count:l}=await o;if(n)return{success:!1,products:[],total:0,error:n.message};const p=a||[],i=p.map(d=>d.id);let g={},_={};if(i.length>0){const{data:d}=await t.from("product_sku_map").select("product_id, sku:product_skus (tag, tag_name, spec_combination)").in("product_id",i);d?.forEach(f=>{const w=f.product_id;g[w]=(g[w]||0)+1,_[w]||(_[w]=[]);const m=f.sku;if(m){let k="";m.tag_name?k=`ğŸ”– ${m.tag_name}`:m.spec_combination&&Object.values(m.spec_combination).length>0?k=Object.values(m.spec_combination).join(" / "):k="é»˜è®¤è§„æ ¼",k&&!_[w].includes(k)&&_[w].push(k)}})}return{success:!0,products:p.map(d=>({...d,sku_count:g[d.id]||0,sku_details:_[d.id]||[]})),total:l||0}},async getProductById(e){const t=u(),{data:s,error:r}=await t.from("products").select("*, category:product_categories(id, name)").eq("id",e).single();return r||!s?{success:!1,error:r?.message||"å•†å“ä¸å­˜åœ¨"}:{success:!0,product:s}},async createProduct(e){const t=u(),{data:s,error:r}=await t.from("products").insert({product_name:e.product_name,category_id:e.category_id,image:e.image,sort_order:e.sort_order||0,display_price:e.display_price||0,tags:e.tags||[],initial_sales:e.initial_sales||0,badge_label:e.badge_label,rating:e.rating||100,allow_addon:e.allow_addon||!1,detail_modules:e.detail_modules||[],status:e.status||"on"}).select().single();return r?{success:!1,error:r.message}:{success:!0,product:s}},async updateProduct(e,t){const s=u(),{error:r}=await s.from("products").update(t).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async toggleStatus(e,t){return this.updateProduct(e,{status:t})},async deleteProducts(e){const t=u();await t.from("product_sku_map").delete().in("product_id",e);const{error:s}=await t.from("products").delete().in("id",e);return s?{success:!1,error:s.message}:{success:!0}},async createProductSkus(e,t){const s=u(),r=t.map(n=>({product_type:n.product_type,spec_combination:n.spec_combination,image:n.image||null,intro:n.intro||null,price:n.price,duration:n.duration||null,sort_order:n.sort_order,tag:n.tag||null})),{data:c,error:o}=await s.from("product_skus").insert(r).select("id");if(o)return{success:!1,error:o.message};const a=(c||[]).map((n,l)=>({product_id:e,sku_id:n.id,sort_order:t[l]?.sort_order||l}));if(a.length>0){const{error:n}=await s.from("product_sku_map").insert(a);if(n)return console.error("SKU æ˜ å°„åˆ›å»ºå¤±è´¥:",n),{success:!0,count:c?.length||0,skuIds:c?.map(l=>l.id),error:`SKU å·²åˆ›å»ºä½†æ˜ å°„å¤±è´¥: ${n.message}`}}return{success:!0,count:c?.length||0,skuIds:c?.map(n=>n.id)}},async updateProductSkus(e,t){const s=u();if(t.mode==="shared"){if(!t.sharedTag)return{success:!1,error:"ç¼ºå°‘å…±äº«è§„æ ¼ç»„ Tag"};const{data:i,error:g}=await s.from("product_skus").select("id, sort_order").eq("tag",t.sharedTag);if(g)return{success:!1,error:g.message};if(!i||i.length===0)return{success:!1,error:"è¯¥å…±äº«ç»„æ²¡æœ‰ SKU"};const{error:_}=await s.from("product_sku_map").delete().eq("product_id",e);if(_)return{success:!1,error:_.message};const y=i.map(f=>({product_id:e,sku_id:f.id,sort_order:f.sort_order})),{error:d}=await s.from("product_sku_map").insert(y);return d?{success:!1,error:d.message}:{success:!0}}const{data:r}=await s.from("product_sku_map").select("sku_id, sku:product_skus!inner(tag)").eq("product_id",e),c=new Set((r||[]).map(i=>i.sku_id)),o=t.skus||[],a=new Set(o.filter(i=>i.id).map(i=>i.id)),n=[...c].filter(i=>!a.has(i));n.length>0&&await s.from("product_sku_map").delete().eq("product_id",e).in("sku_id",n);const l=o.filter(i=>i.id&&c.has(i.id));for(const i of l)await s.from("product_skus").update({product_type:i.product_type,spec_combination:i.spec_combination,image:i.image||null,intro:i.intro||null,price:i.price,duration:i.duration||null,sort_order:i.sort_order}).eq("id",i.id).is("tag",null);const p=o.filter(i=>!i.id);if(p.length>0){const i=p.map(d=>({product_type:d.product_type,spec_combination:d.spec_combination,image:d.image||null,intro:d.intro||null,price:d.price,duration:d.duration||null,sort_order:d.sort_order,tag:null})),{data:g,error:_}=await s.from("product_skus").insert(i).select("id");if(_)return{success:!1,error:_.message};const y=(g||[]).map((d,f)=>({product_id:e,sku_id:d.id,sort_order:p[f].sort_order}));y.length>0&&await s.from("product_sku_map").insert(y)}return{success:!0}},async getProductWithSkus(e){const t=u(),{data:s,error:r}=await t.from("products").select("*").eq("id",e).single();if(r)return{success:!1,error:r.message};const{data:c,error:o}=await t.from("product_sku_map").select("*, product_skus(*)").eq("product_id",e).order("sort_order",{ascending:!0});if(console.log("[getProductWithSkus] productId:",e),console.log("[getProductWithSkus] skuMappings:",c),console.log("[getProductWithSkus] skuError:",o),o)return console.error("SKU query error:",o),{success:!1,error:o.message};const a=(c||[]).map(p=>p.product_skus).filter(Boolean);console.log("[getProductWithSkus] extracted skus:",a);const n=new Map;a&&a.length>0&&a.forEach(p=>{p.spec_combination&&Object.entries(p.spec_combination).forEach(([i,g])=>{n.has(i)||n.set(i,new Set),n.get(i)?.add(String(g))})});const l=Array.from(n.entries()).map(([p,i])=>({id:p,name:p,sort_order:0,values:Array.from(i).map((g,_)=>({id:g,value:g,sort_order:_}))}));return{success:!0,product:s,specs:l,skus:a||[]}},async clearProductSpecsAndSkus(e){const t=u(),{error:s}=await t.from("product_sku_map").delete().eq("product_id",e);return s?{success:!1,error:s.message}:{success:!0}},async getSkusByIds(e){if(!e.length)return{success:!0,skus:[]};const t=u(),{data:s,error:r}=await t.from("product_sku_map").select(`
                sku_id,
                product:products(id, product_name),
                sku:product_skus(*)
            `).in("sku_id",e);return r?{success:!1,error:r.message}:{success:!0,skus:s?.map(o=>({...o.sku,productId:o.product?.id,productName:o.product?.product_name}))||[]}}},P={async getUsers(e){let s=u().from("profiles").select("*",{count:"exact"});if(e?.status&&(s=s.eq("status",e.status)),s=s.order("created_at",{ascending:!1}),e?.limit){const a=e.offset||0;s=s.range(a,a+e.limit-1)}const{data:r,error:c,count:o}=await s;return c?{success:!1,users:[],total:0,error:c.message}:{success:!0,users:r||[],total:o||0}},async getUserByUid(e){const t=u();console.log("[getUserByUid] Querying profiles for UID:",e);const{data:s,error:r}=await t.from("profiles").select("*").eq("uid",e).single();return r?(console.error("[getUserByUid] Error:",r.message,r.code,r.details),{success:!1,error:`ç”¨æˆ·ä¸å­˜åœ¨ (${r.code}: ${r.message})`}):(console.log("[getUserByUid] Found user:",s),{success:!0,user:s})},async toggleStatus(e,t){const s=u(),{error:r}=await s.from("profiles").update({status:t}).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}}},I={async getMessages(e){let s=u().from("messages").select("*",{count:"exact"});if(e?.user_uid&&(s=s.eq("user_uid",e.user_uid)),s=s.order("created_at",{ascending:!1}),e?.limit){const a=e.offset||0;s=s.range(a,a+e.limit-1)}const{data:r,error:c,count:o}=await s;return c?{success:!1,messages:[],total:0,error:c.message}:{success:!0,messages:r||[],total:o||0}},async sendMessage(e,t,s,r="system",c){const o=u(),{data:a,error:n}=await o.from("profiles").select("id, uid").eq("uid",e).single();if(n||!a)return{success:!1,error:"ç”¨æˆ·ä¸å­˜åœ¨ï¼Œç¦æ­¢å‘é€æ¶ˆæ¯"};const{data:l,error:p}=await o.from("messages").insert({user_id:a.id,user_uid:e,title:t,content:s,type:r,link:c||null}).select("id").single();return p?{success:!1,error:p.message}:{success:!0,message_id:l.id}}},z={async getSharedSkuGroups(){const e=u(),{data:t,error:s}=await e.from("product_skus").select("*").not("tag","is",null).order("tag",{ascending:!0}).order("sort_order",{ascending:!0});if(s)return{success:!1,groups:[],error:s.message};const r=new Map;for(const c of t||[]){const o=c.tag;r.has(o)||r.set(o,{tag:o,tag_name:c.tag_name||"",skus:[]}),r.get(o).skus.push(c)}return{success:!0,groups:Array.from(r.values())}},async getNextTag(){const e=u(),{data:t,error:s}=await e.from("product_skus").select("tag").not("tag","is",null).order("tag",{ascending:!1}).limit(1);return s?{success:!1,tag:1,error:s.message}:{success:!0,tag:(t?.[0]?.tag||0)+1}},async createSharedSkuGroup(e,t,s){const r=u(),c=t.map(a=>({tag:e,tag_name:s||null,product_type:a.product_type,spec_combination:a.spec_combination,price:a.price,duration:a.duration||null,intro:a.intro||null,image:a.image||null,sort_order:a.sort_order})),{error:o}=await r.from("product_skus").insert(c);return o?{success:!1,count:0,error:o.message}:{success:!0,count:c.length}},async getSkusByTag(e){const t=u(),{data:s,error:r}=await t.from("product_skus").select("*").eq("tag",e).order("sort_order",{ascending:!0});return r?{success:!1,skus:[],error:r.message}:{success:!0,skus:s||[]}},async getProductsBySharedTag(e){const t=u(),{data:s}=await t.from("product_skus").select("id").eq("tag",e);if(!s||!s.length)return{success:!0,products:[]};const r=s.map(p=>p.id),{data:c,error:o}=await t.from("product_sku_map").select("product_id").in("sku_id",r);if(o)return{success:!1,error:o.message};if(!c||!c.length)return{success:!0,products:[]};const a=[...new Set(c.map(p=>p.product_id))],{data:n,error:l}=await t.from("products").select("id, product_name, image, status").in("id",a);return l?{success:!1,error:l.message}:{success:!0,products:n||[]}},async updateSharedSkuGroup(e,t,s){const r=u(),{data:c}=await r.from("product_skus").select("id").eq("tag",e);let o=[];const a=(c||[]).map(d=>d.id);if(a.length>0){const{data:d}=await r.from("product_sku_map").select("product_id").in("sku_id",a);d&&(o=[...new Set(d.map(f=>f.product_id))])}const n=new Set(a),l=new Set(t.filter(d=>d.id).map(d=>d.id)),p=[...n].filter(d=>!l.has(d));let i=0;if(p.length>0){const{count:d}=await r.from("product_skus").delete({count:"exact"}).in("id",p);i=d||0}let g=0;for(const d of t.filter(f=>f.id&&n.has(f.id))){const{error:f}=await r.from("product_skus").update({tag_name:s||null,product_type:d.product_type,spec_combination:d.spec_combination,price:d.price,duration:d.duration||null,intro:d.intro||null,image:d.image||null,sort_order:d.sort_order}).eq("id",d.id);f||g++}const _=t.filter(d=>!d.id);let y=0;if(_.length>0){const d=_.map(m=>({tag:e,tag_name:s||null,product_type:m.product_type,spec_combination:m.spec_combination,price:m.price,duration:m.duration||null,intro:m.intro||null,image:m.image||null,sort_order:m.sort_order})),{data:f,error:w}=await r.from("product_skus").insert(d).select("id, sort_order");if(!w&&f&&(y=f.length,o.length>0)){const m=[];for(const k of o)for(const h of f)m.push({product_id:k,sku_id:h.id,sort_order:h.sort_order??0});m.length>0&&await r.from("product_sku_map").insert(m)}}return{success:!0,updated:g,inserted:y,deleted:i}},async deleteSharedSkuGroup(e){const t=u(),{data:s}=await t.from("product_sku_map").select("id, sku:product_skus!inner(tag)").eq("sku.tag",e).limit(1);if(s&&s.length>0)return{success:!1,count:0,error:"è¯¥è§„æ ¼ç»„å·²è¢«å•†å“å…³è”ï¼Œè¯·å…ˆè§£é™¤å…³è”"};const{count:r,error:c}=await t.from("product_skus").delete({count:"exact"}).eq("tag",e);return c?{success:!1,count:0,error:c.message}:{success:!0,count:r||0}}},M={async getCategories(){const e=u(),{data:t,error:s}=await e.from("product_categories").select("*").order("sort_order",{ascending:!0});if(s)return{success:!1,categories:[],error:s.message};const r=t||[],c=r.map(n=>n.id);let o={};if(c.length>0){const{data:n}=await e.from("products").select("category_id").in("category_id",c);n?.forEach(l=>{l.category_id&&(o[l.category_id]=(o[l.category_id]||0)+1)})}return{success:!0,categories:r.map(n=>({...n,product_count:o[n.id]||0}))}},async createCategory(e){const t=u(),{data:s,error:r}=await t.from("product_categories").insert({name:e.name,sort_order:e.sort_order??0,status:e.status??"on"}).select().single();return r?{success:!1,error:r.message}:{success:!0,category:s}},async updateCategory(e,t){const s=u(),{error:r}=await s.from("product_categories").update(t).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async deleteCategory(e){const t=u(),{count:s}=await t.from("products").select("*",{count:"exact",head:!0}).eq("category_id",e);if(s&&s>0)return{success:!1,error:`è¯¥åˆ†ç±»ä¸‹æœ‰ ${s} ä¸ªå•†å“ï¼Œè¯·å…ˆç§»é™¤æˆ–é‡æ–°åˆ†é…`};const{error:r}=await t.from("product_categories").delete().eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async batchUpdateSort(e){const t=u();for(const s of e){const{error:r}=await t.from("product_categories").update({sort_order:s.sort_order}).eq("id",s.id);if(r)return{success:!1,error:r.message}}return{success:!0}}},D={async getDepartments(){const e=u(),{data:t,error:s}=await e.from("admin_departments").select("*").order("created_at",{ascending:!0});return s?{success:!1,departments:[],error:s.message}:{success:!0,departments:await Promise.all((t||[]).map(async c=>{const{count:o}=await e.from("admin_users").select("*",{count:"exact",head:!0}).eq("department_id",c.id);return{...c,user_count:o||0}}))}},async createDepartment(e){const t=u(),{data:s,error:r}=await t.from("admin_departments").insert({name:e.name,permissions:e.permissions??[]}).select().single();return r?{success:!1,error:r.message}:{success:!0,department:s}},async updateDepartment(e,t){const s=u(),{error:r}=await s.from("admin_departments").update(t).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async deleteDepartment(e){const t=u(),{count:s}=await t.from("admin_users").select("*",{count:"exact",head:!0}).eq("department_id",e);if(s&&s>0)return{success:!1,error:`è¯¥éƒ¨é—¨ä¸‹æœ‰ ${s} ä¸ªç”¨æˆ·ï¼Œè¯·å…ˆç§»é™¤æˆ–é‡æ–°åˆ†é…`};const{error:r}=await t.from("admin_departments").delete().eq("id",e);return r?{success:!1,error:r.message}:{success:!0}}},v={async getUsers(){const e=u(),{data:t,error:s}=await e.from("admin_users").select(`
                *,
                department:admin_departments(id, name, permissions)
            `).order("created_at",{ascending:!1});return s?{success:!1,users:[],error:s.message}:{success:!0,users:t||[]}},async createUser(e){const t=u(),s=new TextEncoder,r=await crypto.subtle.digest("SHA-256",s.encode(e.password)),o=Array.from(new Uint8Array(r)).map(l=>l.toString(16).padStart(2,"0")).join(""),{data:a,error:n}=await t.from("admin_users").insert({name:e.name,email:e.email,password_hash:o,department_id:e.department_id??null,status:e.status??"enabled"}).select().single();return n?{success:!1,error:n.message}:{success:!0,user:a}},async updateUser(e,t){const s=u(),{error:r}=await s.from("admin_users").update(t).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async deleteUser(e){const t=u(),{error:s}=await t.from("admin_users").delete().eq("id",e);return s?{success:!1,error:s.message}:{success:!0}},async login(e,t){const s=u(),r=new TextEncoder,c=await crypto.subtle.digest("SHA-256",r.encode(t)),a=Array.from(new Uint8Array(c)).map(p=>p.toString(16).padStart(2,"0")).join(""),{data:n,error:l}=await s.from("admin_users").select(`
                *,
                department:admin_departments(id, name, permissions)
            `).eq("email",e).eq("password_hash",a).eq("status","enabled").single();return l||!n?{success:!1,error:"é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼Œæˆ–è´¦å·å·²ç¦ç”¨"}:{success:!0,user:n}}},B={async getTiers(){const e=u(),{data:t,error:s}=await e.from("recharge_tiers").select("*").order("sort_order",{ascending:!0});return s?{success:!1,data:[],error:s.message}:{success:!0,data:t||[]}},async createTier(e){const t=u(),{data:s,error:r}=await t.from("recharge_tiers").insert(e).select().single();return r?{success:!1,error:r.message}:{success:!0,data:s}},async updateTier(e,t){const s=u(),{error:r}=await s.from("recharge_tiers").update(t).eq("id",e);return r?{success:!1,error:r.message}:{success:!0}},async deleteTier(e){const t=u(),{error:s}=await t.from("recharge_tiers").delete().eq("id",e);return s?{success:!1,error:s.message}:{success:!0}}},G={product:E,cdk:S,order:U,user:P,message:I,category:M,department:D,backendUser:v,image:b,banner:A,imageCategory:q,settings:C,coupon:x,recharge:B};export{M as a,E as b,G as c,x as d,z as e,B as f,I as g,P as h};
