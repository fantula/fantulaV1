import{dM as f}from"./gYbOYKrZ.js";const h={async getProducts(e){const s=f(),r=e?.page||1,a=e?.page_size||20,p=(r-1)*a;let c=s.from("products").select("*",{count:"exact"});e?.category_id&&(c=c.eq("category_id",e.category_id)),e?.status&&(c=c.eq("status",e.status)),e?.keyword&&(c=c.ilike("product_name",`%${e.keyword}%`)),c=c.order("created_at",{ascending:!1}).range(p,p+a-1);const{data:_,error:o,count:m}=await c;if(o)return{success:!1,products:[],total:0,error:o.message};const i=_||[],t=i.map(l=>l.id);let n={},d={};if(t.length>0){const{data:l}=await s.from("product_sku_map").select("product_id, sku:product_skus (tag, tag_name, spec_combination)").in("product_id",t);l?.forEach(y=>{const g=y.product_id;n[g]=(n[g]||0)+1,d[g]||(d[g]=[]);const k=y.sku;if(k){let w="";k.tag_name?w=`ðŸ”– ${k.tag_name}`:k.spec_combination&&Object.values(k.spec_combination).length>0?w=Object.values(k.spec_combination).join(" / "):w="é»˜è®¤è§„æ ¼",w&&!d[g].includes(w)&&d[g].push(w)}})}return{success:!0,products:i.map(l=>({...l,sku_count:n[l.id]||0,sku_details:d[l.id]||[]})),total:m||0}},async getProductById(e){const s=f(),{data:r,error:a}=await s.from("products").select("*, category:product_categories(id, name)").eq("id",e).single();return a||!r?{success:!1,error:a?.message||"å•†å“ä¸å­˜åœ¨"}:{success:!0,product:r}},async createProduct(e){const s=f(),{data:r,error:a}=await s.from("products").insert({product_name:e.product_name,category_id:e.category_id,image:e.image,sort_order:e.sort_order||0,display_price:e.display_price||0,tags:e.tags||[],initial_sales:e.initial_sales||0,badge_label:e.badge_label,rating:e.rating||100,allow_addon:e.allow_addon||!1,detail_modules:e.detail_modules||[],status:e.status||"on"}).select().single();return a?{success:!1,error:a.message}:{success:!0,product:r}},async updateProduct(e,s){const r=f(),{error:a}=await r.from("products").update(s).eq("id",e);return a?{success:!1,error:a.message}:{success:!0}},async toggleStatus(e,s){return this.updateProduct(e,{status:s})},async deleteProducts(e){const s=f();await s.from("product_sku_map").delete().in("product_id",e);const{error:r}=await s.from("products").delete().in("id",e);return r?{success:!1,error:r.message}:{success:!0}},async getProductWithSkus(e){const s=f(),{data:r,error:a}=await s.from("products").select("*").eq("id",e).single();if(a)return{success:!1,error:a.message};const{data:p,error:c}=await s.from("product_sku_map").select("*, product_skus(*)").eq("product_id",e).order("sort_order",{ascending:!0});if(c)return{success:!1,error:c.message};const _=(p||[]).map(i=>i.product_skus).filter(Boolean),o=new Map;_.forEach(i=>{i.spec_combination&&Object.entries(i.spec_combination).forEach(([t,n])=>{o.has(t)||o.set(t,new Set),o.get(t)?.add(String(n))})});const m=Array.from(o.entries()).map(([i,t])=>({name:i,values:Array.from(t).map(n=>({id:n,value:n}))}));return{success:!0,product:r,specs:m,skus:_}},async createProductSkus(e,s){const r=f(),a=s.map(o=>({product_type:o.product_type,spec_combination:o.spec_combination,image:o.image||null,intro:o.intro||null,price:o.price,duration:o.duration||null,sort_order:o.sort_order,tag:o.tag||null})),{data:p,error:c}=await r.from("product_skus").insert(a).select("id");if(c)return{success:!1,error:c.message};const _=(p||[]).map((o,m)=>({product_id:e,sku_id:o.id,sort_order:s[m]?.sort_order||m}));return _.length>0&&await r.from("product_sku_map").insert(_),{success:!0}},async updateProductSkus(e,s){const r=f();if(s.mode==="shared"){if(!s.sharedTag)return{success:!1,error:"ç¼ºå°‘å…±äº«è§„æ ¼ç»„ Tag"};const{data:t}=await r.from("product_skus").select("id, sort_order").eq("tag",s.sharedTag);if(!t?.length)return{success:!1,error:"è¯¥å…±äº«ç»„æ²¡æœ‰ SKU"};await r.from("product_sku_map").delete().eq("product_id",e);const n=t.map(u=>({product_id:e,sku_id:u.id,sort_order:u.sort_order})),{error:d}=await r.from("product_sku_map").insert(n);return d?{success:!1,error:d.message}:{success:!0}}const{data:a}=await r.from("product_sku_map").select("sku_id").eq("product_id",e),p=new Set((a||[]).map(t=>t.sku_id)),c=s.skus||[],_=new Set(c.filter(t=>t.id).map(t=>t.id)),o=[...p].filter(t=>!_.has(t));o.length>0&&await r.from("product_sku_map").delete().eq("product_id",e).in("sku_id",o);const m=c.filter(t=>t.id&&p.has(t.id));for(const t of m)await r.from("product_skus").update({product_type:t.product_type,spec_combination:t.spec_combination,image:t.image,intro:t.intro,price:t.price,duration:t.duration,sort_order:t.sort_order}).eq("id",t.id).is("tag",null);const i=c.filter(t=>!t.id);if(i.length>0){const t=i.map(u=>({product_type:u.product_type,spec_combination:u.spec_combination,image:u.image,intro:u.intro,price:u.price,duration:u.duration,sort_order:u.sort_order,tag:null})),{data:n,error:d}=await r.from("product_skus").insert(t).select("id");if(!d&&n){const u=n.map((l,y)=>({product_id:e,sku_id:l.id,sort_order:i[y].sort_order}));await r.from("product_sku_map").insert(u)}}return{success:!0}}};export{h as a};
