import{f as q,g as N,r as u,J,G as L,w as z,ac as P,o,i as S,c as i,D as h,a as s,t as n,F as y,k as x,d as V,l as E,n as C,j as Q,aG as W,v as X,_ as A,h as Y,b as B,aH as Z,E as ss}from"./o2XBa361.js";import{t as F}from"./C63Qao53.js";import{u as G}from"./CRWHP3jh.js";import{E as ts}from"./BTJpnMK3.js";/* empty css        *//* empty css        */import{c as es}from"./D52oO6Yy.js";import{v as as}from"./BwD4Hz0h.js";import"./t2w4jifC.js";import"./Bh6H2ams.js";import"./DtTI1xRr.js";import"./CleHDoLI.js";import"./Cq9Fpw4b.js";import"./Ds34GQx2.js";import"./Dzr5IOAO.js";import"./hXKBSGVD.js";import"./B_FoF6yT.js";import"./DVQwC1Y0.js";const os={class:"modal-body"},is={key:0,class:"order-card-glass"},ls={class:"card-image"},ns=["src"],cs={class:"card-info"},rs={class:"info-top"},ds={class:"order-no"},us={class:"status-badge"},vs={class:"product-name"},_s={key:0,class:"specs"},ps={class:"price-row"},ms={class:"price"},hs={class:"quantity"},fs={key:1,class:"order-card-loading"},ks={key:2,class:"ticket-meta-glass"},gs={class:"meta-row"},bs={class:"val"},ys={class:"meta-row"},ws={class:"chat-container"},$s={key:0,class:"avatar admin"},xs={class:"message-content-wrapper"},Cs={class:"message-bubble"},Is={class:"msg-text"},Ds={key:0,class:"msg-attachments"},Ts={class:"message-time"},Ms={key:1,class:"avatar user"},Bs={key:3,class:"reply-area"},Ns=["onKeydown","disabled"],Vs={class:"reply-actions"},Es=["disabled"],Fs=q({__name:"TicketDetailModal",props:{visible:{type:Boolean},ticketId:{}},emits:["update:visible","close","reply-success"],setup(O,{emit:D}){const _=O,m=D,{formatDate:w}=G(),f=N({get:()=>_.visible,set:a=>m("update:visible",a)}),k=N(()=>v.value?.ticket_no?v.value.ticket_no:_.ticketId?`T-${_.ticketId.substring(0,8).toUpperCase()}`:""),g=u(!1),$=u(!1),p=u(!1),v=u(null),d=u(null),c=u([]),t=u(""),T=a=>({active:"使用中",completed:"已完成",pending:"处理中",expired:"已过期",refunding:"退款中",refunded:"已退款"})[a]||a,e=async()=>{if(_.ticketId){g.value=!0;try{const a=await F.getDetail(_.ticketId);if(a.success&&a.data){v.value=a.data,c.value=a.data.replies.map(b=>({sender:b.sender,content:b.content,attachments:b.attachments,time:b.time}));const l=a.data.orders?.id;a.data.orders?.id?I(a.data.orders.id):a.data.order_id&&I(a.data.order_id)}}catch(a){console.error(a)}finally{g.value=!1}}},I=async a=>{$.value=!0;try{const l=await es.getOrderDetail(a);l.success&&l.data&&(d.value=l.data)}finally{$.value=!1}},U=async()=>{if(!(!t.value.trim()||p.value)){p.value=!0;try{(await F.reply(_.ticketId,t.value)).success&&(t.value="",await e(),m("reply-success"))}finally{p.value=!1}}},R=()=>{m("close")};return J(()=>_.visible,a=>{a&&_.ticketId?e():(v.value=null,d.value=null,c.value=[])},{immediate:!0}),(a,l)=>{const b=ts,j=P,H=as;return o(),L(j,{visible:f.value,"onUpdate:visible":l[1]||(l[1]=r=>f.value=r),title:`工单详情 ${k.value}`,width:"700px","show-footer":!1,"show-mascot":"","mascot-position":"right",onClose:R},{default:z(()=>[S((o(),i("div",os,[d.value?(o(),i("div",is,[s("div",ls,[s("img",{src:d.value.product_snapshot?.image,alt:"Product"},null,8,ns)]),s("div",cs,[s("div",rs,[s("span",ds,"订单号 #"+n(d.value.order_no),1),s("span",us,n(T(d.value.status)),1)]),s("div",vs,n(d.value.product_snapshot?.product_name),1),d.value.sku_snapshot?(o(),i("div",_s,[(o(!0),i(y,null,x(d.value.sku_snapshot.spec_combination,(r,M)=>(o(),i("span",{key:M},n(r),1))),128))])):h("",!0),s("div",ps,[s("span",ms,"¥"+n(d.value.total_amount?.toFixed(2)),1),s("span",hs,"x"+n(d.value.quantity),1)])])])):$.value?(o(),i("div",fs,[...l[2]||(l[2]=[s("span",{class:"loading-spinner"},null,-1),V(" 加载订单信息... ",-1)])])):h("",!0),v.value?(o(),i("div",ks,[s("div",gs,[l[3]||(l[3]=s("span",{class:"label"},"提交时间:",-1)),l[4]||(l[4]=V()),s("span",bs,n(E(w)(v.value.created_at)),1)]),s("div",ys,[l[5]||(l[5]=s("span",{class:"label"},"当前状态:",-1)),s("span",{class:C(["status-text",v.value.status])},n(v.value.status==="processing"?"处理中":"已解决"),3)])])):h("",!0),s("div",ws,[(o(!0),i(y,null,x(c.value,(r,M)=>(o(),i("div",{key:M,class:C(["chat-message",r.sender])},[r.sender==="admin"?(o(),i("div",$s,"服")):h("",!0),s("div",xs,[s("div",Cs,[s("div",Is,n(r.content),1),r.attachments&&r.attachments.length?(o(),i("div",Ds,[(o(!0),i(y,null,x(r.attachments,K=>(o(),L(b,{key:K,src:K,class:"attachment-img","preview-src-list":r.attachments,"preview-teleported":"",fit:"cover"},null,8,["src","preview-src-list"]))),128))])):h("",!0)]),s("div",Ts,n(E(w)(r.time)),1)]),r.sender==="user"?(o(),i("div",Ms,"我")):h("",!0)],2))),128))]),v.value?.status==="processing"?(o(),i("div",Bs,[S(s("textarea",{"onUpdate:modelValue":l[0]||(l[0]=r=>t.value=r),class:"reply-textarea",placeholder:"请输入您的回复... (Enter 发送)",onKeydown:Q(W(U,["prevent"]),["enter"]),disabled:p.value},null,40,Ns),[[X,t.value]]),s("div",Vs,[s("button",{class:"btn-send",onClick:U,disabled:!t.value.trim()||p.value},n(p.value?"发送中...":"发送回复"),9,Es)])])):h("",!0)])),[[H,g.value]])]),_:1},8,["visible","title"])}}}),Os=A(Fs,[["__scopeId","data-v-3f3744a9"]]),Us={class:"tickets-section"},Ks={class:"tickets-tabs"},Ls=["onClick"],Ss={class:"tickets-list"},qs={class:"card-header"},zs={class:"header-left"},As={class:"ticket-id"},Gs={class:"ticket-time"},Rs={class:"card-body"},js={class:"ticket-content-text"},Hs={key:0,class:"ticket-meta-row"},Js={class:"product-name"},Ps={class:"order-link"},Qs={class:"card-actions"},Ws=["onClick"],Xs=q({__name:"tickets",setup(O){const{formatDate:D}=G(),_=[{key:"all",label:"全部"},{key:"processing",label:"进行中"},{key:"resolved",label:"已解决"}],m=u("all"),w=u(!1),f=u([]),k=u(!1),g=u(""),$=c=>{m.value=c},p=async()=>{w.value=!0;try{const c=await F.getList();c.success&&c.data&&(f.value=c.data.map(t=>({id:t.id,shortId:t.ticket_no||`T-${t.id.substring(0,8).toUpperCase()}`,content:t.title,time:D(t.created_at),orderId:t.orders?.order_no||"",productName:t.orders?.product_snapshot?.product_name||"通用工单",status:t.status,statusText:t.status==="processing"?"处理中":"已解决",statusClass:t.status==="processing"?"processing":"resolved"})))}catch(c){console.error("Fetch tickets failed",c)}finally{w.value=!1}};Y(p);const v=N(()=>m.value==="all"?f.value:f.value.filter(c=>c.status===m.value)),d=c=>{g.value=c.id,k.value=!0};return(c,t)=>{const T=ss;return o(),i(y,null,[s("div",Us,[t[4]||(t[4]=s("div",{class:"section-header"},[s("h2",{class:"section-title"},"我的工单")],-1)),s("div",Ks,[(o(),i(y,null,x(_,e=>s("div",{key:e.key,class:C(["tab-item",{active:m.value===e.key}]),onClick:I=>$(e.key)},n(e.label),11,Ls)),64))]),s("div",Ss,[(o(!0),i(y,null,x(v.value,e=>(o(),i("div",{class:C(["ticket-card-glass",e.statusClass]),key:e.id},[s("div",qs,[s("div",zs,[s("span",As,n(e.shortId),1),s("div",{class:C(["ticket-status-badge",e.statusClass])},n(e.statusText),3)]),s("span",Gs,n(e.time),1)]),s("div",Rs,[s("div",js,n(e.content),1),e.orderId?(o(),i("div",Hs,[t[2]||(t[2]=s("span",{class:"label"},"关联业务:",-1)),s("span",Js,n(e.productName),1),s("span",Ps,"订单 "+n(e.orderId),1)])):h("",!0)]),s("div",Qs,[s("button",{class:"action-btn glass-btn",onClick:I=>d(e)},[B(T,null,{default:z(()=>[B(E(Z))]),_:1}),t[3]||(t[3]=V(" 查看详情 ",-1))],8,Ws)])],2))),128))])]),B(Os,{visible:k.value,"onUpdate:visible":t[0]||(t[0]=e=>k.value=e),"ticket-id":g.value,onClose:t[1]||(t[1]=e=>k.value=!1),onReplySuccess:p},null,8,["visible","ticket-id"])],64)}}}),ht=A(Xs,[["__scopeId","data-v-476002a0"]]);export{ht as default};
