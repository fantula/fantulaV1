const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BT0O4NXn.js","./gYbOYKrZ.js","./entry.DI7xQWfr.css"])))=>i.map(i=>d[i]);
import{f as Re,g as $,r as f,am as ee,h as Oe,B as E,C as Te,dM as Ae,c as r,a as i,b as t,w as a,l as h,D as R,E as Me,a1 as ze,o as n,d as b,a2 as $e,G as O,t as K,F as I,k as U,b2 as Ke,p as Ne,ek as Be,b1 as je,i as Fe,n as ue,ax as Je,_ as Le}from"./gYbOYKrZ.js";import{E as qe}from"./CswOF4xx.js";import{E as Ge}from"./CFTg8q6G.js";import{E as We}from"./BxcDqkou.js";import{E as Xe,a as He}from"./A8Zj-15Y.js";import{E as Qe,a as Ye}from"./DILJPjji.js";import{E as Ze}from"./DrogL690.js";import{E as et}from"./CzVV9LeR.js";import{a as tt,E as at}from"./CdHOYNgq.js";import{E as lt}from"./BPU0QgcX.js";import{E as ot}from"./B94kvl1B.js";import{E as st}from"./CrM0zeZk.js";import{E as it}from"./CxsxdZaY.js";import{E as nt}from"./BO6-pa8Z.js";import{E as dt}from"./qZy57oqE.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{a as rt,b as ce,c as te}from"./9gheNwfe.js";import{a as q}from"./DMMqLNeM.js";import{v as ut}from"./CUySdIcD.js";import"./D4AXxtJy.js";import"./Dnj8X3EN.js";import"./C5EOtA6j.js";import"./Cq9Fpw4b.js";import"./BdJc3h2o.js";import"./C3yI_83l.js";import"./pxhmPWjv.js";import"./BB_Ol6Sd.js";import"./BNtqh2Az.js";import"./Bh6H2ams.js";import"./CaswxL1d.js";import"./BlcygIWm.js";import"./CUkNyi1D.js";import"./BSx1rCp4.js";import"./B-n2-D39.js";import"./Cr8dt13I.js";import"./DxwfhIR6.js";import"./BYT9QUPE.js";import"./CrRq4wwb.js";import"./YvAJPawC.js";import"./CqTJWtX6.js";import"./MkrgA_tt.js";import"./Djfz0t-N.js";import"./BPYHQo7_.js";import"./DEN0lkI5.js";import"./D6FW0B1r.js";import"./C6CbiQn9.js";import"./B9zwl8KS.js";const ct={class:"cdk-edit-page"},mt={class:"wizard-header"},pt={class:"header-left"},ft={key:0,class:"loading-container"},vt={key:1,class:"wizard-body"},_t={class:"centered-container"},kt={class:"form-card"},gt={class:"form-card"},yt={key:0},bt={class:"form-tip"},Ct={class:"dynamic-fields"},Et={key:1},Vt={class:"kv-list"},wt={key:2},St={class:"form-item"},ht=["src"],It={key:1,class:"placeholder"},Ut={class:"form-actions"},xt={class:"picker-container"},Dt={class:"picker-sidebar"},Pt=["onClick"],Rt={class:"picker-main"},Ot={class:"picker-toolbar"},Tt={class:"picker-grid"},At=["onClick"],Mt={class:"picker-img-name"},zt=Re({__name:"[id]",setup($t){const T=Te(),ae=ze(),N=$(()=>ae.params.id),le=f(!0),G=f(!1),c=f(null),k=ee({stock:0,fields:[]}),y=ee({attributes:[{key:"",value:""}],maxSlots:1}),A=ee({code:""}),oe=$(()=>{const l=c.value?.account_data?.stock||0;return c.value?.status==="idle"?0:Math.max(1,Math.floor(l*.5))}),W=$(()=>oe.value),x=f(""),B=f(!1),M=f(!1),X=f([]),H=f([]),D=f(""),C=f([]),z=f([]),Q=f(!1),se=f([]),j=f([]),P=f(""),w=f(""),me={virtual:"virtual",shared:"shared_account",one_time:"one_time_cdk"},pe=$(()=>{const l=ae.query.type;return me[l]||c.value?.cdk_type||"virtual"}),fe=$(()=>P.value?j.value.filter(l=>l.category_id===P.value):[]);Oe(async()=>{if(!N.value){E.error("无效的 CDK ID"),T.back();return}try{const[l,e]=await Promise.all([rt.getCategories(),ce.getProducts()]);l.success&&(se.value=l.categories),e.success&&(j.value=e.products);const s=await q.getCdkById(N.value);if(s.success&&s.cdk){if(c.value=s.cdk,x.value=s.cdk.account_data?.image||s.cdk.account_data?.common_image||s.cdk.account_data?.help_image||"",s.cdk.cdk_type==="virtual"){k.stock=s.cdk.stock??s.cdk.account_data?.stock??0;try{const u=JSON.parse(s.cdk.code||"{}");k.fields=u.fields||s.cdk.account_data?.fields||[]}catch{k.fields=s.cdk.account_data?.fields||[]}}else if(s.cdk.cdk_type==="shared"){let u={};try{s.cdk.code&&(u=JSON.parse(s.cdk.code))}catch{const p=s.cdk.account_data||{};u=Object.fromEntries(Object.entries(p).filter(([_])=>_!=="template_keys"&&_!=="common_image"&&_!=="help_image"&&_!=="image"))}y.attributes=Object.entries(u).map(([p,_])=>({key:p,value:String(_)})),y.attributes.length===0&&(y.attributes=[{key:"",value:""}]),y.maxSlots=s.cdk.max_slots||1}else s.cdk.cdk_type==="one_time"&&(A.code=s.cdk.code||"");s.cdk.sku_mappings&&s.cdk.sku_mappings.length>0&&(C.value=s.cdk.sku_mappings.map(u=>u.sku_id));let v=s.cdk.product_snapshot?.product_id;if(!v&&C.value.length>0){const{data:u}=await Ae().from("product_sku_map").select("product_id").eq("sku_id",C.value[0]).maybeSingle();v=u?.product_id}if(v){const u=j.value.find(p=>p.id===v);u&&(P.value=u.category_id||"",w.value=v,await ne(v))}}else E.error(s.error||"获取 CDK 详情失败"),T.back()}finally{le.value=!1}});const ve=l=>({virtual:"虚拟充值",shared:"账号/合租",one_time:"激活码"})[l||""]||l||"-",_e=l=>({idle:"空闲",using:"使用中",used:"已使用"})[l||""]||l||"-",ie=l=>({idle:"success",using:"warning",used:"info"})[l||""]||"info",ne=async l=>{Q.value=!0;try{const e=await ce.getProductWithSkus(l);if(e.success&&e.skus){const s=pe.value;let m=e.skus;s&&(m=m.filter(v=>v.product_type===s)),z.value=m.map(v=>{const u=Object.values(v.spec_combination||{}).join(" ");return{id:v.id,label:u||"默认规格"}})}}finally{Q.value=!1}},ke=()=>{w.value="",C.value=[],z.value=[]},ge=async l=>{C.value=[],z.value=[],l&&await ne(l)},ye=()=>k.fields.push(""),be=l=>k.fields.splice(l,1),Ce=()=>y.attributes.push({key:"",value:""}),Ee=l=>{if(y.attributes.length===1){E.warning("至少保留一个属性");return}y.attributes.splice(l,1)},Ve=async()=>{if(B.value=!0,H.value.length===0){const l=await te.imageCategory.getCategories();l.success&&(H.value=l.categories)}F()},F=async()=>{M.value=!0;const l=await te.image.getImages({category_id:D.value});l.success&&(X.value=l.images),M.value=!1},de=l=>{x.value=l,B.value=!1,E.success("已选择图片")},we=async l=>{M.value=!0;try{const{uploadImageToStorage:e}=await Je(async()=>{const{uploadImageToStorage:m}=await import("./BT0O4NXn.js");return{uploadImageToStorage:m}},__vite__mapDeps([0,1,2]),import.meta.url),s=await e(l.raw);s.success&&(await te.image.createImage({name:l.name,url:s.url,category_id:D.value||void 0}),de(s.url),F())}finally{M.value=!1}},Se=async()=>{if(c.value){G.value=!0;try{const l={account_data:x.value?{image:x.value}:null};if(w.value){const d=j.value.find(g=>g.id===w.value);d&&(l.product_snapshot={product_id:d.id,product_name:d.product_name,product_image:d.image||void 0})}if(c.value.cdk_type==="virtual"){if(k.stock<W.value){E.error(`库存不能小于已使用数量 (${W.value})`);return}l.stock=k.stock,l.code=JSON.stringify({fields:k.fields.filter(d=>d.trim())})}else if(c.value.cdk_type==="shared"){const d={};y.attributes.forEach(g=>{g.key&&(d[g.key]=g.value)}),l.code=JSON.stringify(d),l.max_slots=y.maxSlots}else if(c.value.cdk_type==="one_time"){if(!A.code.trim()){E.error("激活码不能为空");return}l.code=A.code.trim()}const e=await q.updateCdk(N.value,l);if(!e.success){E.error(e.error||"保存失败");return}const s=c.value.sku_mappings||[],m=s.map(d=>d.sku_id),v=s.filter(d=>!C.value.includes(d.sku_id));for(const d of v){const g=await q.removeCdkSkuMapping(d.id);g.success||E.error(`解绑失败: ${g.error}`)}const u=C.value.filter(d=>!m.includes(d));for(const d of u){const g=await q.addCdkSkuMapping(N.value,d);g.success||E.warning(`SKU 绑定失败: ${g.error}`)}E.success("保存成功");const _={virtual:"virtual",shared:"accounts",one_time:"keys"}[c.value?.cdk_type||""]||"virtual";T.push(`/_mgmt_9Xfa3/cdk/${_}`)}finally{G.value=!1}}};return(l,e)=>{const s=Me,m=qe,v=Ge,u=We,p=He,_=Ye,d=Ze,g=Qe,J=et,Y=at,Z=tt,he=lt,L=Xe,re=ot,Ie=st,Ue=it,xe=nt,De=dt,Pe=ut;return n(),r("div",ct,[i("div",mt,[i("div",pt,[t(m,{link:"",class:"back-btn",onClick:e[0]||(e[0]=o=>h(T).back())},{default:a(()=>[t(s,{class:"back-icon"},{default:a(()=>[t(h($e))]),_:1}),e[10]||(e[10]=b(" 返回列表 ",-1))]),_:1}),e[11]||(e[11]=i("div",{class:"header-titles"},[i("div",{class:"main-title"},"编辑资源"),i("div",{class:"sub-title"},"EDIT RESOURCE")],-1))]),e[12]||(e[12]=i("div",{class:"header-center"},null,-1)),e[13]||(e[13]=i("div",{class:"header-right"},null,-1))]),le.value?(n(),r("div",ft,[t(v,{rows:8,animated:""})])):(n(),r("div",vt,[i("div",_t,[i("div",kt,[e[16]||(e[16]=i("h3",{class:"card-title"},"基础信息",-1)),t(L,{"label-position":"top"},{default:a(()=>[t(g,{gutter:20},{default:a(()=>[t(_,{span:8},{default:a(()=>[t(p,{label:"CDK 类型"},{default:a(()=>[t(u,{type:ie(c.value?.cdk_type),size:"large"},{default:a(()=>[b(K(ve(c.value?.cdk_type)),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(_,{span:8},{default:a(()=>[t(p,{label:"当前状态"},{default:a(()=>[t(u,{type:ie(c.value?.status)},{default:a(()=>[b(K(_e(c.value?.status)),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(_,{span:8},{default:a(()=>[t(p,{label:"CDK ID"},{default:a(()=>[t(d,{value:c.value?.id,disabled:"",size:"small",style:{"font-family":"monospace","font-size":"12px"}},null,8,["value"])]),_:1})]),_:1})]),_:1}),t(J,{"content-position":"left"},{default:a(()=>[...e[14]||(e[14]=[b("商品关联",-1)])]),_:1}),t(g,{gutter:20},{default:a(()=>[t(_,{span:8},{default:a(()=>[t(p,{label:"商品分类"},{default:a(()=>[t(Z,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=o=>P.value=o),placeholder:"请选择分类",filterable:"",onChange:ke,style:{width:"100%"}},{default:a(()=>[(n(!0),r(I,null,U(se.value,o=>(n(),O(Y,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(_,{span:8},{default:a(()=>[t(p,{label:"选择商品"},{default:a(()=>[t(Z,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=o=>w.value=o),placeholder:"请选择商品",filterable:"",onChange:ge,disabled:!P.value,style:{width:"100%"}},{default:a(()=>[(n(!0),r(I,null,U(fe.value,o=>(n(),O(Y,{key:o.id,label:o.product_name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(_,{span:8},{default:a(()=>[t(p,{label:"关联 SKU (可多选)"},{default:a(()=>[t(Z,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=o=>C.value=o),multiple:"",placeholder:"选择 SKU",filterable:"",loading:Q.value,disabled:!w.value,style:{width:"100%"}},{default:a(()=>[(n(!0),r(I,null,U(z.value,o=>(n(),O(Y,{key:o.id,label:o.label,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1})]),_:1})]),_:1}),C.value.length===0&&z.value.length>0?(n(),O(he,{key:0,type:"warning",closable:!1,style:{"margin-top":"8px"}},{title:a(()=>[...e[15]||(e[15]=[b("⚠️ 该 CDK 未绑定 SKU，请选择 SKU 进行关联",-1)])]),_:1})):R("",!0)]),_:1})]),i("div",gt,[e[27]||(e[27]=i("h3",{class:"card-title"},"资源配置 (可编辑)",-1)),c.value?.cdk_type==="virtual"?(n(),r("div",yt,[t(L,{model:k,"label-position":"top"},{default:a(()=>[t(p,{label:"可用库存数"},{default:a(()=>[t(re,{modelValue:k.stock,"onUpdate:modelValue":e[4]||(e[4]=o=>k.stock=o),min:W.value,size:"large",style:{width:"100%"}},null,8,["modelValue","min"]),i("div",bt," 已使用: "+K(oe.value)+" 个，最小值不能低于已使用数量 ",1)]),_:1}),t(J,{"content-position":"left"},{default:a(()=>[...e[17]||(e[17]=[b("订单填写字段配置",-1)])]),_:1}),i("div",Ct,[(n(!0),r(I,null,U(k.fields,(o,V)=>(n(),r("div",{key:V,class:"field-row"},[t(d,{modelValue:k.fields[V],"onUpdate:modelValue":S=>k.fields[V]=S,placeholder:"输入字段名 (如: 游戏账号)"},null,8,["modelValue","onUpdate:modelValue"]),t(m,{type:"danger",circle:"",plain:"",onClick:S=>be(V)},{default:a(()=>[t(s,null,{default:a(()=>[t(h(Ke))]),_:1})]),_:1},8,["onClick"])]))),128)),t(m,{type:"dashed",class:"add-field-btn",onClick:ye},{default:a(()=>[t(s,null,{default:a(()=>[t(h(Ne))]),_:1}),e[18]||(e[18]=b(" 添加字段 ",-1))]),_:1})])]),_:1},8,["model"])])):R("",!0),c.value?.cdk_type==="shared"?(n(),r("div",Et,[t(L,{"label-position":"top"},{default:a(()=>[t(p,{label:"最大车位数"},{default:a(()=>[t(re,{modelValue:y.maxSlots,"onUpdate:modelValue":e[5]||(e[5]=o=>y.maxSlots=o),min:1,max:10},null,8,["modelValue"]),e[19]||(e[19]=i("div",{class:"form-tip"},"决定该资源可同时服务的用户数",-1))]),_:1}),t(J,{"content-position":"left"},{default:a(()=>[...e[20]||(e[20]=[b("属性配置",-1)])]),_:1}),i("div",Vt,[(n(!0),r(I,null,U(y.attributes,(o,V)=>(n(),r("div",{key:V,class:"kv-row"},[t(d,{modelValue:o.key,"onUpdate:modelValue":S=>o.key=S,placeholder:"字段名(如:账号)",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"]),e[21]||(e[21]=i("span",{class:"separator"},":",-1)),t(d,{modelValue:o.value,"onUpdate:modelValue":S=>o.value=S,placeholder:"字段值",style:{flex:"1"}},null,8,["modelValue","onUpdate:modelValue"]),y.attributes.length>1?(n(),O(m,{key:0,circle:"",plain:"",size:"small",onClick:S=>Ee(V)},{default:a(()=>[t(s,null,{default:a(()=>[t(h(Be))]),_:1})]),_:1},8,["onClick"])):R("",!0)]))),128)),t(m,{type:"dashed",size:"small",class:"add-attr-btn",onClick:Ce},{default:a(()=>[...e[22]||(e[22]=[b(" + 添加属性 ",-1)])]),_:1})])]),_:1})])):R("",!0),c.value?.cdk_type==="one_time"?(n(),r("div",wt,[t(L,{"label-position":"top"},{default:a(()=>[t(p,{label:"激活码内容"},{default:a(()=>[t(d,{modelValue:A.code,"onUpdate:modelValue":e[6]||(e[6]=o=>A.code=o),placeholder:"输入激活码"},null,8,["modelValue"]),e[23]||(e[23]=i("div",{class:"form-tip"},"注意：更改后会影响已关联的订单",-1))]),_:1})]),_:1})])):R("",!0),t(J,{"content-position":"left"},{default:a(()=>[...e[24]||(e[24]=[b("详情页帮助图片",-1)])]),_:1}),i("div",St,[i("div",{class:"image-selector",onClick:Ve},[x.value?(n(),r("img",{key:0,src:x.value,class:"preview-img"},null,8,ht)):(n(),r("div",It,[t(s,{size:24},{default:a(()=>[t(h(je))]),_:1}),e[25]||(e[25]=i("span",null,"点击选择图片",-1))]))]),e[26]||(e[26]=i("div",{class:"form-tip",style:{"margin-top":"8px"}}," 将在客户端订单详情页展示，用于引导用户使用 ",-1))])]),i("div",Ut,[t(m,{onClick:e[7]||(e[7]=o=>h(T).back())},{default:a(()=>[...e[28]||(e[28]=[b("取消",-1)])]),_:1}),t(m,{type:"primary",onClick:Se,loading:G.value},{default:a(()=>[...e[29]||(e[29]=[b(" 保存修改 ",-1)])]),_:1},8,["loading"])])])])),t(De,{modelValue:B.value,"onUpdate:modelValue":e[9]||(e[9]=o=>B.value=o),title:"选择图片",width:"800px","append-to-body":""},{default:a(()=>[i("div",xt,[i("div",Dt,[i("div",{class:ue(["picker-cat-item",{active:D.value===""}]),onClick:e[8]||(e[8]=o=>{D.value="",F()})},"全部图片",2),(n(!0),r(I,null,U(H.value,o=>(n(),r("div",{key:o.id,class:ue(["picker-cat-item",{active:D.value===o.id}]),onClick:V=>{D.value=o.id,F()}},K(o.name),11,Pt))),128))]),Fe((n(),r("div",Rt,[i("div",Ot,[t(Ie,{action:"#","auto-upload":!1,"show-file-list":!1,"on-change":we},{default:a(()=>[t(m,{type:"primary",size:"small"},{default:a(()=>[...e[30]||(e[30]=[b("上传新图片",-1)])]),_:1})]),_:1})]),i("div",Tt,[(n(!0),r(I,null,U(X.value,o=>(n(),r("div",{key:o.id,class:"picker-img-card",onClick:V=>de(o.url)},[t(Ue,{src:o.url,fit:"cover"},null,8,["src"]),i("div",Mt,K(o.name),1)],8,At))),128))]),X.value.length===0?(n(),O(xe,{key:0,description:"暂无图片"})):R("",!0)])),[[Pe,M.value]])])]),_:1},8,["modelValue"])])}}}),Wa=Le(zt,[["__scopeId","data-v-2f9cf01b"]]);export{Wa as default};
