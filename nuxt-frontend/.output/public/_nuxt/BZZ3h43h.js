import{ad as x,f as H,r as f,h as J,g as K,c as n,a as t,D as v,G as S,w as y,F as A,k as E,b as c,aB as Y,B as j,E as O,C as Q,o as a,l as R,H as W,n as U,d as T,t as C,a8 as D,M as X,aJ as Z,Y as ee,aK as se,aL as te,_ as ae}from"./o2XBa361.js";import{a as oe,E as re}from"./C9v55j5T.js";import{E as ne}from"./BOgRz4Th.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import"./CrjkcmUY.js";import"./qVmxJdp3.js";import"./CqX7ZdKI.js";import"./Dlk0BVst.js";import"./DtTI1xRr.js";import"./Bh6H2ams.js";import"./t2w4jifC.js";import"./Dnj8X3EN.js";import"./ClnTspdU.js";import"./Cq9Fpw4b.js";import"./DC3lfPj1.js";import"./Culj45X8.js";import"./B8yeDp5P.js";import"./B_FoF6yT.js";import"./BlW_46uR.js";import"./Ds34GQx2.js";import"./Dzr5IOAO.js";import"./1SfIsks3.js";import"./BB_Ol6Sd.js";import"./DVQwC1Y0.js";import"./Z6faUBN3.js";import"./KSqZSeJ0.js";import"./CQuNCUIC.js";const M={async getMessages(d=1,i=20){const o=x(),{data:{user:l}}=await o.auth.getUser();if(!l)return{code:401,msg:"未登录",success:!1};const u=(d-1)*i,{data:k,error:_,count:m}=await o.from("messages").select("*",{count:"exact"}).eq("user_id",l.id).order("created_at",{ascending:!1}).range(u,u+i-1);return _?(console.error("getMessages error:",_),{code:500,msg:_.message,success:!1}):{code:0,msg:"success",success:!0,data:{messages:k||[],total:m||0}}},async getUnreadCount(){const d=x(),{data:{user:i}}=await d.auth.getUser();if(!i)return{code:401,msg:"未登录",success:!1};const{count:o,error:l}=await d.from("messages").select("*",{count:"exact",head:!0}).eq("user_id",i.id).eq("is_read",!1);return l?(console.error("getUnreadCount error:",l),{code:500,msg:l.message,success:!1}):{code:0,msg:"success",success:!0,data:o||0}},async markAsRead(d){const i=x(),{error:o}=await i.from("messages").update({is_read:!0}).eq("id",d);return o?(console.error("markAsRead error:",o),{code:500,msg:o.message,success:!1}):{code:0,msg:"success",success:!0}},async markAllAsRead(){const d=x(),{data:{user:i}}=await d.auth.getUser();if(!i)return{code:401,msg:"未登录",success:!1};const{error:o}=await d.from("messages").update({is_read:!0}).eq("user_id",i.id).eq("is_read",!1);return o?(console.error("markAllAsRead error:",o),{code:500,msg:o.message,success:!1}):{code:0,msg:"success",success:!0}}},ie={class:"messages-section"},le={class:"section-header"},ce=["disabled"],de={key:1},ue={class:"message-tabs"},me=["onClick"],_e={key:0,class:"badge"},pe={key:1,class:"active-indicator"},fe={class:"message-list-container"},ge={key:0,class:"loading-state"},ve={style:{display:"flex",gap:"16px",padding:"20px"}},ye={style:{flex:"1"}},ke={key:1,class:"empty-state"},he={class:"empty-icon-wrap"},we={key:2,class:"message-list"},Ce=["onClick"],be={class:"message-content"},xe={class:"message-top"},Me={class:"message-title"},Ae={class:"message-time"},Ee={class:"message-body"},Re={key:0,class:"message-link-hint"},Ue={key:0,class:"unread-dot"},De={key:3,class:"pagination-wrap"},q=20,qe=H({__name:"messages",setup(d){const i=Q(),o=f(!0),l=f(!1),u=f([]),k=f(0),_=f(1),m=f("all"),g=f(0),$=[{key:"all",label:"全部"},{key:"unread",label:"未读"},{key:"order",label:"订单"},{key:"system",label:"系统"}],B=async()=>{o.value=!0;try{const e=await M.getMessages(_.value,q);e.success&&e.data&&(u.value=e.data.messages,k.value=e.data.total)}finally{o.value=!1}},I=async()=>{const e=await M.getUnreadCount();e.success&&e.data!==void 0&&(g.value=e.data)};J(()=>{B(),I()});const N=K(()=>m.value==="all"?u.value:m.value==="unread"?u.value.filter(e=>!e.is_read):u.value.filter(e=>e.type===m.value)),z=async e=>{e.is_read||(await M.markAsRead(e.id),e.is_read=!0,g.value=Math.max(0,g.value-1)),e.link&&i.push(e.link)},V=async()=>{if(!l.value){l.value=!0;try{(await M.markAllAsRead()).success&&(u.value.forEach(r=>r.is_read=!0),g.value=0,j.success("已全部标记为已读"))}finally{l.value=!1}}},L=e=>`type-${e}`,P=e=>({system:D,order:te,activity:se,security:ee})[e]||D,F=e=>{const r=new Date(e),p=new Date().getTime()-r.getTime(),w=Math.floor(p/6e4),b=Math.floor(p/36e5),s=Math.floor(p/864e5);return w<1?"刚刚":w<60?`${w} 分钟前`:b<24?`${b} 小时前`:s<7?`${s} 天前`:r.toLocaleDateString("zh-CN")};return(e,r)=>{const h=O,p=oe,w=re,b=ne;return a(),n("div",ie,[t("div",le,[r[1]||(r[1]=t("div",{class:"header-left"},[t("h2",{class:"section-title"},"消息中心"),t("div",{class:"section-subtitle"},"Notifications")],-1)),u.value.length>0?(a(),n("button",{key:0,class:"read-all-btn",onClick:V,disabled:l.value},[l.value?(a(),S(h,{key:0},{default:y(()=>[c(R(W))]),_:1})):(a(),n("span",de,"全部已读"))],8,ce)):v("",!0)]),t("div",ue,[(a(),n(A,null,E($,s=>t("div",{key:s.key,class:U(["tab-item",{active:m.value===s.key}]),onClick:G=>m.value=s.key},[T(C(s.label)+" ",1),s.key==="unread"&&g.value>0?(a(),n("span",_e,C(g.value),1)):v("",!0),m.value===s.key?(a(),n("div",pe)):v("",!0)],10,me)),64))]),t("div",fe,[o.value?(a(),n("div",ge,[(a(),n(A,null,E(3,s=>c(w,{animated:"",key:s,class:"skeleton-item"},{template:y(()=>[t("div",ve,[c(p,{variant:"circle",style:{width:"48px",height:"48px"}}),t("div",ye,[c(p,{variant:"h3",style:{width:"40%","margin-bottom":"12px"}}),c(p,{variant:"text",style:{width:"80%"}})])])]),_:1})),64))])):N.value.length===0?(a(),n("div",ke,[t("div",he,[c(h,{class:"empty-icon"},{default:y(()=>[c(R(D))]),_:1})]),r[2]||(r[2]=t("div",{class:"empty-text"},"暂无消息",-1)),r[3]||(r[3]=t("div",{class:"empty-desc"},"所有通知和提醒都会显示在这里",-1))])):(a(),n("div",we,[c(Y,{name:"list"},{default:y(()=>[(a(!0),n(A,null,E(N.value,s=>(a(),n("div",{key:s.id,class:U(["message-card",{unread:!s.is_read,clickable:!!s.link}]),onClick:G=>z(s)},[t("div",{class:U(["message-icon",L(s.type)])},[c(h,null,{default:y(()=>[(a(),S(X(P(s.type))))]),_:2},1024)],2),t("div",be,[t("div",xe,[t("span",Me,C(s.title),1),t("span",Ae,C(F(s.created_at)),1)]),t("div",Ee,C(s.content),1),s.link?(a(),n("div",Re,[c(h,null,{default:y(()=>[c(R(Z))]),_:1}),r[4]||(r[4]=T(" 点击查看详情 ",-1))])):v("",!0)]),s.is_read?v("",!0):(a(),n("div",Ue))],10,Ce))),128))]),_:1})])),k.value>q?(a(),n("div",De,[c(b,{background:"",layout:"prev, pager, next",total:k.value,"page-size":q,"current-page":_.value,"onUpdate:currentPage":r[0]||(r[0]=s=>_.value=s),onCurrentChange:B},null,8,["total","current-page"])])):v("",!0)])])}}}),us=ae(qe,[["__scopeId","data-v-e9aba4d8"]]);export{us as default};
