import{bj as y,bk as n,ad as _}from"./o2XBa361.js";const k={async getGoodsList(t){let e=_().from("products").select("*",{count:"exact"}).eq("status","on");t.categoryId&&t.categoryId!=="all"&&(e=e.eq("category_id",t.categoryId)),t.keyword&&(e=e.ilike("product_name",`%${t.keyword}%`));const u=t.sortBy==="price"?"display_price":t.sortBy==="sales"?"initial_sales":"sort_order";e=e.order(u,{ascending:t.sortOrder!=="desc"});const r=t.page||1,c=t.limit||12,p=(r-1)*c;e=e.range(p,p+c-1);const{data:l,error:g,count:d}=await e;if(g)return{code:500,msg:g.message,data:{list:[],total:0,page:r,limit:c,totalPage:0},success:!1};const m=(l||[]).map(s=>({id:s.id,title:s.product_name,product_name:s.product_name,coverImage:s.image||"",image:s.image||"",description:"",price:Number(s.display_price)||0,display_price:Number(s.display_price)||0,sales:s.initial_sales||0,initial_sales:s.initial_sales||0,rating:s.rating||100,status:s.status==="on"?1:0,badge_label:s.badge_label,tags:(s.tags||[]).join(","),category_id:s.category_id})),o=d||0,i=Math.ceil(o/c);return{code:0,msg:"success",data:{list:m,total:o,page:r,limit:c,totalPage:i},success:!0}},async getGoodsDetail(t){try{const a=_(),{data:e,error:u}=await a.from("products").select("*").eq("id",t).single();if(u||!e)return{code:404,msg:u?.message||"商品不存在",data:null,success:!1};const{data:r,error:c}=await a.from("product_sku_map").select("sku:product_skus(*)").eq("product_id",t).order("sort_order",{ascending:!0});c&&console.error("获取 SKU 列表失败:",c);const l=((r||[]).map(o=>o.sku).filter(Boolean)||[]).map(o=>{const i=o.spec_combination,s=Object.entries(i)[0]||[];return{id:o.id,spec_name:s[0]||"",spec_value:s[1]||"",spec_combination:i,price:Number(o.price),stock:0,image:o.image,intro:o.intro,duration:o.duration}}),g=[],d={};return l.forEach(o=>{const i=o.spec_combination||{};Object.entries(i).forEach(([s,f])=>{d[s]||(d[s]=new Set),d[s].add(f)})}),Object.keys(d).forEach(o=>{g.push({name:o,values:Array.from(d[o])})}),{code:0,msg:"success",data:{id:e.id,title:e.product_name,product_name:e.product_name,coverImage:e.image||"",image:e.image||"",description:e.description||"",price:Number(e.display_price)||l[0]?.price||0,display_price:Number(e.display_price)||0,sales:e.initial_sales||0,initial_sales:e.initial_sales||0,rating:e.rating||100,status:e.status==="on"?1:0,badge_label:e.badge_label,tags:(e.tags||[]).join(","),skus:l,detail_modules:e.detail_modules||[],specGroups:g,allow_addon:e.allow_addon===!0},success:!0}}catch(a){return console.error("获取商品详情失败:",a),{code:500,msg:"获取商品详情失败",data:null,success:!1}}},getHotGoods(t=8){return n.get("/product/goods",{limit:t,isHot:!0})},getRecommendGoods(t=8){return n.get("/product/goods",{limit:t,isRecommend:!0})},async getCategories(){const t=_(),{data:a,error:e}=await t.from("product_categories").select("*").eq("status","on").order("sort_order",{ascending:!0});return e?{code:500,msg:e.message,data:[],success:!1}:{code:0,msg:"success",data:(a||[]).map(r=>({id:r.id,name:r.name,sort:r.sort_order,status:r.status==="on"?1:0})),success:!0}},searchGoods(t){return n.get("/product/goods",t)},getGoodsSkuInfo(t){return n.get(`/product/goods/getSkuInfo/${t}`)},getSkuByUnicode(t){return n.get(`/product/goods/getSkuByUnicode/${t}`)},getSkuResidue(t){return n.get(`/product/goods/getSkuResidue/${t}`)},async getProductStock(t){const{data:a,error:e}=await y("products",{method:"GET",params:{id:String(t)}});return e?(console.error("获取库存失败:",e),{code:500,msg:e,data:0,success:!1}):{code:0,msg:"success",data:a?.stock??0,success:!0}}};export{k as g};
