import{ad as o}from"./o2XBa361.js";const p={async getOrderList(s){let e=o().from("orders").select("id, order_no, order_type, status, quantity, total_amount, created_at, expires_at, product_snapshot, sku_snapshot").order("created_at",{ascending:!1});s?.limit&&(e=e.limit(s.limit)),s?.status&&s.status!=="all"&&(e=e.eq("status",s.status));const{data:r,error:c}=await e;return c?(console.error("获取订单列表失败:",c),{success:!1,error:c.message}):{success:!0,data:r||[]}},async getOrderDetail(s){const t=o(),{data:e,error:r}=await t.from("orders").select("*, cdk_snapshot, slot_occupancy_ids").eq("id",s).single();if(r||!e)return{success:!1,error:r?.message||"订单不存在"};let c=[];const a=e.cdk_snapshot?.locked_cdk_ids||e.cdk_snapshot||[],n=Array.isArray(a)?a:a.locked_cdk_ids||[];if(n.length>0){const{data:u}=await t.from("cdks").select("id, code, account_data").in("id",n);u&&(c=u.map(d=>{let _=null;try{_=JSON.parse(d.code)}catch{}return{id:d.id,code:d.code,parsed:_,accountData:d.account_data}}))}let i=[];if(e.slot_occupancy_ids&&e.slot_occupancy_ids.length>0){const{data:u}=await t.from("slot_occupancies").select("id, slot_index, cdk_id").in("id",e.slot_occupancy_ids);u&&(i=u)}return{success:!0,data:{...e,cdkList:c,slotList:i}}},async getPendingPreOrders(){const s=o(),{data:t,error:e}=await s.from("pre_orders").select("*").eq("status","pending").gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1});return e?{success:!1,error:e.message}:{success:!0,data:t||[]}},async getPreOrderDetail(s){const t=o(),{data:e,error:r}=await t.rpc("get_pre_order",{p_pre_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0,data:e.pre_order}:{success:!1,error:e?.error||"预订单不存在"}},async createPreOrder(s,t=1,e="buy_now"){const r=o(),{data:c,error:a}=await r.rpc("create_pre_order",{p_sku_id:s,p_quantity:t,p_source:e});return a?{success:!1,error:a.message}:c?.success?{success:!0,preOrderId:c.pre_order_id,orderNo:c.order_no,totalAmount:c.total_amount,expiresAt:c.expires_at}:{success:!1,error:c?.error||"创建预订单失败"}},async confirmPreOrder(s,t,e){const r=o(),c={p_pre_order_id:s,p_pay_method:t};e&&(c.p_coupon_id=e);const{data:a,error:n}=await r.rpc("confirm_pre_order",c);return n?{success:!1,error:n.message}:a?.success?{success:!0,orderNo:a.order_no,orderId:a.order_id,totalAmount:a.total_amount}:{success:!1,error:a?.error||"支付失败"}},async cancelPreOrder(s){const t=o(),{data:e,error:r}=await t.rpc("cancel_pre_order",{p_pre_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0}:{success:!1,error:e?.error||"取消失败"}},async applyCoupon(s,t){const e=o(),{data:r,error:c}=await e.rpc("apply_coupon_to_pre_order",{p_pre_order_id:s,p_coupon_id:t});return c?{success:!1,error:c.message}:r?.success?{success:!0,totalAmount:r.total_amount,discountAmount:r.discount_amount}:{success:!1,error:r?.error||"应用优惠券失败"}},async getRenewalSkus(s){const t=o(),{data:e,error:r}=await t.rpc("get_renewal_skus",{p_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0,orderId:e.order_id,cdkId:e.cdk_id,endTime:e.end_time,product:e.product,skus:e.skus||[]}:{success:!1,error:e?.error||"获取续费SKU失败"}},async createRenewalPreOrder(s,t){const e=o(),{data:r,error:c}=await e.rpc("create_renewal_pre_order",{p_sku_id:s,p_old_order_id:t});return c?{success:!1,error:c.message}:r?.success?{success:!0,preOrderId:r.pre_order_id,orderNo:r.order_no,totalAmount:r.total_amount,expiresAt:r.expires_at}:{success:!1,error:r?.error||"创建续费订单失败"}},async createRefundRequest(s,t,e=""){const r=o(),{data:c,error:a}=await r.rpc("create_refund_request",{p_order_id:s,p_reason:t,p_reason_detail:e});return a?{success:!1,error:a.message}:c?.success?{success:!0,requestId:c.request_id,message:c.message}:{success:!1,error:c?.error||"申请失败"}},async getRefundRequest(s){const t=o(),{data:e,error:r}=await t.rpc("get_refund_request",{p_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0,data:e.request}:{success:!1,error:e?.error}},async cancelRefundRequest(s){const t=o(),{data:e,error:r}=await t.rpc("cancel_user_refund_request",{p_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0,message:e.message}:{success:!1,error:e?.error||"取消失败"}},async getOrderRefundInfo(s){const t=o(),{data:e,error:r}=await t.rpc("get_order_refund_info",{p_order_id:s});return r?{success:!1,error:r.message}:e?.success?{success:!0,pendingRequest:e.pending_request,cancelledCount:e.cancelled_count}:{success:!1,error:e?.error}}};export{p as c};
