import{P as ae}from"./DLUP05ph.js";import{E as se}from"./-Yx_0iEM.js";import{A as re}from"./DHlfceZi.js";import{E as oe}from"./C9v55j5T.js";import{E as le}from"./Ci1VNkC9.js";import{E as ne}from"./DC3lfPj1.js";import{E as ie}from"./C8ZH7i_a.js";import{E as me}from"./DRc0BmOG.js";import{A as de}from"./BrR7l0bw.js";import{E as ue}from"./1SfIsks3.js";import{E as pe,a as ce}from"./0BTaD5f-.js";import{a as fe,E as _e}from"./CrjkcmUY.js";import{E as ge,b as ve}from"./BriuKwPI.js";import{E as be}from"./CziALilw.js";import{dM as C,f as ye,r as _,am as T,h as we,c as A,b as r,G as D,w as o,B as d,o as g,l as B,a_ as Ee,d as p,p as Ue,t as I,D as he,F as Ve,k as ke,a as Ce,_ as Ae}from"./o2XBa361.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{a as De}from"./Ck175W9H.js";import{u as xe}from"./CRWHP3jh.js";import"./COgFiiev.js";import"./CQuNCUIC.js";/* empty css        */import"./Culj45X8.js";import"./Dnj8X3EN.js";import"./DytS51kl.js";/* empty css        */import"./ClnTspdU.js";import"./Cq9Fpw4b.js";import"./CqX7ZdKI.js";import"./Dlk0BVst.js";import"./qVmxJdp3.js";import"./DtTI1xRr.js";import"./Bh6H2ams.js";import"./t2w4jifC.js";import"./C9zJf5rn.js";import"./Bx0EXMjc.js";import"./Z6faUBN3.js";import"./BlW_46uR.js";import"./hXKBSGVD.js";import"./B_FoF6yT.js";import"./BCItYl8Z.js";import"./BB_Ol6Sd.js";import"./Dzr5IOAO.js";import"./DwwA_QlG.js";import"./C1T5KPmY.js";import"./BOgRz4Th.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        */import"./BwD4Hz0h.js";import"./DVQwC1Y0.js";import"./B8yeDp5P.js";import"./Ds34GQx2.js";import"./KSqZSeJ0.js";import"./FKUjHIpz.js";import"./D6FW0B1r.js";import"./CleHDoLI.js";const V={async getUsers(){const l=C(),{data:n,error:i}=await l.from("admin_users").select(`
                *,
                department:admin_departments(id, name, permissions)
            `).order("created_at",{ascending:!1});return i?{success:!1,users:[],error:i.message}:{success:!0,users:n||[]}},async createUser(l){const n=C(),{data:i,error:m}=await n.auth.admin.createUser({email:l.email,password:l.password,email_confirm:!0,user_metadata:{name:l.name,role:"admin"}});if(m)return m.message.includes("already been registered")?{success:!1,error:"该邮箱已被注册"}:{success:!1,error:`创建认证用户失败: ${m.message}`};if(!i.user)return{success:!1,error:"创建认证用户失败：未返回用户信息"};const c=new TextEncoder,v=await crypto.subtle.digest("SHA-256",c.encode(l.password)),x=Array.from(new Uint8Array(v)).map(b=>b.toString(16).padStart(2,"0")).join(""),{data:f,error:u}=await n.from("admin_users").insert({name:l.name,email:l.email,password_hash:x,auth_user_id:i.user.id,department_id:l.department_id??null,status:l.status??"enabled"}).select().single();return u?(await n.auth.admin.deleteUser(i.user.id),{success:!1,error:`创建管理员记录失败: ${u.message}`}):{success:!0,user:f}},async updateUser(l,n){const i=C(),{error:m}=await i.from("admin_users").update(n).eq("id",l);return m?{success:!1,error:m.message}:{success:!0}},async deleteUser(l){const n=C(),{data:i,error:m}=await n.from("admin_users").select("auth_user_id").eq("id",l).single();if(m)return{success:!1,error:`获取用户信息失败: ${m.message}`};const c=i?.auth_user_id,{error:v}=await n.from("admin_users").delete().eq("id",l);if(v)return{success:!1,error:v.message};if(c){const{error:w}=await n.auth.admin.deleteUser(c);w&&console.warn(`删除 Auth 用户失败 (${c}):`,w.message)}return{success:!0}}},Fe={class:"page-container"},Se={key:0,class:"skeleton-container"},Be={key:1,class:"text-gray"},$e={class:"dialog-footer"},qe=ye({name:"UserAccounts",__name:"index",setup(l){const{formatDate:n}=xe(),i=_(!0),m=_(!1),c=_(!1),v=_([]),w=_([]),x=_([]),f=_(!1),u=_(!1),b=_(),t=T({id:"",name:"",email:"",password:"",department_id:"",status:"enabled"}),F=T({name:[{required:!0,message:"请输入名称",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"邮箱格式不正确",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],department_id:[{required:!0,message:"请选择部门",trigger:"change"}]}),U=async()=>{m.value=!0;try{const a=await V.getUsers();a.success&&(v.value=a.users)}catch(a){d.error(a.message||"加载用户失败")}finally{m.value=!1,i.value=!1}},$=async()=>{try{const a=await De.getDepartments();a.success&&(w.value=a.departments)}catch(a){d.error(a.message||"加载部门失败")}},L=a=>{x.value=a.map(e=>e.id)},R=async()=>{u.value=!1,t.id="",t.name="",t.email="",t.password="",t.department_id="",t.status="enabled",f.value=!0,await $()},N=a=>{u.value=!0,t.id=a.id,t.name=a.name,t.email=a.email,t.password="",t.department_id=a.department_id||"",t.status=a.status,f.value=!0},P=async()=>{if(!(!b.value||(u.value?F.password=[]:F.password=[{required:!0,message:"请输入密码",trigger:"blur"}],!await b.value.validate().catch(()=>!1)))){c.value=!0;try{if(u.value){const e=await V.updateUser(t.id,{name:t.name,department_id:t.department_id,status:t.status});e.success?(d.success("更新成功"),f.value=!1,await U()):d.error(e.error||"更新失败")}else{const e=await V.createUser({name:t.name,email:t.email,password:t.password,department_id:t.department_id,status:t.status});e.success?(d.success("添加成功"),f.value=!1,await U()):d.error(e.error||"添加失败")}}catch(e){d.error(e.message||"操作失败")}finally{c.value=!1}}},H=()=>{b.value&&b.value.resetFields()},M=async a=>{a.statusLoading=!0;try{const e=await V.updateUser(a.id,{status:a.status});e.success?d.success(a.status==="enabled"?"用户已启用":"用户已停用"):(a.status=a.status==="enabled"?"disabled":"enabled",d.error(e.error||"操作失败"))}catch(e){a.status=a.status==="enabled"?"disabled":"enabled",d.error(e.message||"操作失败")}finally{a.statusLoading=!1}},G=async a=>{const e=await V.deleteUser(a.id);e.success?(d.success("删除成功"),await U()):d.error(e.error||"删除失败")};return we(async()=>{await $(),await U()}),(a,e)=>{const j=ae,E=se,z=re,O=oe,y=le,J=ne,K=ie,Q=me,W=de,S=ue,h=ce,X=_e,Y=fe,q=ve,Z=ge,ee=pe,te=be;return g(),A("div",Fe,[r(j,{title:"用户管理",description:"管理后台管理员账号，分配部门与权限"}),r(z,null,{actions:o(()=>[r(E,{icon:B(Ee),onClick:U},{default:o(()=>[...e[7]||(e[7]=[p("刷新",-1)])]),_:1},8,["icon"]),r(E,{type:"primary",icon:B(Ue),onClick:R},{default:o(()=>[...e[8]||(e[8]=[p("新增用户",-1)])]),_:1},8,["icon"])]),_:1}),i.value?(g(),A("div",Se,[r(O,{animated:"",rows:10})])):(g(),D(W,{key:1,loading:m.value,data:v.value,onSelectionChange:L},{default:o(()=>[r(y,{type:"selection",width:"55"}),r(y,{prop:"name",label:"用户名称","min-width":"150"}),r(y,{prop:"email",label:"绑定邮箱","min-width":"200","show-overflow-tooltip":""}),r(y,{label:"所属部门",width:"180",align:"center"},{default:o(({row:s})=>[s.department?(g(),D(J,{key:0,type:s.department?.name==="超级管理员"?"danger":""},{default:o(()=>[p(I(s.department?.name||"无部门"),1)]),_:2},1032,["type"])):(g(),A("span",Be,"无部门"))]),_:1}),r(y,{label:"状态",width:"120",align:"center"},{default:o(({row:s})=>[r(K,{modelValue:s.status,"onUpdate:modelValue":k=>s.status=k,"active-value":"enabled","inactive-value":"disabled",loading:s.statusLoading,onChange:k=>M(s)},null,8,["modelValue","onUpdate:modelValue","loading","onChange"])]),_:1}),r(y,{label:"创建时间",width:"180",align:"center"},{default:o(({row:s})=>[p(I(B(n)(s.created_at)),1)]),_:1}),r(y,{label:"操作",width:"150",fixed:"right",align:"center"},{default:o(({row:s})=>[r(E,{link:"",type:"primary",onClick:k=>N(s)},{default:o(()=>[...e[9]||(e[9]=[p("编辑",-1)])]),_:1},8,["onClick"]),r(Q,{title:`确认删除用户 '${s.name}' 吗？`,onConfirm:k=>G(s)},{reference:o(()=>[r(E,{link:"",type:"danger"},{default:o(()=>[...e[10]||(e[10]=[p("删除",-1)])]),_:1})]),_:1},8,["title","onConfirm"])]),_:1})]),_:1},8,["loading","data"])),r(te,{modelValue:f.value,"onUpdate:modelValue":e[6]||(e[6]=s=>f.value=s),title:u.value?"编辑用户":"新增用户",width:"500px",onClosed:H},{footer:o(()=>[Ce("span",$e,[r(E,{onClick:e[5]||(e[5]=s=>f.value=!1)},{default:o(()=>[...e[13]||(e[13]=[p("取消",-1)])]),_:1}),r(E,{type:"primary",onClick:P,loading:c.value},{default:o(()=>[...e[14]||(e[14]=[p("确认",-1)])]),_:1},8,["loading"])])]),default:o(()=>[r(ee,{model:t,rules:F,ref_key:"userFormRef",ref:b,"label-width":"80px"},{default:o(()=>[r(h,{label:"用户名称",prop:"name"},{default:o(()=>[r(S,{modelValue:t.name,"onUpdate:modelValue":e[0]||(e[0]=s=>t.name=s),placeholder:"请输入用户名称"},null,8,["modelValue"])]),_:1}),r(h,{label:"绑定邮箱",prop:"email"},{default:o(()=>[r(S,{modelValue:t.email,"onUpdate:modelValue":e[1]||(e[1]=s=>t.email=s),placeholder:"请输入邮箱地址",disabled:u.value},null,8,["modelValue","disabled"])]),_:1}),u.value?he("",!0):(g(),D(h,{key:0,label:"密码",prop:"password"},{default:o(()=>[r(S,{modelValue:t.password,"onUpdate:modelValue":e[2]||(e[2]=s=>t.password=s),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])]),_:1})),r(h,{label:"所属部门",prop:"department_id"},{default:o(()=>[r(Y,{modelValue:t.department_id,"onUpdate:modelValue":e[3]||(e[3]=s=>t.department_id=s),placeholder:"请选择部门",style:{width:"100%"}},{default:o(()=>[(g(!0),A(Ve,null,ke(w.value,s=>(g(),D(X,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(h,{label:"状态",prop:"status"},{default:o(()=>[r(Z,{modelValue:t.status,"onUpdate:modelValue":e[4]||(e[4]=s=>t.status=s)},{default:o(()=>[r(q,{value:"enabled"},{default:o(()=>[...e[11]||(e[11]=[p("启用",-1)])]),_:1}),r(q,{value:"disabled"},{default:o(()=>[...e[12]||(e[12]=[p("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])])}}}),Xt=Ae(qe,[["__scopeId","data-v-3b71ea4f"]]);export{Xt as default};
