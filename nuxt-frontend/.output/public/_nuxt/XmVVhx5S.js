const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./o2XBa361.js","./entry.DI7xQWfr.css"])))=>i.map(i=>d[i]);
import{dM as n,ax as _}from"./o2XBa361.js";const d={async getCategories(){const r=n(),{data:s,error:e}=await r.from("image_categories").select("*").order("sort_order",{ascending:!0});return e?{success:!1,categories:[],error:e.message}:{success:!0,categories:s||[]}},async createCategory(r){const s=n(),{data:e}=await s.from("image_categories").select("sort_order").order("sort_order",{ascending:!1}).limit(1).single(),t=(e?.sort_order||0)+1,{data:a,error:c}=await s.from("image_categories").insert({name:r,sort_order:t}).select().single();return c?{success:!1,error:c.message}:{success:!0,category:a}},async deleteCategory(r){const s=n(),{count:e}=await s.from("images").select("*",{count:"exact",head:!0}).eq("category_id",r);if(e&&e>0)return{success:!1,error:"该分类下有图片，无法删除"};const{error:t}=await s.from("image_categories").delete().eq("id",r);return t?{success:!1,error:t.message}:{success:!0}}},y={async getImages(r){let e=n().from("images").select(`
            *,
            category:image_categories(*)
        `);r?.category_id&&(e=e.eq("category_id",r.category_id)),r?.keyword&&(e=e.ilike("name",`%${r.keyword}%`));const{data:t,error:a}=await e.order("created_at",{ascending:!1});return a?{success:!1,images:[],error:a.message}:{success:!0,images:t||[]}},async createImage(r){const s=n(),{data:e,error:t}=await s.from("images").insert(r).select().single();return t?{success:!1,error:t.message}:{success:!0,image:e}},async updateImage(r,s){const e=n(),{error:t}=await e.from("images").update(s).eq("id",r);return t?{success:!1,error:t.message}:{success:!0}},async deleteImage(r){return this.deleteImages([r])},async deleteImages(r){if(!r.length)return{success:!0};const s=n(),{data:e,error:t}=await s.from("images").select("url").in("id",r);if(t)return{success:!1,error:t.message};const a=e.map(i=>{try{const o=new URL(i.url);return o.pathname.startsWith("/")?o.pathname.slice(1):o.pathname}catch{return i.url.split("/").slice(-2).join("/")}}).filter(Boolean);if(a.length>0)try{const{getAdminAuthToken:i}=await _(async()=>{const{getAdminAuthToken:l}=await import("./o2XBa361.js").then(u=>u.fe);return{getAdminAuthToken:l}},__vite__mapDeps([0,1]),import.meta.url),o=await i();if(o){const{EDGE_FUNCTIONS_URL:l}=await _(async()=>{const{EDGE_FUNCTIONS_URL:g}=await import("./o2XBa361.js").then(m=>m.ff);return{EDGE_FUNCTIONS_URL:g}},__vite__mapDeps([0,1]),import.meta.url),u=await fetch(`${l}/delete-r2`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({paths:a})});if(!u.ok){const g=await u.json();console.error("Failed to delete files from R2:",g.error)}}}catch(i){console.error("R2 delete request failed:",i)}const{error:c}=await s.from("images").delete().in("id",r);return c?{success:!1,error:c.message}:{success:!0}}},E={async getBanners(){const r=n(),{data:s,error:e}=await r.from("banners").select(`
                *,
                image:images(*)
            `).order("sort_order",{ascending:!0});return e?{success:!1,banners:[],error:e.message}:{success:!0,banners:s||[]}},async createBanner(r){const s=n(),{data:e,error:t}=await s.from("banners").insert({...r,status:"on"}).select().single();return t?{success:!1,error:t.message}:{success:!0,banner:e}},async updateBanner(r,s){const e=n(),{error:t}=await e.from("banners").update(s).eq("id",r);return t?{success:!1,error:t.message}:{success:!0}},async deleteBanner(r){const s=n(),{error:e}=await s.from("banners").delete().eq("id",r);return e?{success:!1,error:e.message}:{success:!0}}},C={async getR2Settings(){const r=n();try{const{data:s,error:e}=await r.from("system_settings").select("key, value").in("key",["R2_ACCOUNT_ID","R2_ACCESS_KEY_ID","R2_SECRET_ACCESS_KEY","R2_BUCKET_NAME","R2_PUBLIC_BASE_URL"]);if(e)return{success:!0,settings:{R2_ACCOUNT_ID:"",R2_ACCESS_KEY_ID:"",R2_SECRET_ACCESS_KEY:"",R2_BUCKET_NAME:"fantula2601",R2_PUBLIC_BASE_URL:"https://img.fantula.com"}};const t={R2_ACCOUNT_ID:"",R2_ACCESS_KEY_ID:"",R2_SECRET_ACCESS_KEY:"",R2_BUCKET_NAME:"fantula2601",R2_PUBLIC_BASE_URL:"https://img.fantula.com"};return s?.forEach(a=>{t[a.key]=a.value,a.key==="R2_SECRET_ACCESS_KEY"&&a.value&&(t[a.key]=a.value.slice(0,4)+"****"+a.value.slice(-4))}),{success:!0,settings:t}}catch(s){return{success:!1,error:s.message}}},async updateR2Settings(r){const s=n();try{const e=Object.entries(r).filter(([a,c])=>c!==void 0&&c!=="").map(([a,c])=>({key:a,value:c,updated_at:new Date().toISOString()}));if(e.length===0)return{success:!0};const{error:t}=await s.from("system_settings").upsert(e,{onConflict:"key"});return t?{success:!1,error:t.message}:{success:!0}}catch(e){return{success:!1,error:e.message}}}};export{d as a,y as b,C as c,E as d};
