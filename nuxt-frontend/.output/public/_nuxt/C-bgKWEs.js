import{f as L,r as C,am as T,h as $,c as m,b as o,G as b,D as S,i as G,a as w,w as n,dM as X,B as k,o as p,j as U,E as q,l as z,ew as F,a3 as J,d as _,aX as O,t as u,_ as Q}from"./CEI0siaN.js";import{E as R}from"./BCllKHMW.js";import{E as W}from"./CoJKtQsI.js";import{E as Z}from"./B77-r_qQ.js";import{E as ee}from"./BTKFVfca.js";import{E as te}from"./Ct1yoKpA.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{d as ae}from"./C-2dxbDp.js";import{c as V}from"./ByqilF2g.js";import{P as oe}from"./BSp69RIM.js";import{A as ne}from"./Jf5bIUYa.js";import{B as ie}from"./CAt24aya.js";import{A as se}from"./Zi8pc7L8.js";import{v as re}from"./BrE0JoK1.js";import{E as A}from"./BOUQDXLJ.js";import"./97-vZjNt.js";import"./DqBrY_lx.js";import"./BB_Ol6Sd.js";import"./C6m5ANi3.js";import"./Cp1EI20B.js";import"./Dnj8X3EN.js";import"./Bh6H2ams.js";import"./Cq9Fpw4b.js";import"./CNYNJsmX.js";import"./BjbJQEzT.js";import"./wVnq5BSo.js";import"./BC9Y1jC9.js";import"./CCDBlmbt.js";import"./DE5qJ7kT.js";import"./BzZM8Et6.js";import"./DW0_wk9g.js";import"./CChPPi86.js";import"./B_7HZhJl.js";import"./D-7LAYt0.js";import"./CB_o0Cdi.js";import"./DIhsiPve.js";import"./aSYcAdI9.js";import"./uZ_KtR8H.js";import"./CXRxotb2.js";import"./OwHC_0Ap.js";import"./92s3wAHG.js";import"./BPYXJYQz.js";import"./BV_QTDOQ.js";import"./DgMG35os.js";import"./DB7JGTAC.js";/* empty css        */import"./PbH8IyH8.js";/* empty css        */import"./CgQ-l74f.js";/* empty css        *//* empty css        */import"./hs4dPNZ2.js";import"./tbxUD7ww.js";import"./DxNR5PDn.js";const le={class:"coupon-stats-page"},pe={class:"filter-group"},de={class:"code-text"},ue={key:0,class:"user-cell"},ce={key:0,class:"user-nickname"},me={key:1,class:"text-gray"},_e={key:0,class:"order-no"},ge={key:1,class:"order-uuid"},fe={key:2,class:"text-gray"},he={class:"pagination-wrapper"},ye=L({__name:"index",setup(ve){const x=C(!1),E=C([]),c=C([]),s=T({page:1,pageSize:20,total:0}),g=T({code:"",userUid:""}),I=a=>{switch(a){case"used":return"success";case"expired":return"info";default:return"warning"}},M=a=>({used:"已使用",expired:"已过期"})[a]||a,B=a=>a?ae(a).format("YYYY-MM-DD HH:mm:ss"):"-",f=async()=>{x.value=!0;try{const a=await V.coupon.getCouponStats({page:s.page,pageSize:s.pageSize,code:g.code,userUid:g.userUid});if(a.success){let t=a.data;const v=t.map(i=>i.user_uid).filter(i=>i&&i.length>20);if(v.length>0){const i=X(),{data:h}=await i.from("users").select("id, uid, nickname").in("id",v);if(h){const r=h.reduce((l,d)=>(l[d.id]=d,l),{});t=t.map(l=>{const d=r[l.user_uid];return{...l,display_uid:d?d.uid:l.user_uid,user_nickname:d?d.nickname:l.user_nickname}})}}else t=t.map(i=>({...i,display_uid:i.user_uid}));E.value=t,s.total=a.total}else k.error(a.error||"加载失败")}catch(a){k.error("网络错误: "+a.message)}finally{x.value=!1}},y=()=>{s.page=1,f()},N=a=>{s.pageSize=a,f()},P=a=>{s.page=a,f()},Y=a=>{c.value=a.map(t=>t.id)},j=a=>{A.confirm("确定删除该条记录吗？删除后用户侧将不再显示此优惠券。","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{await D([a.id])})},H=()=>{c.value.length!==0&&A.confirm(`确定删除选中的 ${c.value.length} 条记录吗？`,"批量删除",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then(async()=>{await D(c.value)})},D=async a=>{try{const t=await V.coupon.deleteCouponUsages(a);t.success?(k.success(`成功删除 ${t.count||a.length} 条记录`),f(),c.value=[]):k.error(t.error||"删除失败")}catch(t){k.error("删除异常: "+t.message)}};return $(()=>{f()}),(a,t)=>{const v=q,i=R,h=W,r=Z,l=ee,d=te,K=re;return p(),m("div",le,[o(oe,{title:"优惠券统计",description:"查看优惠券领取和使用记录，支持按兑换码或用户查询。"}),o(ne,null,{actions:n(()=>[o(h,{icon:z(O),onClick:f},{default:n(()=>[...t[5]||(t[5]=[_("刷新",-1)])]),_:1},8,["icon"])]),default:n(()=>[w("div",pe,[o(i,{modelValue:g.code,"onUpdate:modelValue":t[0]||(t[0]=e=>g.code=e),placeholder:"搜索兑换码",style:{width:"200px"},clearable:"",onKeyup:U(y,["enter"]),onClear:y},{prefix:n(()=>[o(v,null,{default:n(()=>[o(z(F))]),_:1})]),_:1},8,["modelValue"]),o(i,{modelValue:g.userUid,"onUpdate:modelValue":t[1]||(t[1]=e=>g.userUid=e),placeholder:"搜索用户UID (8位)",style:{width:"200px"},clearable:"",onKeyup:U(y,["enter"]),onClear:y},{prefix:n(()=>[o(v,null,{default:n(()=>[o(z(J))]),_:1})]),_:1},8,["modelValue"]),o(h,{type:"primary",onClick:y},{default:n(()=>[...t[4]||(t[4]=[_("查询",-1)])]),_:1})])]),_:1}),c.value.length>0?(p(),b(ie,{key:0,count:c.value.length,onDelete:H},null,8,["count"])):S("",!0),G((p(),b(se,{data:E.value,onSelectionChange:Y},{default:n(()=>[o(r,{type:"selection",width:"55",align:"center"}),o(r,{prop:"code",label:"兑换码","min-width":"180"},{default:n(({row:e})=>[w("span",de,u(e.code),1)]),_:1}),o(r,{prop:"coupon_name",label:"优惠券名称","min-width":"150"}),o(r,{label:"所属用户","min-width":"180"},{default:n(({row:e})=>[e.display_uid||e.user_uid?(p(),m("div",ue,[o(l,{size:"small",type:"info"},{default:n(()=>[_(u(e.display_uid||e.user_uid),1)]),_:2},1024),e.user_nickname?(p(),m("div",ce,u(e.user_nickname),1)):S("",!0)])):(p(),m("span",me,"-"))]),_:1}),o(r,{label:"关联订单","min-width":"180"},{default:n(({row:e})=>[e.order_no?(p(),m("span",_e,u(e.order_no),1)):e.order_id?(p(),m("span",ge,u(e.order_id),1)):(p(),m("span",fe,"-"))]),_:1}),o(r,{prop:"status",label:"状态",width:"100",align:"center"},{default:n(({row:e})=>[o(l,{type:I(e.status),size:"small"},{default:n(()=>[_(u(M(e.status)),1)]),_:2},1032,["type"])]),_:1}),o(r,{label:"领取时间",width:"170",align:"center"},{default:n(({row:e})=>[_(u(B(e.created_at)),1)]),_:1}),o(r,{label:"使用时间",width:"170",align:"center"},{default:n(({row:e})=>[_(u(B(e.used_at)),1)]),_:1}),o(r,{label:"操作",width:"100",align:"center",fixed:"right"},{default:n(({row:e})=>[["used","expired"].includes(e.status)?(p(),b(h,{key:0,link:"",type:"danger",size:"small",onClick:ke=>j(e)},{default:n(()=>[...t[6]||(t[6]=[_(" 删除 ",-1)])]),_:1},8,["onClick"])):S("",!0)]),_:1})]),_:1},8,["data"])),[[K,x.value]]),w("div",he,[o(d,{"current-page":s.page,"onUpdate:currentPage":t[2]||(t[2]=e=>s.page=e),"page-size":s.pageSize,"onUpdate:pageSize":t[3]||(t[3]=e=>s.pageSize=e),total:s.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:N,onCurrentChange:P},null,8,["current-page","page-size","total"])])])}}}),Ut=Q(ye,[["__scopeId","data-v-77a9fdc1"]]);export{Ut as default};
