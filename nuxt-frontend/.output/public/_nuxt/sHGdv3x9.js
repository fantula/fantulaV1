const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CEI0siaN.js","./entry.CxLesyFg.css","./Bf7J-tp3.js"])))=>i.map(i=>d[i]);
import{f as ve,r as c,h as _e,g as ye,am as ee,c as f,a as r,b as o,i as we,w as l,G as F,B as s,o as n,D as Ce,F as b,k as x,j as Ee,E as ke,l as H,ew as Ve,d as u,t as O,aX as he,af as be,n as xe,aD as Ie,ax as Q,_ as Ue}from"./CEI0siaN.js";import{a as De,E as ze}from"./DIhsiPve.js";import{E as Te}from"./BCllKHMW.js";import{E as Se}from"./CoJKtQsI.js";import{E as $e}from"./BTKFVfca.js";import{E as Fe}from"./CZLDLz6s.js";import{E as Oe}from"./CgQ-l74f.js";import{a as Re}from"./D-7LAYt0.js";import{E as Be}from"./DAIghOY5.js";import{E as Ne}from"./Ct1yoKpA.js";import{E as je}from"./PbH8IyH8.js";import{E as Ae}from"./CP47LeNR.js";import{E as Le,a as Me}from"./ClIUVBla.js";import{E as Pe}from"./bAK5vGBC.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{c as _}from"./ByqilF2g.js";import{v as Ge}from"./BrE0JoK1.js";import{E as W}from"./BOUQDXLJ.js";import"./BjbJQEzT.js";import"./97-vZjNt.js";import"./DqBrY_lx.js";import"./wVnq5BSo.js";import"./Bh6H2ams.js";import"./BC9Y1jC9.js";import"./Dnj8X3EN.js";import"./CNYNJsmX.js";import"./Cq9Fpw4b.js";import"./aSYcAdI9.js";import"./B_7HZhJl.js";import"./DW0_wk9g.js";import"./uZ_KtR8H.js";import"./CB_o0Cdi.js";import"./Cp1EI20B.js";import"./BB_Ol6Sd.js";import"./BzZM8Et6.js";import"./CXRxotb2.js";import"./OwHC_0Ap.js";import"./C6m5ANi3.js";import"./DE5qJ7kT.js";import"./CCDBlmbt.js";import"./DxNR5PDn.js";import"./CChPPi86.js";import"./hs4dPNZ2.js";import"./D6FW0B1r.js";import"./BPYXJYQz.js";import"./BV_QTDOQ.js";import"./DgMG35os.js";import"./tbxUD7ww.js";const Ke={class:"image-page"},qe={class:"filter-container"},Je={class:"filter-left"},Xe={class:"filter-right"},He={key:0,class:"category-display"},Qe={class:"cat-tags"},We={key:0,class:"empty-state"},Ye={key:1,class:"image-grid"},Ze=["onClick"],et={class:"image-wrapper"},tt={class:"image-info"},at={class:"image-header"},ot=["title"],lt={class:"image-actions"},st={class:"pagination-wrapper",style:{"margin-top":"20px",display:"flex","justify-content":"flex-end"}},rt={class:"cat-manager"},it={class:"add-cat-row"},nt={class:"cat-list"},dt={class:"dialog-footer"},ut={class:"dialog-footer"},mt=ve({__name:"index",setup(pt){const I=c(!1),A=c(""),L=c(""),M=c(!1),U=c(!1),D=c(!1),w=c([]),R=async()=>{const a=await _.imageCategory.getCategories();a.success&&(w.value=a.categories)},P=c([]),p=c([]),te=a=>{const e=p.value.indexOf(a);e>-1?p.value.splice(e,1):p.value.push(a)},ae=()=>{p.value.length!==0&&W.confirm(`确认删除选中的 ${p.value.length} 张图片吗？此操作不可恢复。`,"批量删除",{type:"warning"}).then(async()=>{I.value=!0;try{const a=await _.image.deleteImages(p.value);a.success?(s.success("批量删除成功"),p.value=[],await C()):s.error("删除失败: "+a.error)}finally{I.value=!1}})},C=async()=>{I.value=!0;try{const a=await _.image.getImages({category_id:A.value,keyword:L.value});a.success?P.value=a.images:s.error("加载图片失败: "+a.error)}finally{I.value=!1}},G=c(!1),oe=async()=>{G.value=!0;try{const{getAdminAuthToken:a}=await Q(async()=>{const{getAdminAuthToken:i}=await import("./CEI0siaN.js").then(V=>V.fe);return{getAdminAuthToken:i}},__vite__mapDeps([0,1]),import.meta.url),e=await a();if(!e){s.error("请先登录后台管理员账号");return}const{EDGE_FUNCTIONS_URL:v}=await Q(async()=>{const{EDGE_FUNCTIONS_URL:i}=await import("./CEI0siaN.js").then(V=>V.ff);return{EDGE_FUNCTIONS_URL:i}},__vite__mapDeps([0,1]),import.meta.url),y=await fetch(`${v}/list-r2`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({prefix:"uploads"})}),E=await y.json();if(!y.ok||E.error){s.error("获取 R2 列表失败: "+(E.error||"未知错误"));return}const k=E.objects||[];if(k.length===0){s.info("R2 存储桶中没有图片");return}const d=new Set(P.value.map(i=>i.url)),S=k.filter(i=>!d.has(i.url));if(S.length===0){s.success("已同步，无新图片");return}let h="";const N=w.value.find(i=>i.name==="未分类");if(N)h=N.id;else{const i=await _.imageCategory.createCategory("未分类");i.success&&i.category&&(h=i.category.id,await R())}let j=0;for(const i of S){const V=i.key.split("/").pop()||i.key;(await _.image.createImage({name:V,url:i.url,category_id:h||void 0})).success&&j++}s.success(`同步成功！新增 ${j} 张图片`),await C()}catch(a){console.error("Sync error:",a),s.error("同步失败: "+(a.message||"未知错误"))}finally{G.value=!1}};_e(()=>{R(),C()});const K=ye(()=>P.value),z=c(""),le=()=>{M.value=!0},se=async()=>{if(!z.value.trim()){s.warning("请输入分类名称");return}const a=await _.imageCategory.createCategory(z.value);a.success?(s.success("分类添加成功"),z.value="",R()):s.error("添加失败: "+a.error)},re=a=>{W.confirm(`确认删除分类 "${a.name}" 吗？`,"删除分类",{type:"warning"}).then(async()=>{const e=await _.imageCategory.deleteCategory(a.id);e.success?(s.success("分类删除成功"),R()):s.error("删除失败: "+e.error)})},m=ee({categoryId:"",name:""}),T=c([]),B=c(!1),ie=()=>{U.value=!0},ne=(a,e)=>{T.value=e,!m.name&&a.name&&(m.name=a.name)},de=async()=>{if(!m.categoryId){s.warning("请选择分类");return}if(T.value.length===0){s.warning("请选择图片文件");return}if(m.name&&m.name.length>50){s.warning("图片名称过长，请精简");return}B.value=!0;try{const a=T.value[0].raw,{uploadImageToStorage:e}=await Q(async()=>{const{uploadImageToStorage:E}=await import("./Bf7J-tp3.js");return{uploadImageToStorage:E}},__vite__mapDeps([2,0,1]),import.meta.url),v=await e(a);if(!v.success){s.error("文件上传失败: "+v.error),B.value=!1;return}const y=await _.image.createImage({name:m.name||a.name,url:v.url,category_id:m.categoryId});y.success?(s.success("上传成功"),U.value=!1,p.value=[],await C()):s.error("保存图片记录失败: "+y.error)}catch(a){console.error("Upload error:",a),s.error("上传失败: "+(a.message||"未知错误"))}finally{B.value=!1}},ue=()=>{m.categoryId="",m.name="",T.value=[]},g=ee({id:"",name:"",category_id:""}),me=a=>{g.id=a.id,g.name=a.name,g.category_id=a.category_id||"",D.value=!0},pe=async()=>{const a=await _.image.updateImage(g.id,{name:g.name,category_id:g.category_id});a.success?(s.success("修改成功"),D.value=!1,await C()):s.error("修改失败: "+a.error)},ce=a=>{W.confirm("确认删除该图片吗？此操作无法恢复。","删除图片",{type:"warning"}).then(async()=>{const e=await _.image.deleteImage(a.id);e.success?(s.success("已删除"),await C()):s.error("删除失败: "+e.error)})},q=()=>{C()};return(a,e)=>{const v=ze,y=De,E=ke,k=Te,d=Se,S=$e,h=Fe,N=Oe,j=Re,i=Be,V=Ne,Y=je,J=Ae,$=Me,fe=Pe,Z=Le,ge=Ge;return n(),f("div",Ke,[e[27]||(e[27]=r("div",{class:"page-header"},[r("h2",null,"图片管理")],-1)),o(h,{shadow:"never",class:"filter-card"},{default:l(()=>[r("div",qe,[r("div",Je,[o(y,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=t=>A.value=t),placeholder:"选择分类",clearable:"",style:{width:"150px","margin-right":"15px"},onChange:q},{default:l(()=>[o(v,{label:"全部图片",value:""}),(n(!0),f(b,null,x(w.value,t=>(n(),F(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(k,{modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=t=>L.value=t),placeholder:"搜索图片名称",clearable:"",style:{width:"200px","margin-right":"15px"},onKeyup:Ee(q,["enter"])},{prefix:l(()=>[o(E,null,{default:l(()=>[o(H(Ve))]),_:1})]),_:1},8,["modelValue"]),o(d,{type:"primary",onClick:q},{default:l(()=>[...e[12]||(e[12]=[u("查询",-1)])]),_:1})]),r("div",Xe,[o(d,{onClick:le},{default:l(()=>[...e[13]||(e[13]=[u("管理分类",-1)])]),_:1}),o(d,{type:"danger",disabled:p.value.length===0,onClick:ae},{default:l(()=>[u(" 批量删除 "+O(p.value.length?`(${p.value.length})`:""),1)]),_:1},8,["disabled"]),o(d,{type:"success",icon:H(he),onClick:oe,loading:G.value},{default:l(()=>[...e[14]||(e[14]=[u("从 R2 同步",-1)])]),_:1},8,["icon","loading"]),o(d,{type:"primary",icon:H(be),onClick:ie},{default:l(()=>[...e[15]||(e[15]=[u("上传图片",-1)])]),_:1},8,["icon"])])]),w.value.length>0?(n(),f("div",He,[e[16]||(e[16]=r("span",{class:"cat-label"},"已有分类：",-1)),r("div",Qe,[(n(!0),f(b,null,x(w.value,t=>(n(),F(S,{key:t.id,type:"info",class:"mr-2",style:{"margin-right":"8px"}},{default:l(()=>[u(O(t.name),1)]),_:2},1024))),128))])])):Ce("",!0)]),_:1}),we((n(),F(h,{shadow:"never",class:"list-card"},{default:l(()=>[K.value.length===0?(n(),f("div",We,[o(N,{description:"暂无图片"})])):(n(),f("div",Ye,[(n(!0),f(b,null,x(K.value,t=>(n(),f("div",{key:t.id,class:xe(["image-card",{"is-selected":p.value.includes(t.id)}])},[r("div",{class:"card-selection",onClick:Ie(X=>te(t.id),["stop"])},[o(j,{"model-value":p.value.includes(t.id),size:"large",style:{"pointer-events":"none"}},null,8,["model-value"])],8,Ze),r("div",et,[o(i,{src:t.url,fit:"cover",class:"image-thumb","preview-src-list":[t.url],"initial-index":0,"z-index":3e3,"preview-teleported":""},null,8,["src","preview-src-list"])]),r("div",tt,[r("div",at,[o(S,{size:"small",type:"info",effect:"plain",class:"cat-tag"},{default:l(()=>[u(O(t.category?.name||"未分类"),1)]),_:2},1024)]),r("div",{class:"image-name",title:t.name},O(t.name),9,ot),r("div",lt,[o(d,{link:"",type:"primary",size:"small",onClick:X=>me(t)},{default:l(()=>[...e[17]||(e[17]=[u("编辑",-1)])]),_:1},8,["onClick"]),o(d,{link:"",type:"danger",size:"small",onClick:X=>ce(t)},{default:l(()=>[...e[18]||(e[18]=[u("删除",-1)])]),_:1},8,["onClick"])])])],2))),128))])),r("div",st,[o(V,{background:"",layout:"prev, pager, next",total:K.value.length,"page-size":20},null,8,["total"])])]),_:1})),[[ge,I.value]]),o(J,{modelValue:M.value,"onUpdate:modelValue":e[3]||(e[3]=t=>M.value=t),title:"分类管理",width:"500px","append-to-body":"","z-index":2e3},{default:l(()=>[r("div",rt,[r("div",it,[o(k,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=t=>z.value=t),placeholder:"新分类名称",style:{"margin-right":"10px"}},null,8,["modelValue"]),o(d,{type:"primary",onClick:se},{default:l(()=>[...e[19]||(e[19]=[u("添加分类",-1)])]),_:1})]),o(Y),r("div",nt,[(n(!0),f(b,null,x(w.value,t=>(n(),f("div",{key:t.id,class:"cat-item"},[r("span",null,O(t.name),1),o(d,{link:"",type:"danger",size:"small",onClick:X=>re(t)},{default:l(()=>[...e[20]||(e[20]=[u("删除",-1)])]),_:1},8,["onClick"])]))),128))])])]),_:1},8,["modelValue"]),o(J,{modelValue:U.value,"onUpdate:modelValue":e[7]||(e[7]=t=>U.value=t),title:"上传图片",width:"500px",onClosed:ue,"append-to-body":"","z-index":2e3},{footer:l(()=>[r("span",dt,[o(d,{onClick:e[6]||(e[6]=t=>U.value=!1)},{default:l(()=>[...e[23]||(e[23]=[u("取消",-1)])]),_:1}),o(d,{type:"primary",onClick:de,loading:B.value},{default:l(()=>[...e[24]||(e[24]=[u("开始上传",-1)])]),_:1},8,["loading"])])]),default:l(()=>[o(Z,{model:m,"label-width":"80px"},{default:l(()=>[o($,{label:"所属分类",required:""},{default:l(()=>[o(y,{modelValue:m.categoryId,"onUpdate:modelValue":e[4]||(e[4]=t=>m.categoryId=t),placeholder:"请选择分类",style:{width:"100%"}},{default:l(()=>[(n(!0),f(b,null,x(w.value,t=>(n(),F(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o($,{label:"图片名称"},{default:l(()=>[o(k,{modelValue:m.name,"onUpdate:modelValue":e[5]||(e[5]=t=>m.name=t),placeholder:"默认使用文件名"},null,8,["modelValue"])]),_:1}),o($,{label:"选择图片",required:""},{default:l(()=>[o(fe,{class:"upload-demo",action:"#","auto-upload":!1,limit:1,"on-change":ne,"file-list":T.value,"list-type":"picture"},{tip:l(()=>[...e[22]||(e[22]=[r("div",{class:"el-upload__tip"},"只能上传 jpg/png 文件，且不超过 2MB",-1)])]),default:l(()=>[o(d,{type:"primary"},{default:l(()=>[...e[21]||(e[21]=[u("点击选择文件",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(J,{modelValue:D.value,"onUpdate:modelValue":e[11]||(e[11]=t=>D.value=t),title:"编辑图片信息",width:"400px","append-to-body":"","z-index":2e3},{footer:l(()=>[r("span",ut,[o(d,{onClick:e[10]||(e[10]=t=>D.value=!1)},{default:l(()=>[...e[25]||(e[25]=[u("取消",-1)])]),_:1}),o(d,{type:"primary",onClick:pe},{default:l(()=>[...e[26]||(e[26]=[u("保存",-1)])]),_:1})])]),default:l(()=>[o(Z,{model:g,"label-width":"80px"},{default:l(()=>[o($,{label:"图片名称"},{default:l(()=>[o(k,{modelValue:g.name,"onUpdate:modelValue":e[8]||(e[8]=t=>g.name=t)},null,8,["modelValue"])]),_:1}),o($,{label:"所属分类"},{default:l(()=>[o(y,{modelValue:g.category_id,"onUpdate:modelValue":e[9]||(e[9]=t=>g.category_id=t),style:{width:"100%"}},{default:l(()=>[(n(!0),f(b,null,x(w.value,t=>(n(),F(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Va=Ue(mt,[["__scopeId","data-v-f44a103a"]]);export{Va as default};
