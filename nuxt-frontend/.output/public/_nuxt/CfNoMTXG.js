import{z as ts,r as m,g as h,ab as os,B as g,C as Q,eH as E,aj as Z,f as W,c as f,aG as Y,a as s,x as as,t as c,d as P,I as X,o as p,_ as ss,h as ns,G as K,D,b as d,l as t,w as b,F as rs,k as ls,n as is,E as ds,a1 as cs,a2 as us,aX as ps,Z as vs,L as fs,a4 as _s,a_ as ms,az as hs}from"./o2XBa361.js";import{E as ys}from"./DC3lfPj1.js";import{E as gs}from"./-Yx_0iEM.js";/* empty css        */import{C as ks}from"./DfOP0psH.js";import"./Culj45X8.js";import"./Dnj8X3EN.js";import"./C1T5KPmY.js";/* empty css        */import"./VzrLdZEg.js";function ws(){const N=Q(),y=ts(),i=m(!0),v=m(""),l=m([]),k=m(!1),I=m(!1),C=m(!1),O=m(""),$=m(0),u=m(null),n=m(0),S=m(0);let w=null,x=null;const F=h(()=>l.value.reduce((o,a)=>o+a.total_amount,0)),B=h(()=>l.value.reduce((o,a)=>o+a.total_amount,0)),T=h(()=>y.user?.balance??0),V=h(()=>l.value.map(o=>o.sku_snapshot?.sku_id).filter(Boolean)),z=h(()=>l.value.map(o=>o.product_snapshot?.product_id).filter(Boolean)),U=h(()=>{const o=Math.floor(S.value/60),a=S.value%60;return`${o}:${a.toString().padStart(2,"0")}`}),q=async()=>{if(!C.value){C.value=!0;try{await y.fetchUserInfo(),g.success("é¢åº¦å·²æ›´æ–°")}catch{g.error("æ›´æ–°å¤±è´¥")}finally{C.value=!1}}},L=o=>{const a=()=>{const e=Date.now();S.value=Math.max(0,Math.floor((o-e)/1e3)),S.value<=0&&(j(),w&&clearInterval(w))};a(),w=Z(a,1e3)},j=async()=>{if(v.value="è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ä¸‹å•",l.value.length>0)try{await E.expirePreOrder(l.value[0].id)}catch(o){console.error("Failed to expire order",o)}},G=()=>{x&&clearInterval(x),x=Z(async()=>{if(v.value||k.value||l.value.length===0)return;const o=l.value[0].id,a=await E.getPreOrder(o);if(a.success&&a.pre_order){const e=a.pre_order.status;if(e==="converted"||e==="confirmed"){I.value||(O.value=a.pre_order.order_no,$.value=a.pre_order.total_amount,I.value=!0,clearInterval(x),clearInterval(w));return}if(e==="expired"||e==="cancelled"){v.value="è®¢å•å·²å¤±æ•ˆæˆ–å·²å…³é—­",clearInterval(x),clearInterval(w);return}a.pre_order.total_amount!==l.value[0].total_amount&&(l.value[0].total_amount=a.pre_order.total_amount)}},3e3)},H=async o=>{i.value=!0,v.value="";try{if(!y.isLoggedIn&&(await y.fetchUserInfo(),!y.isLoggedIn)){g.warning("è¯·å…ˆç™»å½•"),N.push("/");return}if(o.length===0)throw new Error("ç¼ºå°‘è®¢å• ID");const a=[];for(const r of o){const A=await E.getPreOrder(r);A.success&&A.pre_order&&a.push(A.pre_order)}if(a.length===0)throw new Error("è®¢å•ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");l.value=a;const e=Math.min(...a.map(r=>new Date(r.expires_at).getTime()));L(e),G()}catch(a){v.value=a.message}finally{i.value=!1}},R=async o=>{u.value=o;const a=o?.id||null,e=l.value[0];if(e){i.value=!0;try{const r=await E.applyCouponToPreOrder(e.id,a);r.success?(r.total_amount!==void 0&&(e.total_amount=r.total_amount,n.value=r.discount_amount||0),o?g.success("ä¼˜æƒ åˆ¸ä½¿ç”¨æˆåŠŸ"):g.success("å·²å–æ¶ˆä¼˜æƒ åˆ¸")):(g.error(r.error||"åº”ç”¨ä¼˜æƒ åˆ¸å¤±è´¥"),o&&(u.value=null),n.value=0)}catch(r){g.error("ç³»ç»Ÿå¼‚å¸¸: "+(r.message||JSON.stringify(r))),console.error(r)}finally{i.value=!1}}},M=async()=>{if(!k.value){if(l.value.length>0&&l.value[0].status!=="pending"){g.error("è®¢å•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢");return}if(T.value<B.value){g.warning("é¢åº¦ä¸è¶³ï¼Œè¯·å…ˆå……å€¼"),N.push("/profile/recharge");return}k.value=!0;try{const o=l.value[0],a=await E.confirmPreOrder(o.id,"balance",u.value?.id);if(!a.success){g.error(a.error||"æ”¯ä»˜å¤±è´¥");return}O.value=a.order_no||"",$.value=B.value,I.value=!0,await y.fetchUserInfo()}catch(o){g.error(o.message||"ç³»ç»Ÿå¼‚å¸¸")}finally{k.value=!1}}},J=o=>o?Object.values(o).join(" / "):"é»˜è®¤è§„æ ¼";return os(()=>{w&&clearInterval(w),x&&clearInterval(x)}),{loading:i,error:v,preOrders:l,paying:k,showPaySuccess:I,refreshingBalance:C,lastOrderId:O,lastOrderAmount:$,selectedCoupon:u,couponDiscount:n,remainingSeconds:S,totalProductAmount:F,finalPayAmount:B,userBalance:T,orderSkuIds:V,orderProductIds:z,formatCountdown:U,loadPreOrders:H,handleCouponSelect:R,handlePay:M,formatSpec:J,refreshBalance:q}}const bs={class:"pay-success-modal glass-card"},Is={class:"success-info"},Cs={class:"info-row"},Ss={class:"info-value info-link"},xs={class:"info-row"},Ps={class:"info-value info-amount"},Os={class:"info-row"},$s={class:"info-value info-paytype"},Bs={class:"info-row"},As={class:"info-value info-time"},Ns=W({__name:"PaySuccessModal",props:{orderId:{type:String,default:"N/A"},payType:{type:String,default:"balance"},amount:{type:[String,Number],default:0}},emits:["close"],setup(N,{emit:y}){const i=N,v=y,l=h(()=>i.orderId||"N/A"),k=h(()=>{try{const u=typeof i.amount=="string"?parseFloat(i.amount||"0"):i.amount||0;return isNaN(u)?"0.00":u.toFixed(2)}catch{return"0.00"}}),I=h(()=>({alipay:"æ”¯ä»˜å®æ”¯ä»˜",balance:"ä½™é¢æ”¯ä»˜",other:"å…¶ä»–æ”¯ä»˜"})[i.payType]||"æœªçŸ¥æ”¯ä»˜æ–¹å¼"),C=h(()=>{try{return new Date().toLocaleString("zh-CN",{hour12:!1})}catch{return"åˆšåˆš"}}),O=()=>{v("close");try{X("/")}catch{window.location.href="/"}},$=()=>{v("close");try{i.orderId&&i.orderId!=="N/A"?X(`/profile/order/${i.orderId}`):X("/profile/orders")}catch{window.location.href="/profile/orders"}};return(u,n)=>(p(),f("div",{class:"modal-mask",onClick:n[0]||(n[0]=Y(S=>u.$emit("close"),["self"]))},[s("div",bs,[n[8]||(n[8]=as('<div class="success-header" data-v-14a59af2><div class="success-circle" data-v-14a59af2><div class="success-icon-wrapper" data-v-14a59af2><svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-14a59af2><polyline points="20 6 9 17 4 12" data-v-14a59af2></polyline></svg></div></div><div class="success-title" data-v-14a59af2>æ”¯ä»˜æˆåŠŸ</div><div class="success-desc" data-v-14a59af2>æ‚¨çš„è®¢å•å·²ç¡®è®¤ï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°</div></div>',1)),s("div",Is,[s("div",Cs,[n[1]||(n[1]=s("span",{class:"info-label"},"è®¢å•ç¼–å·",-1)),s("span",Ss,c(l.value),1)]),n[5]||(n[5]=s("div",{class:"info-divider"},null,-1)),s("div",xs,[n[2]||(n[2]=s("span",{class:"info-label"},"æ”¯ä»˜é‡‘é¢",-1)),s("span",Ps,"Â¥"+c(k.value),1)]),n[6]||(n[6]=s("div",{class:"info-divider"},null,-1)),s("div",Os,[n[3]||(n[3]=s("span",{class:"info-label"},"æ”¯ä»˜æ–¹å¼",-1)),s("span",$s,c(I.value),1)]),n[7]||(n[7]=s("div",{class:"info-divider"},null,-1)),s("div",Bs,[n[4]||(n[4]=s("span",{class:"info-label"},"æ”¯ä»˜æ—¶é—´",-1)),s("span",As,c(C.value),1)])]),n[9]||(n[9]=s("div",{class:"status-box"},[s("div",{class:"status-icon"},"ğŸš€"),s("div",{class:"status-text"},"ç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨è‡ªåŠ¨å‘è´§ï¼Œè¯·ç¨å€™æŸ¥çœ‹")],-1)),s("div",{class:"success-actions"},[s("button",{class:"order-btn",onClick:$}," å‰å¾€æŸ¥çœ‹è®¢å• "),s("button",{class:"home-btn",onClick:O}," è¿”å›é¦–é¡µ ")]),n[10]||(n[10]=s("div",{class:"success-tip"},[P(" å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœ "),s("span",{class:"kefu-phone"},"åœ¨çº¿å®¢æœ")],-1))])]))}}),Ts=ss(Ns,[["__scopeId","data-v-14a59af2"]]),Ms={class:"checkout-page"},Es={class:"checkout-content"},Fs={class:"checkout-header"},Ds={key:0,class:"checkout-loading"},Vs={key:1,class:"checkout-error"},zs={key:2,class:"checkout-main"},Us={class:"order-section"},qs={key:0,class:"countdown-bar"},Ls={class:"time-highlight"},js={class:"order-list"},Gs={class:"order-header-row"},Hs={class:"order-no"},Rs={class:"order-body"},Js={class:"product-thumb"},Xs={class:"sq-cover-img-container"},Zs=["src"],Ks={class:"product-info"},Qs={class:"product-name"},Ws={class:"product-meta-row"},Ys={class:"product-price"},se={class:"price-val"},ee={class:"qty"},te={class:"tips-container"},oe={class:"tips-card glass-card"},ae={class:"summary-section"},ne={class:"summary-card glass-card sticky-card"},re={class:"price-rows"},le={class:"price-row"},ie={class:"val"},de={class:"coupon-label"},ce={class:"coupon-action"},ue={key:0,class:"val discount"},pe={key:1,class:"placeholder"},ve={class:"price-row total"},fe={class:"val final"},_e={class:"payment-method"},me={class:"balance-card active"},he={class:"balance-icon"},ye={class:"balance-info"},ge={class:"user-balance-row"},ke={class:"user-balance"},we={class:"check-mark"},be={class:"action-area"},Ie=["disabled"],Ce={key:0,class:"btn-loader"},Se={key:1},xe={key:2},Pe=W({__name:"[id]",setup(N){const y=cs(),i=Q(),v=m(!1),{loading:l,error:k,preOrders:I,paying:C,showPaySuccess:O,lastOrderId:$,lastOrderAmount:u,selectedCoupon:n,couponDiscount:S,remainingSeconds:w,formatCountdown:x,totalProductAmount:F,finalPayAmount:B,userBalance:T,orderSkuIds:V,orderProductIds:z,loadPreOrders:U,handleCouponSelect:q,handlePay:L,formatSpec:j,refreshBalance:G,refreshingBalance:H}=ws(),R=h(()=>{const a=y.params.id,e=y.query.ids;return e?e.split(","):a?[a]:[]}),M=h(()=>T.value<B.value),J=()=>{if(M.value){i.push("/profile/recharge");return}L()};ns(()=>{U(R.value)});const o=()=>{O.value=!1,i.push("/profile/orders")};return(a,e)=>{const r=ds,A=ys,es=gs;return p(),f("div",Ms,[s("div",Es,[s("div",Fs,[s("button",{class:"back-btn",onClick:e[0]||(e[0]=_=>t(i).back())},[d(r,null,{default:b(()=>[d(t(us))]),_:1}),e[4]||(e[4]=P(" è¿”å› ",-1))]),e[5]||(e[5]=s("div",{class:"page-title"},"è®¢å•ç»“ç®—",-1))]),t(l)?(p(),f("div",Ds,[...e[6]||(e[6]=[s("div",{class:"glass-loader"},null,-1),s("p",null,"æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...",-1)])])):t(k)?(p(),f("div",Vs,[e[7]||(e[7]=s("div",{class:"error-icon"},"âš ï¸",-1)),s("p",null,c(t(k)),1),s("button",{class:"action-btn",onClick:e[1]||(e[1]=_=>t(i).push("/"))},"è¿”å›é¦–é¡µ")])):t(I).length>0?(p(),f("div",zs,[s("div",Us,[t(w)>0?(p(),f("div",qs,[d(r,null,{default:b(()=>[d(t(ps))]),_:1}),s("span",null,[e[8]||(e[8]=P("è¯·åœ¨ ",-1)),s("strong",Ls,c(t(x)),1),e[9]||(e[9]=P(" å†…å®Œæˆæ”¯ä»˜ï¼Œè¶…æ—¶å°†é‡Šæ”¾åº“å­˜",-1))])])):D("",!0),s("div",js,[(p(!0),f(rs,null,ls(t(I),_=>(p(),f("div",{key:_.id,class:"order-card glass-card"},[s("div",Gs,[s("span",Hs,"è®¢å•å·: "+c(_.order_no),1),e[10]||(e[10]=s("span",{class:"order-status"},"å¾…æ”¯ä»˜",-1))]),s("div",Rs,[s("div",Js,[s("div",Xs,[s("img",{src:_.product_snapshot?.image||"/images/shared/logo.png",class:"sq-cover-img"},null,8,Zs)])]),s("div",Ks,[s("div",Qs,c(_.product_snapshot?.product_name),1),s("div",Ws,[d(A,{size:"small",effect:"dark",class:"spec-tag"},{default:b(()=>[P(c(t(j)(_.sku_snapshot?.spec_combination)),1)]),_:2},1024),e[11]||(e[11]=s("span",{class:"delivery-info"},"å‘è´§æ–¹å¼ï¼šè‡ªåŠ¨å‘è´§",-1))])]),s("div",Ys,[s("div",se,c(_.unit_price.toFixed(2))+" ç‚¹",1),s("div",ee,"x"+c(_.quantity),1)])])]))),128))]),s("div",te,[s("div",oe,[s("h4",null,[d(r,null,{default:b(()=>[d(t(vs))]),_:1}),e[12]||(e[12]=P(" æ¸©é¦¨æç¤º",-1))]),e[13]||(e[13]=s("ul",null,[s("li",null,"èµ„æºå·²ä¸ºæ‚¨é”å®šï¼Œè¯·å°½å¿«å®Œæˆæ”¯ä»˜ã€‚"),s("li",null,"è¶…æ—¶æœªæ”¯ä»˜å°†è‡ªåŠ¨é‡Šæ”¾ï¼Œéœ€é‡æ–°ä¸‹å•ã€‚"),s("li",null,"å¦‚é‡é—®é¢˜ï¼Œè¯·è”ç³»åœ¨çº¿å®¢æœã€‚")],-1))])])]),s("div",ae,[s("div",ne,[e[21]||(e[21]=s("h3",{class:"card-title"},"æ”¯ä»˜è¯¦æƒ…",-1)),s("div",re,[s("div",le,[e[14]||(e[14]=s("span",null,"å•†å“æ€»é¢",-1)),s("span",ie,c(t(F).toFixed(2))+" ç‚¹",1)]),s("div",{class:"price-row coupon-row",onClick:e[2]||(e[2]=_=>v.value=!0)},[s("div",de,[e[15]||(e[15]=s("span",null,"ä¼˜æƒ åˆ¸",-1)),t(n)?(p(),K(A,{key:0,size:"small",type:"danger",effect:"dark",class:"discount-tag"},{default:b(()=>[P(" å·²æŠµæ‰£ "+c(t(S).toFixed(2))+" ç‚¹ ",1)]),_:1})):D("",!0)]),s("div",ce,[t(n)?(p(),f("span",ue,"-"+c(t(S).toFixed(2))+" ç‚¹",1)):(p(),f("span",pe,"é€‰æ‹©ä¼˜æƒ åˆ¸")),d(r,null,{default:b(()=>[d(t(fs))]),_:1})])]),e[17]||(e[17]=s("div",{class:"divider"},null,-1)),s("div",ve,[e[16]||(e[16]=s("span",null,"åº”ä»˜é‡‘é¢",-1)),s("span",fe,c(t(B).toFixed(2))+" ç‚¹",1)])]),s("div",_e,[e[19]||(e[19]=s("div",{class:"method-title"},"æ”¯ä»˜æ–¹å¼",-1)),s("div",me,[s("div",he,[d(r,null,{default:b(()=>[d(t(_s))]),_:1})]),s("div",ye,[e[18]||(e[18]=s("div",{class:"method-name"},"é¢åº¦æ”¯ä»˜",-1)),s("div",ge,[s("span",ke,"å¯ç”¨é¢åº¦: "+c(t(T).toFixed(2))+" ç‚¹",1),d(es,{link:"",type:"primary",size:"small",onClick:Y(t(G),["stop"]),loading:t(H),class:"refresh-btn"},{default:b(()=>[d(r,null,{default:b(()=>[d(t(ms))]),_:1})]),_:1},8,["onClick","loading"])])]),s("div",we,[d(r,null,{default:b(()=>[d(t(hs))]),_:1})])])]),s("div",be,[s("button",{class:is(["pay-btn",{insufficient:M.value}]),disabled:t(C)||t(w)<=0,onClick:J},[t(C)?(p(),f("div",Ce)):M.value?(p(),f("span",Se,"é¢åº¦ä¸è¶³ï¼Œå»å……å€¼")):(p(),f("span",xe,"ç«‹å³æ”¯ä»˜ "+c(t(B).toFixed(2))+" ç‚¹",1))],10,Ie),e[20]||(e[20]=s("div",{class:"agreement-text"},[P(" ç‚¹å‡»æ”¯ä»˜å³è¡¨ç¤ºåŒæ„ "),s("a",{href:"/docs/terms",target:"_blank"},"æœåŠ¡åè®®"),P(" å’Œ "),s("a",{href:"/docs/privacy",target:"_blank"},"éšç§åè®®")],-1))])])])])):D("",!0)]),t(O)?(p(),K(Ts,{key:0,orderId:t($),amount:t(u),payType:"balance",onClose:o},null,8,["orderId","amount"])):D("",!0),d(ks,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=_=>v.value=_),orderAmount:t(F),skuIds:t(V),productIds:t(z),currentCouponId:t(n)?.id,onSelect:t(q)},null,8,["modelValue","orderAmount","skuIds","productIds","currentCouponId","onSelect"])])}}}),Ve=ss(Pe,[["__scopeId","data-v-b245c8d1"]]);export{Ve as default};
