import{E as se}from"./CoJKtQsI.js";import{E as oe}from"./B77-r_qQ.js";import{E as le}from"./D2n2RcOH.js";import{E as re}from"./BTKFVfca.js";import{dM as z,f as ie,r as b,J as ne,c as u,b as a,w as s,l as o,cz as q,o as r,aX as ue,d as p,a as d,t as n,D as A,E as pe,H as ce,F as V,G as D,k as de,ag as me,B as v,_ as fe}from"./CEI0siaN.js";import{E as _e}from"./DB7JGTAC.js";import{E as ve,a as ge}from"./DSDiIrcR.js";import{E as ye}from"./BCllKHMW.js";import{E as be}from"./CgQ-l74f.js";import{E as ke}from"./CP47LeNR.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{P as Ee}from"./BSp69RIM.js";import{A as he}from"./Jf5bIUYa.js";import{A as we}from"./Zi8pc7L8.js";import{u as Ce}from"./D1_WYtmj.js";import"./Cp1EI20B.js";import"./Dnj8X3EN.js";import"./CNYNJsmX.js";import"./Cq9Fpw4b.js";import"./97-vZjNt.js";import"./DqBrY_lx.js";import"./BjbJQEzT.js";import"./wVnq5BSo.js";import"./Bh6H2ams.js";import"./BC9Y1jC9.js";import"./CCDBlmbt.js";import"./DE5qJ7kT.js";import"./BzZM8Et6.js";import"./DW0_wk9g.js";import"./CChPPi86.js";import"./B_7HZhJl.js";import"./D-7LAYt0.js";import"./BB_Ol6Sd.js";import"./CB_o0Cdi.js";import"./OwHC_0Ap.js";import"./C6m5ANi3.js";import"./hs4dPNZ2.js";import"./D6FW0B1r.js";import"./DxNR5PDn.js";import"./uZ_KtR8H.js";import"./PbH8IyH8.js";/* empty css        */import"./Ct1yoKpA.js";import"./DIhsiPve.js";import"./aSYcAdI9.js";import"./CXRxotb2.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import"./BrE0JoK1.js";import"./DgMG35os.js";import"./Demiahkb.js";import"./Ce6k4emn.js";import"./CRWHP3jh.js";const I={async getOrderFulfillment(k){try{const _=z(),{data:c,error:f}=await _.from("order_fulfillments").select("*").eq("order_id",k).order("submitted_at",{ascending:!1}).limit(1).maybeSingle();return f?{success:!1,error:"获取回执失败: "+f.message}:{success:!0,data:c}}catch(_){return{success:!1,error:_.message||"系统异常"}}},async approveFulfillment(k,_){try{const c=z(),{error:f}=await c.from("order_fulfillments").update({status:"approved",reviewed_at:new Date().toISOString()}).eq("id",k);if(f)return{success:!1,error:"更新回执失败: "+f.message};const{error:g}=await c.from("orders").update({status:"active"}).eq("id",_);return g?{success:!1,error:"更新订单状态失败: "+g.message}:{success:!0}}catch(c){return{success:!1,error:c.message||"系统异常"}}},async rejectFulfillment(k,_){try{const c=z(),{error:f}=await c.from("order_fulfillments").update({status:"rejected",reject_reason:_,reviewed_at:new Date().toISOString()}).eq("id",k);return f?{success:!1,error:"驳回失败: "+f.message}:{success:!0}}catch(c){return{success:!1,error:c.message||"系统异常"}}}},xe={class:"page-container"},Ae=["onClick"],Se={class:"user-cell"},je={class:"uid-text"},Ve={class:"product-cell"},De=["src"],Te={class:"spec-text"},Fe={class:"amount"},Re={key:0,class:"discount"},ze={key:1,class:"no-discount"},Ie={key:0,class:"loading-state"},Be={class:"payload-value"},Oe={key:2,class:"reject-reason-box"},Pe={class:"content"},Ue={key:3,class:"reject-input-area"},qe={key:2,class:"empty-receipt"},Le={key:0,class:"dialog-footer-actions"},Ne=ie({__name:"index",setup(k){const{loading:_,list:c,total:f,page:g,pageSize:S,DEFAULT_AVATAR:L,loadList:w,handleCopy:N,formatSpec:$,getStatusText:M,getStatusType:H,formatTime:T,formatPrice:B}=Ce("virtual"),E=b(!1),F=b(!1),h=b(!1),i=b(null),O=b(""),C=b(!1),x=b(""),G=async l=>{O.value=l.id,E.value=!0,C.value=!1,x.value="",i.value=null,F.value=!0;try{const t=await I.getOrderFulfillment(l.id);t.success?i.value=t.data||null:v.error(t.error||"获取回执失败")}catch(t){v.error(t.message||"系统异常")}finally{F.value=!1}},J=l=>({submitted:"待审核",approved:"已通过",rejected:"已驳回"})[l]||l,X=l=>({submitted:"warning",approved:"success",rejected:"danger"})[l]||"info",K=async()=>{if(i.value){h.value=!0;try{const l=await I.approveFulfillment(i.value.id,O.value);l.success?(v.success("已通过，订单已标记为发货完成，状态变更为服务中"),E.value=!1,w()):v.error(l.error||"操作失败")}catch(l){v.error(l.message||"系统异常")}finally{h.value=!1}}},Q=async()=>{if(i.value){if(!x.value){v.warning("请填写驳回原因");return}h.value=!0;try{const l=await I.rejectFulfillment(i.value.id,x.value);l.success?(v.success("已驳回，用户将收到通知需重新提交"),E.value=!1,w()):v.error(l.error||"操作失败")}catch(l){v.error(l.message||"系统异常")}finally{h.value=!1}}};return ne([g,S],()=>w(),{immediate:!0}),(l,t)=>{const y=se,m=oe,W=le,P=re,Y=pe,U=_e,R=ge,Z=ve,ee=ye,te=be,ae=ke;return r(),u("div",xe,[a(Ee,{title:"虚拟充值订单",description:"显示所有虚拟充值类型的订单，可审核用户提交的回执信息"}),a(he,null,{actions:s(()=>[a(y,{onClick:o(w),icon:o(ue)},{default:s(()=>[...t[7]||(t[7]=[p("刷新",-1)])]),_:1},8,["onClick","icon"])]),_:1}),a(we,{data:o(c),loading:o(_),total:o(f),"current-page":o(g),"onUpdate:currentPage":t[0]||(t[0]=e=>q(g)?g.value=e:null),"page-size":o(S),"onUpdate:pageSize":t[1]||(t[1]=e=>q(S)?S.value=e:null),onPageChange:o(w)},{default:s(()=>[a(m,{label:"订单号","min-width":"150"},{default:s(({row:e})=>[d("span",{class:"mono-text",onClick:j=>o(N)(e.order_no)},n(e.order_no),9,Ae)]),_:1}),a(m,{label:"用户","min-width":"140"},{default:s(({row:e})=>[d("div",Se,[a(W,{size:28,src:e._profile?.avatar||o(L)},null,8,["src"]),d("span",je,n(e._profile?.uid||"无UID"),1)])]),_:1}),a(m,{label:"商品","min-width":"200"},{default:s(({row:e})=>[d("div",Ve,[e.product_snapshot?.image?(r(),u("img",{key:0,src:e.product_snapshot.image,class:"product-thumb"},null,8,De)):A("",!0),d("span",null,n(e.product_snapshot?.product_name||"未知商品"),1)])]),_:1}),a(m,{label:"规格","min-width":"140"},{default:s(({row:e})=>[d("span",Te,n(o($)(e.sku_snapshot?.spec_combination)),1)]),_:1}),a(m,{label:"数量",width:"60",align:"center"},{default:s(({row:e})=>[d("span",null,n(e.quantity||1),1)]),_:1}),a(m,{label:"总支付",width:"90"},{default:s(({row:e})=>[d("span",Fe,n(o(B)(e.total_amount)),1)]),_:1}),a(m,{label:"优惠券",width:"80"},{default:s(({row:e})=>[e.coupon_snapshot?.discount_amount?(r(),u("span",Re," -"+n(o(B)(e.coupon_snapshot.discount_amount)),1)):(r(),u("span",ze,"-"))]),_:1}),a(m,{label:"状态",width:"90"},{default:s(({row:e})=>[a(P,{type:o(H)(e.status)||"info",size:"small"},{default:s(()=>[p(n(o(M)(e.status)),1)]),_:2},1032,["type"])]),_:1}),a(m,{label:"创建时间",width:"150"},{default:s(({row:e})=>[p(n(o(T)(e.created_at)),1)]),_:1}),a(m,{label:"到期时间",width:"150"},{default:s(({row:e})=>[p(n(o(T)(e.end_time||e.expires_at)),1)]),_:1}),a(m,{label:"操作",width:"120",fixed:"right",align:"center"},{default:s(({row:e})=>[a(y,{link:"",type:"primary",onClick:j=>G(e)},{default:s(()=>[p(n(e.status==="pending_delivery"?"审核回执":"查看回执"),1)]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","loading","total","current-page","page-size","onPageChange"]),a(ae,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=e=>E.value=e),title:"虚拟充值 - 回执审核",width:"600px","destroy-on-close":""},{footer:s(()=>[i.value?.status==="submitted"?(r(),u("div",Le,[C.value?(r(),u(V,{key:1},[a(y,{onClick:t[4]||(t[4]=e=>C.value=!1)},{default:s(()=>[...t[13]||(t[13]=[p("取消",-1)])]),_:1}),a(y,{type:"danger",onClick:Q,loading:h.value},{default:s(()=>[...t[14]||(t[14]=[p(" 确认驳回 ",-1)])]),_:1},8,["loading"])],64)):(r(),u(V,{key:0},[a(y,{onClick:t[3]||(t[3]=e=>C.value=!0)},{default:s(()=>[...t[11]||(t[11]=[p("驳回订单",-1)])]),_:1}),a(y,{type:"primary",onClick:K,loading:h.value,icon:o(me)},{default:s(()=>[...t[12]||(t[12]=[p(" 确认发货 (通过) ",-1)])]),_:1},8,["loading","icon"])],64))])):(r(),D(y,{key:1,onClick:t[5]||(t[5]=e=>E.value=!1)},{default:s(()=>[...t[15]||(t[15]=[p("关闭",-1)])]),_:1}))]),default:s(()=>[F.value?(r(),u("div",Ie,[a(Y,{class:"is-loading"},{default:s(()=>[a(o(ce))]),_:1}),t[8]||(t[8]=p(" 正在加载回执记录... ",-1))])):i.value?(r(),u(V,{key:1},[i.value.status==="submitted"?(r(),D(U,{key:0,title:"该订单等待发货审核",type:"warning","show-icon":"",closable:!1,class:"mb-4"})):A("",!0),i.value.status==="approved"?(r(),D(U,{key:1,title:"该订单已发货完成",type:"success","show-icon":"",closable:!1,class:"mb-4"})):A("",!0),a(Z,{title:"提交信息",column:1,border:"",class:"receipt-descriptions"},{default:s(()=>[a(R,{label:"提交时间"},{default:s(()=>[p(n(o(T)(i.value.submitted_at)),1)]),_:1}),a(R,{label:"当前状态"},{default:s(()=>[a(P,{type:X(i.value.status)},{default:s(()=>[p(n(J(i.value.status)),1)]),_:1},8,["type"])]),_:1}),(r(!0),u(V,null,de(i.value.payload,(e,j)=>(r(),D(R,{key:j,label:j,"label-class-name":"bold-label"},{default:s(()=>[d("span",Be,n(e),1)]),_:2},1032,["label"]))),128))]),_:1}),i.value.status==="rejected"?(r(),u("div",Oe,[t[9]||(t[9]=d("p",{class:"label"},"驳回原因：",-1)),d("p",Pe,n(i.value.reject_reason),1)])):A("",!0),C.value?(r(),u("div",Ue,[t[10]||(t[10]=d("p",{class:"input-label"},"请输入驳回原因通知用户：",-1)),a(ee,{modelValue:x.value,"onUpdate:modelValue":t[2]||(t[2]=e=>x.value=e),type:"textarea",rows:3,placeholder:"例如：账号密码错误，请重新提交..."},null,8,["modelValue"])])):A("",!0)],64)):(r(),u("div",qe,[a(te,{description:"用户尚未提交充值回执","image-size":80})]))]),_:1},8,["modelValue"])])}}}),ta=fe(Ne,[["__scopeId","data-v-aaf0e5e0"]]);export{ta as default};
