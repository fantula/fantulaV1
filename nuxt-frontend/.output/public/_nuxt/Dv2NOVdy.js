import{dM as I,f as ce,g as R,r as k,J as de,G,w as v,ca as ue,o as l,i as me,c as n,D as w,b as i,a as t,E as _e,t as c,d as T,l as F,aR as pe,F as U,k as Y,n as H,j as J,aG as Q,ag as ve,em as fe,B as V,K as ge,_ as he}from"./gYbOYKrZ.js";import{E as ye}from"./CswOF4xx.js";import{E as ke}from"./BxcDqkou.js";import{E as we}from"./DSGcGbHT.js";import{E as be}from"./BO6-pa8Z.js";import{E as xe}from"./CxsxdZaY.js";import{E as Ce}from"./DrogL690.js";import{E as De}from"./qZy57oqE.js";/* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        *//* empty css        */import{u as Te}from"./Ce6k4emn.js";import{v as Ee}from"./CUySdIcD.js";import{E as Me}from"./DK0lTgRd.js";const z={async getList(u){const d=I(),{page:a,pageSize:r,status:f}=u;let h=d.from("tickets").select("*, profiles(email), orders(id, order_no, product_snapshot, sku_snapshot, total_amount, quantity, status, created_at, end_time, expires_at)",{count:"exact"}).order("created_at",{ascending:!1}).range((a-1)*r,a*r-1);f&&f!=="all"&&(h=h.eq("status",f));const{data:b,error:_,count:m}=await h;return _?{success:!1,data:[],total:0,error:_.message}:{success:!0,data:b,total:m||0}},async getDetail(u){const d=I(),{data:a,error:r}=await d.from("tickets").select("*, profiles(email), orders(id, order_no, product_snapshot, sku_snapshot, total_amount, quantity, status, created_at, end_time, expires_at)").eq("id",u).single();return r?{success:!1,data:null,error:r.message}:{success:!0,data:a}},async getMessages(u){const d=I(),{data:a,error:r}=await d.from("ticket_messages").select("*, profiles(email)").eq("ticket_id",u).order("created_at",{ascending:!0});return r?{success:!1,data:[],error:r.message}:{success:!0,data:a}},async reply(u,d,a=[]){const r=I(),{error:f}=await r.from("ticket_messages").insert({ticket_id:u,sender_id:null,is_admin:!0,content:d,message_type:a.length>0?"image":"text",attachments:a});return f?{success:!1,error:f.message}:{success:!0}},async resolve(u){const d=I(),{error:a}=await d.from("tickets").update({status:"resolved",resolved_at:new Date,updated_at:new Date}).eq("id",u);return a?{success:!1,error:a.message}:{success:!0}},async cleanupImages(u=7){const d=I(),a=new Date;a.setDate(a.getDate()-u);const{data:r}=await d.from("tickets").select("id").eq("status","resolved").lt("resolved_at",a.toISOString());if(!r||r.length===0)return{success:!0,count:0};const f=r.map(m=>m.id),{data:h}=await d.from("ticket_messages").select("id, attachments").in("ticket_id",f).not("attachments","is",null);if(!h||h.length===0)return{success:!0,count:0};let b=0;const _=[];if(h.forEach(m=>{Array.isArray(m.attachments)&&m.attachments.forEach(p=>{try{const E=new URL(p).pathname.split("/tickets/");E.length>1&&_.push(decodeURIComponent(E[1]))}catch{_.push(p)}})}),_.length>0){const{data:m,error:p}=await d.storage.from("tickets").remove(_);if(p)return{success:!1,count:0,error:p.message};b=m?.length||0}return{success:!0,count:b}}},Ie={class:"modal-layout"},Ve={key:0,class:"flex flex-col items-center justify-center w-full h-full text-center"},Be={class:"text-gray-600 mb-4"},Se={class:"layout-sidebar"},Le={class:"info-block"},Fe={class:"value"},ze={class:"info-block"},je={class:"user-card"},qe={class:"user-details"},Ue={class:"uid"},Oe={key:0,class:"email"},Ae={key:0,class:"info-block"},Re={class:"order-card-large"},Ye=["src"],$e={class:"order-details-rows"},Ke={class:"detail-row"},Ne={class:"detail-row"},Pe=["title"],Ge={key:0,class:"detail-row"},He={class:"row-value spec-tag"},Je={class:"detail-row"},Qe={class:"row-value price"},We={key:1,class:"detail-row bg-blue-50 p-2 rounded mt-2 border border-blue-100"},Xe={class:"row-value font-bold text-blue-700"},Ze={class:"info-block"},et={class:"value text-gray-500 text-sm"},tt={class:"layout-main"},st={key:0,class:"empty-chat"},at={class:"date-divider"},ot={class:"message-content"},lt={class:"bubble"},rt={class:"meta"},nt={key:0,class:"attachments"},it={class:"chat-footer"},ct={key:0,class:"text-xs text-red-400 text-center mb-2"},dt={key:1,class:"action-area"},ut={class:"footer-buttons"},mt={key:2,class:"resolved-banner"},_t=ce({__name:"TicketChatModal",props:{modelValue:{type:Boolean},ticketId:{}},emits:["update:modelValue","closed"],setup(u,{emit:d}){const a=u,r=d,{getTicketStatusLabel:f,getTicketStatusType:h}=Te(),b=R({get:()=>a.modelValue,set:s=>r("update:modelValue",s)}),_=k(!1),m=k(!1),p=k(null),B=k(!1),E=k(!1),S=k([]),o=k(null),x=k(""),j=k(null),W=()=>{r("closed")},X=s=>{s&&(navigator.clipboard.writeText(s),V.success("已复制"))},$=R(()=>{if(!o.value?.orders)return null;const s=o.value.orders,e=s.expires_at||s.end_time;if(!e)return null;const C=new Date(e).getTime(),g=new Date().getTime(),D=C-g;if(D<=0)return"已过期";const q=Math.floor(D/(1e3*60*60*24)),L=Math.floor(D%(1e3*60*60*24)/(1e3*60*60));return q>0?`${q}天 ${L}小时`:`${L}小时`}),Z=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),ee=s=>{const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()},te=s=>{const e=new Date;return e.setDate(e.getDate()-1),s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()},se=R(()=>{const s={};return S.value.forEach(e=>{const C=new Date(e.created_at),g=ee(C)?"今天":te(C)?"昨天":C.toLocaleDateString();s[g]||(s[g]=[]),s[g].push(e)}),s}),K=()=>{ge(()=>{j.value&&(j.value.scrollTop=j.value.scrollHeight+200)})},O=async()=>{if(a.ticketId){_.value=!0,p.value=null;try{console.log("[TicketChatModal] Loading data for:",a.ticketId);const[s,e]=await Promise.all([z.getDetail(a.ticketId),z.getMessages(a.ticketId)]);if(s.success)o.value=s.data,m.value=!0;else throw new Error(s.error||"工单详情加载失败");e.success?(S.value=e.data,K()):console.warn("[TicketChatModal] Messages load warning:",e.error)}catch(s){console.error("[TicketChatModal] Load Failed:",s),p.value=s.message||"加载失败，请重试",m.value=!1}finally{_.value=!1}}},A=async()=>{if(x.value.trim()){B.value=!0;try{const s=await z.reply(a.ticketId,x.value);if(s.success){x.value="",V.success("发送成功");const e=await z.getMessages(a.ticketId);e.success&&(S.value=e.data,K())}else V.error(s.error||"发送失败")}catch{V.error("系统错误")}finally{B.value=!1}}},ae=async()=>{try{await Me.confirm("确定要将此工单标记为已解决吗？用户将无法再回复。","确认结单",{confirmButtonText:"确定结单",cancelButtonText:"取消",type:"warning"}),E.value=!0,(await z.resolve(a.ticketId)).success?(V.success("工单已结单"),await O()):V.error("操作失败")}catch{}finally{E.value=!1}};return de(()=>a.modelValue,s=>{s&&a.ticketId&&(S.value=[],o.value=null,x.value="",p.value=null,m.value=!1,O())},{immediate:!0}),(s,e)=>{const C=ue("CircleCloseFilled"),g=_e,D=ye,q=ke,L=we,oe=be,le=xe,re=Ce,ne=De,ie=Ee;return l(),G(ne,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=M=>b.value=M),title:"工单详情与处理",width:"900px",class:"ticket-chat-modal",onClose:W,"close-on-click-modal":!1,"destroy-on-close":"","append-to-body":""},{default:v(()=>[me((l(),n("div",Ie,[p.value?(l(),n("div",Ve,[i(g,{class:"text-red-500 mb-2",size:40},{default:v(()=>[i(C)]),_:1}),t("div",Be,c(p.value),1),i(D,{type:"primary",onClick:O},{default:v(()=>[i(g,{class:"mr-1"},{default:v(()=>[i(F(pe))]),_:1}),e[3]||(e[3]=T(" 重试 ",-1))]),_:1})])):m.value?(l(),n(U,{key:1},[t("div",Se,[t("div",Le,[e[4]||(e[4]=t("div",{class:"label"},"工单状态",-1)),t("div",Fe,[i(q,{type:F(h)(o.value?.status),effect:"dark",size:"large"},{default:v(()=>[T(c(F(f)(o.value?.status)),1)]),_:1},8,["type"])])]),t("div",ze,[e[5]||(e[5]=t("div",{class:"label"},"提交用户",-1)),t("div",je,[i(L,{size:32,class:"user-avatar"},{default:v(()=>[T(c(o.value?.user_id?.substring(0,2).toUpperCase()),1)]),_:1}),t("div",qe,[t("div",Ue,"UID: "+c(o.value?.user_id?.substring(0,8).toUpperCase()),1),o.value?.profiles?.email?(l(),n("div",Oe,c(o.value.profiles.email),1)):w("",!0)])])]),o.value?.orders?(l(),n("div",Ae,[e[11]||(e[11]=t("div",{class:"label"},"关联订单快照",-1)),t("div",Re,[t("img",{src:o.value.orders.product_snapshot?.image,class:"order-img-large"},null,8,Ye),t("div",$e,[t("div",Ke,[e[6]||(e[6]=t("span",{class:"row-label"},"订单号",-1)),t("span",{class:"row-value font-mono copyable",onClick:e[0]||(e[0]=M=>X(o.value.orders.order_no))},c(o.value.orders.order_no),1)]),t("div",Ne,[e[7]||(e[7]=t("span",{class:"row-label"},"商品",-1)),t("span",{class:"row-value",title:o.value.orders.product_snapshot?.product_name},c(o.value.orders.product_snapshot?.product_name),9,Pe)]),o.value.orders.sku_snapshot?.spec_combination?(l(),n("div",Ge,[e[8]||(e[8]=t("span",{class:"row-label"},"规格",-1)),t("span",He,c(Object.values(o.value.orders.sku_snapshot.spec_combination).join(" / ")),1)])):w("",!0),t("div",Je,[e[9]||(e[9]=t("span",{class:"row-label"},"金额",-1)),t("span",Qe,"¥"+c(o.value.orders.total_amount?.toFixed(2)),1)]),$.value?(l(),n("div",We,[e[10]||(e[10]=t("span",{class:"row-label text-blue-600"},"剩余时间",-1)),t("span",Xe,c($.value),1)])):w("",!0)])])])):w("",!0),t("div",Ze,[e[12]||(e[12]=t("div",{class:"label"},"创建时间",-1)),t("div",et,c(o.value?new Date(o.value.created_at).toLocaleString():"-"),1)])]),t("div",tt,[t("div",{class:"chat-container custom-scrollbar",ref_key:"chatBox",ref:j},[S.value.length===0?(l(),n("div",st,[i(oe,{description:"暂无沟通记录","image-size":60})])):w("",!0),(l(!0),n(U,null,Y(se.value,(M,N)=>(l(),n("div",{key:N},[t("div",at,[t("span",null,c(N),1)]),(l(!0),n(U,null,Y(M,y=>(l(),n("div",{key:y.id,class:H(["message-row",{"is-admin":y.is_admin}])},[i(L,{size:32,class:H(y.is_admin?"avatar-admin":"avatar-user")},{default:v(()=>[T(c(y.is_admin?"服":"客"),1)]),_:2},1032,["class"]),t("div",ot,[t("div",lt,c(y.content),1),t("div",rt,[t("span",null,c(Z(y.created_at)),1)]),y.attachments?.length?(l(),n("div",nt,[(l(!0),n(U,null,Y(y.attachments,P=>(l(),G(le,{key:P,src:P,class:"attachment-img","preview-src-list":y.attachments,"preview-teleported":"",fit:"cover"},null,8,["src","preview-src-list"]))),128))])):w("",!0)])],2))),128))]))),128))],512),t("div",it,[o.value?.status!=="processing"&&o.value?.status!=="resolved"?(l(),n("div",ct," 当前状态异常: "+c(o.value?.status),1)):w("",!0),o.value?.status==="processing"?(l(),n("div",dt,[i(re,{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=M=>x.value=M),type:"textarea",rows:3,resize:"none",placeholder:"请输入回复内容 (Cmd/Ctrl + Enter 发送)",onKeydown:[J(Q(A,["meta"]),["enter"]),J(Q(A,["ctrl"]),["enter"])]},null,8,["modelValue","onKeydown"]),t("div",ut,[i(D,{type:"success",plain:"",onClick:ae,loading:E.value},{default:v(()=>[i(g,{class:"mr-1"},{default:v(()=>[i(F(ve))]),_:1}),e[13]||(e[13]=T(" 标记已解决 ",-1))]),_:1},8,["loading"]),i(D,{type:"primary",onClick:A,loading:B.value,disabled:!x.value.trim()},{default:v(()=>[...e[14]||(e[14]=[T(" 发送回复 ",-1)])]),_:1},8,["loading","disabled"])])])):o.value?.status==="resolved"?(l(),n("div",mt,[i(g,{class:"text-green-500 mr-2"},{default:v(()=>[i(F(fe))]),_:1}),e[15]||(e[15]=T(" 工单已结单，无法继续回复 ",-1))])):w("",!0)])])],64)):w("",!0)])),[[ie,_.value]])]),_:1},8,["modelValue"])}}}),pt=he(_t,[["__scopeId","data-v-96458b2d"]]),zt=Object.freeze(Object.defineProperty({__proto__:null,default:pt},Symbol.toStringTag,{value:"Module"}));export{pt as T,z as a,zt as b};
